<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ZeitManager.ViewModels"
             xmlns:models="using:ZeitManager.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:controls="using:MeineApps.UI.Controls"
             xmlns:skiaControls="using:MeineApps.UI.SkiaSharp"
             xmlns:behaviors="using:MeineApps.UI.Behaviors"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             x:Class="ZeitManager.Views.TimerView"
             x:DataType="vm:TimerViewModel">

  <UserControl.Styles>
    <!-- Pulsier-Animation für laufende Timer -->
    <Style Selector="Border.TimerRunningPulse">
      <Style.Animations>
        <Animation Duration="0:0:2" IterationCount="INFINITE">
          <KeyFrame Cue="0%"><Setter Property="Opacity" Value="1" /></KeyFrame>
          <KeyFrame Cue="50%"><Setter Property="Opacity" Value="0.6" /></KeyFrame>
          <KeyFrame Cue="100%"><Setter Property="Opacity" Value="1" /></KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,Auto,*">

    <!-- Quick Timer Chips -->
    <Border Grid.Row="0" Margin="16,16,16,8" Padding="12"
            Background="{DynamicResource SurfaceBrush}" CornerRadius="12">
      <StackPanel Spacing="10">
        <StackPanel Orientation="Horizontal" Spacing="6">
          <mi:MaterialIcon Kind="TimerSand" Width="16" Height="16"
                           Foreground="{DynamicResource TimerAccentBrush}" />
          <TextBlock Text="{Binding QuickTimerText}" Classes="TitleSmall"
                     Foreground="{DynamicResource TimerAccentBrush}" />
        </StackPanel>
        <WrapPanel Orientation="Horizontal">
          <!-- 1 min - Blitz -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="1">
            <i:Interaction.Behaviors>
              <behaviors:TapScaleBehavior PressedScale="0.92" />
            </i:Interaction.Behaviors>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="FlashOutline" Width="16" Height="16" />
              <TextBlock Text="1 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 5 min - Kaffee -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="5">
            <i:Interaction.Behaviors>
              <behaviors:TapScaleBehavior PressedScale="0.92" />
            </i:Interaction.Behaviors>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="CoffeeOutline" Width="16" Height="16" />
              <TextBlock Text="5 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 10 min - Sanduhr -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="10">
            <i:Interaction.Behaviors>
              <behaviors:TapScaleBehavior PressedScale="0.92" />
            </i:Interaction.Behaviors>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="TimerSand" Width="16" Height="16" />
              <TextBlock Text="10 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 15 min - Pause -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="15">
            <i:Interaction.Behaviors>
              <behaviors:TapScaleBehavior PressedScale="0.92" />
            </i:Interaction.Behaviors>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="FoodAppleOutline" Width="16" Height="16" />
              <TextBlock Text="15 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 30 min - Workout -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="30">
            <i:Interaction.Behaviors>
              <behaviors:TapScaleBehavior PressedScale="0.92" />
            </i:Interaction.Behaviors>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="WeightLifter" Width="16" Height="16" />
              <TextBlock Text="30 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
        </WrapPanel>
      </StackPanel>
    </Border>

    <!-- Presets -->
    <Border Grid.Row="1" Margin="16,0,16,8" Padding="12"
            Background="{DynamicResource SurfaceBrush}" CornerRadius="12"
            IsVisible="{Binding Presets.Count}">
      <StackPanel Spacing="8">
        <TextBlock Text="{Binding PresetsText}" Classes="TitleSmall"
                   Foreground="{DynamicResource TextMutedBrush}" />
        <ItemsControl ItemsSource="{Binding Presets}">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <WrapPanel Orientation="Horizontal" />
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:TimerPreset">
              <Border Margin="0,0,8,8" Padding="8,4" CornerRadius="14"
                      Background="{DynamicResource CardBrush}"
                      BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <Button Classes="Text" Padding="0" MinWidth="0" MinHeight="0"
                          Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).StartFromPresetCommand}"
                          CommandParameter="{Binding}">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="{Binding Name}" FontSize="12" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TimerAccentBrush}" VerticalAlignment="Center" />
                      <TextBlock Text="{Binding DurationFormatted}" FontSize="11"
                                 Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center" />
                    </StackPanel>
                  </Button>
                  <Button Classes="Text" Padding="0" MinWidth="0" MinHeight="20"
                          Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).DeletePresetCommand}"
                          CommandParameter="{Binding}">
                    <mi:MaterialIcon Kind="Close" Width="12" Height="12"
                                     Foreground="{DynamicResource TextMutedBrush}" />
                  </Button>
                </StackPanel>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </StackPanel>
    </Border>

    <!-- Timer List / Empty State -->
    <Panel Grid.Row="2">

      <!-- Empty State -->
      <controls:EmptyStateView IsVisible="{Binding !HasTimers}"
          Icon="TimerSandEmpty" Title="{Binding NoTimersText}"
          Subtitle="{Binding TimerEmptyHintText}"
          ActionText="{Binding CreateTimerButtonText}"
          ActionCommand="{Binding ShowCreateTimerCommand}" />

      <!-- Timer List -->
      <ScrollViewer IsVisible="{Binding HasTimers}">
        <ItemsControl ItemsSource="{Binding Timers}" Margin="16,0">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:TimerItem">
              <Border Classes="Card Interactive" Margin="0,0,0,8" Padding="12">
                <i:Interaction.Behaviors>
                  <behaviors:StaggerFadeInBehavior StaggerDelay="50" BaseDuration="300" />
                </i:Interaction.Behaviors>
                <Grid ColumnDefinitions="Auto,*,Auto">

                  <!-- SkiaSharp Fortschrittsring mit Glow -->
                  <Panel Grid.Column="0" Margin="0,0,16,0" VerticalAlignment="Center">
                    <skiaControls:SkiaGradientRing Width="64" Height="64"
                        Value="{Binding ProgressFraction}"
                        StrokeWidth="5"
                        StartColor="{Binding ProgressRingColor}"
                        EndColor="{Binding ProgressRingColor}"
                        GlowEnabled="{Binding IsRunning}"
                        IsPulsing="{Binding IsRunning}" />
                    <!-- Fertiges Häkchen -->
                    <mi:MaterialIcon Kind="Check" Width="24" Height="24"
                                     IsVisible="{Binding IsFinished}"
                                     Foreground="{DynamicResource SuccessBrush}"
                                     HorizontalAlignment="Center" VerticalAlignment="Center" />
                    <!-- Pause-Icon -->
                    <mi:MaterialIcon Kind="Pause" Width="20" Height="20"
                                     IsVisible="{Binding IsPaused}"
                                     Foreground="{DynamicResource TextMutedBrush}"
                                     HorizontalAlignment="Center" VerticalAlignment="Center" />
                  </Panel>

                  <!-- Timer Info -->
                  <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="{Binding Name}" Classes="TitleSmall"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
                      <mi:MaterialIcon Kind="Repeat" Width="14" Height="14"
                                       Foreground="{DynamicResource TimerAccentBrush}"
                                       IsVisible="{Binding AutoRepeat}"
                                       VerticalAlignment="Center" />
                    </StackPanel>
                    <TextBlock Text="{Binding RemainingTimeFormatted}"
                               FontSize="28" FontWeight="Light"
                               Foreground="{DynamicResource TextPrimaryBrush}" />
                  </StackPanel>

                  <!-- Steuerungs-Buttons -->
                  <StackPanel Grid.Column="2" VerticalAlignment="Center" Spacing="2">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <!-- Start -->
                      <Button Classes="Icon" MinWidth="44" MinHeight="44"
                              IsVisible="{Binding IsNotRunning}"
                              Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).StartTimerCommand}"
                              CommandParameter="{Binding}">
                        <mi:MaterialIcon Kind="Play" Width="22" Height="22"
                                         Foreground="{DynamicResource TimerAccentBrush}" />
                      </Button>
                      <!-- Pause -->
                      <Button Classes="Icon" MinWidth="44" MinHeight="44"
                              IsVisible="{Binding IsRunning}"
                              Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).PauseTimerCommand}"
                              CommandParameter="{Binding}">
                        <mi:MaterialIcon Kind="Pause" Width="22" Height="22"
                                         Foreground="{DynamicResource TimerAccentBrush}" />
                      </Button>
                      <!-- Stop -->
                      <Button Classes="Icon" MinWidth="44" MinHeight="44"
                              Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).StopTimerCommand}"
                              CommandParameter="{Binding}">
                        <mi:MaterialIcon Kind="Stop" Width="20" Height="20"
                                         Foreground="{DynamicResource TextMutedBrush}" />
                      </Button>
                      <!-- Delete -->
                      <Button Classes="Icon" MinWidth="44" MinHeight="44"
                              Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).DeleteTimerCommand}"
                              CommandParameter="{Binding}">
                        <mi:MaterialIcon Kind="Delete" Width="18" Height="18"
                                         Foreground="{DynamicResource ErrorBrush}" />
                      </Button>
                    </StackPanel>
                    <!-- +1 / +5 Min Buttons (nur bei laufendem/pausiertem Timer) -->
                    <StackPanel Orientation="Horizontal" Spacing="4"
                                IsVisible="{Binding IsNotFinished}"
                                HorizontalAlignment="Right">
                      <Button Padding="6,2" CornerRadius="10" MinWidth="0" MinHeight="0"
                              Background="{DynamicResource CardBrush}"
                              BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1"
                              Foreground="{DynamicResource TimerAccentBrush}"
                              Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).ExtendTimer1Command}"
                              CommandParameter="{Binding}">
                        <TextBlock Text="+1m" FontSize="11" FontWeight="SemiBold" />
                      </Button>
                      <Button Padding="6,2" CornerRadius="10" MinWidth="0" MinHeight="0"
                              Background="{DynamicResource CardBrush}"
                              BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1"
                              Foreground="{DynamicResource TimerAccentBrush}"
                              Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).ExtendTimer5Command}"
                              CommandParameter="{Binding}">
                        <TextBlock Text="+5m" FontSize="11" FontWeight="SemiBold" />
                      </Button>
                    </StackPanel>
                  </StackPanel>

                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>

      <!-- Untere Buttons -->
      <StackPanel HorizontalAlignment="Right" VerticalAlignment="Bottom"
                  Margin="0,0,24,24" Spacing="12">
        <!-- Alle löschen -->
        <Button Command="{Binding DeleteAllTimersCommand}"
                IsVisible="{Binding HasTimers}"
                HorizontalAlignment="Right"
                Width="44" Height="44" CornerRadius="22" Padding="0"
                Background="{DynamicResource SurfaceBrush}">
          <mi:MaterialIcon Kind="DeleteSweep" Width="22" Height="22"
                           Foreground="{DynamicResource ErrorBrush}" />
        </Button>
        <!-- FAB: Create Timer -->
        <Button Command="{Binding ShowCreateTimerCommand}"
                HorizontalAlignment="Right"
                Width="56" Height="56" CornerRadius="28" Padding="0"
                Background="{DynamicResource TimerAccentBrush}"
                Foreground="White">
          <mi:MaterialIcon Kind="Plus" Width="28" Height="28" />
        </Button>
      </StackPanel>

    </Panel>

    <!-- Create Timer Dialog Overlay (Bottom-Sheet) -->
    <Border Grid.Row="0" Grid.RowSpan="3"
            IsVisible="{Binding IsCreatingTimer}"
            Background="#AA000000">
      <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
              Background="{DynamicResource CardBrush}"
              CornerRadius="20,20,0,0" Padding="24,16,24,32"
              MaxWidth="500" BoxShadow="0 -4 16 0 #40000000">
        <StackPanel Spacing="16">
          <!-- Drag Handle -->
          <Border Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  HorizontalAlignment="Center" Margin="0,0,0,8" />
          <TextBlock Text="{Binding NewTimerTitleText}" Classes="HeadlineMedium" />

          <TextBox Text="{Binding NewTimerName, Mode=TwoWay}"
                   Watermark="{Binding $parent[UserControl].((vm:TimerViewModel)DataContext).CreateTimerText}" />

          <!-- Time Pickers (Drum Wheel) -->
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4">
            <StackPanel Spacing="2">
              <controls:WheelPicker Value="{Binding NewTimerHours}" Minimum="0" Maximum="23" FormatString="D2" />
              <TextBlock Text="{Binding $parent[UserControl].((vm:TimerViewModel)DataContext).HoursText, FallbackValue='h'}"
                         Classes="Caption" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" />
            </StackPanel>
            <TextBlock Text=":" FontSize="28" FontWeight="Medium" VerticalAlignment="Center"
                       Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16" />
            <StackPanel Spacing="2">
              <controls:WheelPicker Value="{Binding NewTimerMinutes}" Minimum="0" Maximum="59" FormatString="D2" />
              <TextBlock Text="min" Classes="Caption" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" />
            </StackPanel>
            <TextBlock Text=":" FontSize="28" FontWeight="Medium" VerticalAlignment="Center"
                       Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16" />
            <StackPanel Spacing="2">
              <controls:WheelPicker Value="{Binding NewTimerSeconds}" Minimum="0" Maximum="59" FormatString="D2" />
              <TextBlock Text="s" Classes="Caption" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" />
            </StackPanel>
          </StackPanel>

          <!-- Auto-Repeat Toggle -->
          <Grid ColumnDefinitions="*,Auto">
            <TextBlock Grid.Column="0" Text="{Binding AutoRepeatText}" Classes="BodyMedium"
                       VerticalAlignment="Center" />
            <ToggleSwitch Grid.Column="1" IsChecked="{Binding NewTimerAutoRepeat, Mode=TwoWay}"
                          OnContent="" OffContent="" />
          </Grid>

          <!-- Dialog Buttons -->
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding SaveAsPresetText}"
                    Command="{Binding SaveAsPresetCommand}" />
            <Button Classes="Text" Content="{Binding CancelText}"
                    Command="{Binding HideCreateTimerCommand}" />
            <Button Classes="Primary" Content="{Binding CreateText}"
                    Command="{Binding CreateTimerCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Delete Confirmation Overlay (Bottom-Sheet) -->
    <Border Grid.Row="0" Grid.RowSpan="3"
            IsVisible="{Binding IsDeleteConfirmVisible}"
            Background="#AA000000">
      <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
              Background="{DynamicResource CardBrush}"
              CornerRadius="20,20,0,0" Padding="24,16,24,32"
              MaxWidth="500" BoxShadow="0 -4 16 0 #40000000">
        <StackPanel Spacing="16">
          <!-- Drag Handle -->
          <Border Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  HorizontalAlignment="Center" Margin="0,0,0,8" />
          <TextBlock Text="{Binding ConfirmDeleteTitleText}" Classes="TitleLarge" />
          <TextBlock Text="{Binding ConfirmDeleteMessageText}" Classes="BodyMedium"
                     TextWrapping="Wrap" />
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding NoText}"
                    Command="{Binding CancelDeleteTimerCommand}" />
            <Button Classes="Primary" Content="{Binding YesText}"
                    Command="{Binding ConfirmDeleteTimerCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Delete All Confirmation Overlay (Bottom-Sheet) -->
    <Border Grid.Row="0" Grid.RowSpan="3"
            IsVisible="{Binding IsDeleteAllConfirmVisible}"
            Background="#AA000000">
      <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
              Background="{DynamicResource CardBrush}"
              CornerRadius="20,20,0,0" Padding="24,16,24,32"
              MaxWidth="500" BoxShadow="0 -4 16 0 #40000000">
        <StackPanel Spacing="16">
          <!-- Drag Handle -->
          <Border Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  HorizontalAlignment="Center" Margin="0,0,0,8" />
          <TextBlock Text="{Binding DeleteAllText}" Classes="TitleLarge" />
          <TextBlock Text="{Binding ConfirmDeleteAllMessageText}" Classes="BodyMedium"
                     TextWrapping="Wrap" />
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding NoText}"
                    Command="{Binding CancelDeleteAllTimersCommand}" />
            <Button Classes="Primary" Content="{Binding YesText}"
                    Command="{Binding ConfirmDeleteAllTimersCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
