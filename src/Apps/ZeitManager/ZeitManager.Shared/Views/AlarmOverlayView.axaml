<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ZeitManager.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             x:Class="ZeitManager.Views.AlarmOverlayView"
             x:DataType="vm:AlarmOverlayViewModel">

  <UserControl.Styles>
    <!-- Pulsier-Animation fuer den Icon-Kreis (NUR Opacity - ScaleTransform ist in KeyFrames NICHT unterstuetzt) -->
    <Style Selector="Border.PulseCircle">
      <Style.Animations>
        <Animation Duration="0:0:1.5" IterationCount="INFINITE"
                   PlaybackDirection="Alternate" Easing="CubicEaseInOut">
          <KeyFrame Cue="0%">
            <Setter Property="Opacity" Value="0.75" />
          </KeyFrame>
          <KeyFrame Cue="100%">
            <Setter Property="Opacity" Value="1.0" />
          </KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>
  </UserControl.Styles>

  <!-- Fullscreen dark overlay -->
  <Border Background="#E0000000">
    <Grid RowDefinitions="*,Auto,Auto,Auto,Auto,Auto,*" Margin="32">

      <!-- Icon circle with pulse -->
      <Border Grid.Row="1" Classes="PulseCircle"
              AutomationProperties.AutomationId="AlarmOverlay_IconCircle"
              Width="140" Height="140" CornerRadius="70"
              Background="{DynamicResource PrimaryBrush}"
              HorizontalAlignment="Center" Margin="0,0,0,24">
        <Panel>
          <mi:MaterialIcon Kind="TimerSand" Width="64" Height="64"
                           Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsVisible="{Binding IsTimerSource}" />
          <mi:MaterialIcon Kind="Alarm" Width="64" Height="64"
                           Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsVisible="{Binding !IsTimerSource}" />
        </Panel>
      </Border>

      <!-- Title -->
      <StackPanel Grid.Row="2" Spacing="8" HorizontalAlignment="Center" Margin="0,0,0,16">
        <TextBlock Text="{Binding Title}" Classes="HeadlineLarge"
                   AutomationProperties.AutomationId="AlarmOverlay_Title"
                   Foreground="White" HorizontalAlignment="Center"
                   TextAlignment="Center" TextWrapping="Wrap" />
        <TextBlock Text="{Binding Subtitle}" Classes="TitleMedium"
                   AutomationProperties.AutomationId="AlarmOverlay_Subtitle"
                   Foreground="#B0FFFFFF" HorizontalAlignment="Center"
                   TextAlignment="Center" />
      </StackPanel>

      <!-- Current time display -->
      <TextBlock Grid.Row="3" Text="{Binding CurrentTime}"
                 AutomationProperties.AutomationId="AlarmOverlay_CurrentTime"
                 FontSize="64" FontWeight="Light" Foreground="White"
                 HorizontalAlignment="Center" Margin="0,0,0,48" />

      <!-- Challenge-Bereich (nur bei aktiver Math-Challenge) -->
      <Border Grid.Row="4" IsVisible="{Binding IsMathChallenge}"
              Background="#30FFFFFF" CornerRadius="16" Padding="20" Margin="0,0,0,16"
              HorizontalAlignment="Center" MaxWidth="340">
        <StackPanel Spacing="12">
          <TextBlock Text="{Binding ChallengeInstructionText}" FontSize="14"
                     Foreground="#D0FFFFFF" HorizontalAlignment="Center" TextAlignment="Center" />
          <TextBlock Text="{Binding ChallengeQuestion}" FontSize="28" FontWeight="Bold"
                     AutomationProperties.AutomationId="AlarmOverlay_MathQuestion"
                     Foreground="White" HorizontalAlignment="Center" />
          <TextBox Text="{Binding ChallengeAnswer, Mode=TwoWay}"
                   AutomationProperties.AutomationId="AlarmOverlay_MathAnswerInput"
                   Watermark="{Binding ChallengeAnswerHintText}"
                   HorizontalAlignment="Stretch" FontSize="20"
                   HorizontalContentAlignment="Center" />
          <Button Classes="Primary" Content="{Binding ChallengeSubmitText}"
                  AutomationProperties.AutomationId="AlarmOverlay_MathSubmitButton"
                  HorizontalAlignment="Center" MinWidth="160" Height="44" CornerRadius="22"
                  HorizontalContentAlignment="Center"
                  IsVisible="{Binding !ChallengeSolved}"
                  Command="{Binding SubmitChallengeCommand}" />
          <TextBlock Text="{Binding ChallengeFeedback}" FontSize="14"
                     AutomationProperties.AutomationId="AlarmOverlay_MathFeedback"
                     Foreground="#F0FFFFFF" HorizontalAlignment="Center"
                     TextAlignment="Center" TextWrapping="Wrap" />
        </StackPanel>
      </Border>

      <!-- Shake-Challenge-Bereich -->
      <Border Grid.Row="4" IsVisible="{Binding IsShakeChallenge}"
              Background="#30FFFFFF" CornerRadius="16" Padding="20" Margin="0,0,0,16"
              HorizontalAlignment="Center" MaxWidth="340">
        <StackPanel Spacing="12">
          <TextBlock Text="{Binding ShakeInstructionText}" FontSize="14"
                     AutomationProperties.AutomationId="AlarmOverlay_ShakeInstruction"
                     Foreground="#D0FFFFFF" HorizontalAlignment="Center" TextAlignment="Center" />
          <!-- Fortschritt X/Y -->
          <TextBlock AutomationProperties.AutomationId="AlarmOverlay_ShakeProgress"
                     HorizontalAlignment="Center" FontSize="28" FontWeight="Bold" Foreground="White">
            <TextBlock.Text>
              <MultiBinding StringFormat="{}{0} / {1}">
                <Binding Path="ShakeProgress" />
                <Binding Path="ShakeTarget" />
              </MultiBinding>
            </TextBlock.Text>
          </TextBlock>
          <!-- ProgressBar -->
          <ProgressBar Minimum="0" Maximum="1" Value="{Binding ShakeProgressFraction}"
                       AutomationProperties.AutomationId="AlarmOverlay_ShakeProgressBar"
                       Height="8" CornerRadius="4"
                       Foreground="{DynamicResource PrimaryBrush}" />
          <!-- Desktop-Fallback-Button (nur wenn kein physischer Sensor) -->
          <Button Classes="Outlined" Content="{Binding SimulateShakeText}"
                  AutomationProperties.AutomationId="AlarmOverlay_SimulateShakeButton"
                  HorizontalAlignment="Center" MinWidth="160" Height="44" CornerRadius="22"
                  HorizontalContentAlignment="Center"
                  IsVisible="{Binding !HasPhysicalSensor}"
                  Command="{Binding SimulateShakeCommand}" />
          <TextBlock Text="{Binding ChallengeFeedback}" FontSize="14"
                     AutomationProperties.AutomationId="AlarmOverlay_ShakeFeedback"
                     Foreground="#F0FFFFFF" HorizontalAlignment="Center"
                     TextAlignment="Center" TextWrapping="Wrap" />
        </StackPanel>
      </Border>

      <!-- Buttons -->
      <StackPanel Grid.Row="5" Spacing="16" HorizontalAlignment="Center">
        <!-- Dismiss button -->
        <Button Classes="Primary" MinWidth="220" Height="56" CornerRadius="28"
                AutomationProperties.AutomationId="AlarmOverlay_DismissButton"
                HorizontalContentAlignment="Center"
                IsEnabled="{Binding CanDismiss}"
                Command="{Binding DismissCommand}">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <mi:MaterialIcon Kind="Close" Width="24" Height="24" />
            <TextBlock Text="{Binding DismissText}" FontSize="18" FontWeight="Medium"
                       AutomationProperties.AutomationId="AlarmOverlay_DismissText"
                       VerticalAlignment="Center" />
          </StackPanel>
        </Button>

        <!-- Snooze button -->
        <Button Classes="Outlined" MinWidth="220" Height="48" CornerRadius="24"
                AutomationProperties.AutomationId="AlarmOverlay_SnoozeButton"
                HorizontalContentAlignment="Center"
                IsVisible="{Binding CanSnooze}"
                Command="{Binding SnoozeCommand}">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <mi:MaterialIcon Kind="AlarmSnooze" Width="20" Height="20"
                             Foreground="White" />
            <TextBlock FontSize="16" Foreground="White"
                       AutomationProperties.AutomationId="AlarmOverlay_SnoozeText"
                       VerticalAlignment="Center">
              <TextBlock.Text>
                <MultiBinding StringFormat="{}{0} ({1})">
                  <Binding Path="SnoozeLabel" />
                  <Binding Path="SnoozeText" />
                </MultiBinding>
              </TextBlock.Text>
            </TextBlock>
          </StackPanel>
        </Button>
      </StackPanel>

    </Grid>
  </Border>

</UserControl>
