<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ZeitManager.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:models="using:ZeitManager.Models"
             xmlns:views="using:ZeitManager.Views"
             xmlns:controls="using:MeineApps.UI.Controls"
             xmlns:behaviors="using:MeineApps.UI.Behaviors"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             x:Class="ZeitManager.Views.AlarmView"
             x:DataType="vm:AlarmViewModel">

  <UserControl.Styles>
    <!-- Weekday-Toggle: Normal -->
    <Style Selector="Button.WeekdayToggle">
      <Setter Property="Background" Value="{DynamicResource CardBrush}" />
      <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}" />
    </Style>
    <!-- Weekday-Toggle: Ausgewählt -->
    <Style Selector="Button.WeekdayToggle.Selected">
      <Setter Property="Background" Value="{DynamicResource AlarmAccentBrush}" />
      <Setter Property="Foreground" Value="White" />
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,*">

    <!-- Toggle Bar: Alarm | Shift Schedule -->
    <Border Grid.Row="0" Margin="16,16,16,8">
      <Grid ColumnDefinitions="*,*" Height="44">
        <Button Grid.Column="0" Classes="Primary" Content="{Binding TitleText}"
                IsVisible="{Binding !IsShiftScheduleMode}"
                HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                CornerRadius="8,0,0,8" Padding="8,4"
                Command="{Binding ToggleViewModeCommand}" />
        <Button Grid.Column="0" Classes="Outlined" Content="{Binding TitleText}"
                IsVisible="{Binding IsShiftScheduleMode}"
                HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                CornerRadius="8,0,0,8" Padding="8,4"
                Command="{Binding ToggleViewModeCommand}" />
        <Button Grid.Column="1" Classes="Primary" Content="{Binding ShiftText}"
                IsVisible="{Binding IsShiftScheduleMode}"
                HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                CornerRadius="0,8,8,0" Padding="8,4"
                Command="{Binding ToggleViewModeCommand}" />
        <Button Grid.Column="1" Classes="Outlined" Content="{Binding ShiftText}"
                IsVisible="{Binding !IsShiftScheduleMode}"
                HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                CornerRadius="0,8,8,0" Padding="8,4"
                Command="{Binding ToggleViewModeCommand}" />
      </Grid>
    </Border>

    <!-- Alarm Content -->
    <Panel Grid.Row="1" IsVisible="{Binding !IsShiftScheduleMode}">

      <!-- Urlaubsmodus Status-Banner -->
      <Border IsVisible="{Binding IsAllPaused}"
              Background="{DynamicResource WarningBackgroundBrush}"
              CornerRadius="8" Margin="16,0,16,8" Padding="12"
              VerticalAlignment="Top" ZIndex="1">
        <Grid ColumnDefinitions="Auto,*,Auto">
          <mi:MaterialIcon Grid.Column="0" Kind="Beach" Width="24" Height="24"
                           Foreground="{DynamicResource WarningBrush}" Margin="0,0,12,0"
                           VerticalAlignment="Center" />
          <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
            <TextBlock Text="{Binding VacationModeText}" Classes="TitleSmall" FontWeight="SemiBold" />
            <TextBlock Text="{Binding PausedUntilText}" FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}" />
          </StackPanel>
          <Button Grid.Column="2" Classes="Text" MinWidth="0" Padding="8,4"
                  Command="{Binding ResumeAllAlarmsCommand}">
            <TextBlock Text="{Binding ResumeAllAlarmsText}" FontSize="12"
                       Foreground="{DynamicResource PrimaryBrush}" />
          </Button>
        </Grid>
      </Border>

      <!-- Nächster-Alarm-Countdown-Banner -->
      <Border IsVisible="{Binding HasNextAlarm}"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="8" Margin="16,0,16,8" Padding="12"
              VerticalAlignment="Top">
        <Grid ColumnDefinitions="Auto,*">
          <mi:MaterialIcon Grid.Column="0" Kind="AlarmCheck" Width="22" Height="22"
                           Foreground="{DynamicResource AlarmAccentBrush}" Margin="0,0,12,0"
                           VerticalAlignment="Center" />
          <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
            <TextBlock Text="{Binding NextAlarmInText}" Classes="BodyMedium"
                       Foreground="{DynamicResource TextSecondaryBrush}" />
            <TextBlock Text="{Binding NextAlarmCountdown}" Classes="BodyMedium"
                       FontWeight="SemiBold"
                       Foreground="{DynamicResource AlarmAccentBrush}" />
          </StackPanel>
        </Grid>
      </Border>

      <!-- Empty State -->
      <controls:EmptyStateView IsVisible="{Binding !HasAlarms}"
          Icon="AlarmOff" Title="{Binding NoAlarmsText}"
          Subtitle="{Binding CreateAlarmText}"
          ActionText="{Binding NewAlarmButtonText}"
          ActionCommand="{Binding NewAlarmCommand}" />

      <!-- Alarm List -->
      <ScrollViewer IsVisible="{Binding HasAlarms}">
        <ItemsControl ItemsSource="{Binding Alarms}" Margin="16,0">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:AlarmItem">
              <Border Classes="Card Interactive" Margin="0,0,0,8" ClipToBounds="True">
                <i:Interaction.Behaviors>
                  <behaviors:StaggerFadeInBehavior StaggerDelay="50" BaseDuration="300" />
                </i:Interaction.Behaviors>
                <Panel>
                  <!-- Delete-Layer (rechts, dahinter) -->
                  <Border Background="#EF4444" HorizontalAlignment="Right" Width="80">
                    <Button Classes="Text" Padding="0" MinWidth="0" MinHeight="0"
                            HorizontalAlignment="Center" VerticalAlignment="Center"
                            Command="{Binding $parent[ItemsControl].((vm:AlarmViewModel)DataContext).SwipeDeleteAlarmCommand}"
                            CommandParameter="{Binding}">
                      <mi:MaterialIcon Kind="Delete" Foreground="White" Width="24" Height="24" />
                    </Button>
                  </Border>
                  <!-- Content-Layer (nach links verschiebbar) -->
                  <Border Background="{DynamicResource CardBrush}">
                    <i:Interaction.Behaviors>
                      <behaviors:SwipeToRevealBehavior SwipeThreshold="80" RevealWidth="80" />
                    </i:Interaction.Behaviors>
                    <Grid ColumnDefinitions="Auto,*,Auto,Auto" Margin="12">
                      <!-- Alarm Icon -->
                      <Panel Grid.Column="0" Margin="0,0,12,0" VerticalAlignment="Center">
                        <mi:MaterialIcon Kind="Alarm" Width="28" Height="28"
                                         Foreground="{DynamicResource AlarmAccentBrush}"
                                         IsVisible="{Binding IsEnabled}" />
                        <mi:MaterialIcon Kind="AlarmOff" Width="28" Height="28"
                                         Foreground="{DynamicResource TextMutedBrush}"
                                         IsVisible="{Binding !IsEnabled}" />
                      </Panel>

                      <!-- Alarm Info -->
                      <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                        <TextBlock Text="{Binding TimeFormatted}" FontSize="28" FontWeight="Light"
                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                        <TextBlock Text="{Binding Name}" FontSize="13"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   IsVisible="{Binding Name, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                        <TextBlock Text="{Binding RepeatDaysFormatted}" FontSize="12"
                                   Foreground="{DynamicResource AlarmAccentBrush}"
                                   IsVisible="{Binding RepeatDaysFormatted, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                      </StackPanel>

                      <!-- Toggle -->
                      <ToggleSwitch Grid.Column="2" IsChecked="{Binding IsEnabled}"
                                    OnContent="" OffContent=""
                                    VerticalAlignment="Center" Margin="8,0"
                                    Command="{Binding $parent[ItemsControl].((vm:AlarmViewModel)DataContext).ToggleAlarmCommand}"
                                    CommandParameter="{Binding}" />

                      <!-- Edit -->
                      <Button Grid.Column="3" Classes="Text" MinWidth="48" MinHeight="48" Padding="6"
                              Command="{Binding $parent[ItemsControl].((vm:AlarmViewModel)DataContext).EditAlarmCommand}"
                              CommandParameter="{Binding}">
                        <mi:MaterialIcon Kind="Pencil" Width="18" Height="18" />
                      </Button>
                    </Grid>
                  </Border>
                </Panel>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>

      <!-- Pause-Button (Urlaubsmodus) -->
      <Button Command="{Binding ShowPauseDialogCommand}"
              IsVisible="{Binding !IsAllPaused}"
              HorizontalAlignment="Right" VerticalAlignment="Bottom"
              Margin="0,0,24,88" Width="44" Height="44"
              CornerRadius="22" Padding="0"
              Background="{DynamicResource SurfaceBrush}">
        <mi:MaterialIcon Kind="Beach" Width="22" Height="22"
                         Foreground="{DynamicResource AlarmAccentBrush}" />
      </Button>

      <!-- FAB: New Alarm -->
      <Button Command="{Binding NewAlarmCommand}"
              IsVisible="{Binding !IsEditMode}"
              HorizontalAlignment="Right" VerticalAlignment="Bottom"
              Margin="0,0,24,24" Width="56" Height="56"
              CornerRadius="28" Padding="0"
              Background="{DynamicResource AlarmAccentBrush}"
              Foreground="White">
        <mi:MaterialIcon Kind="Plus" Width="28" Height="28" />
      </Button>

    </Panel>

    <!-- Shift Schedule View -->
    <Panel Grid.Row="1" IsVisible="{Binding IsShiftScheduleMode}">
      <views:ShiftScheduleView DataContext="{Binding ShiftScheduleViewModel}" />
    </Panel>

    <!-- Alarm Editor Overlay (Bottom-Sheet) -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            IsVisible="{Binding IsEditMode}"
            Background="#AA000000">
        <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
                Background="{DynamicResource CardBrush}"
                CornerRadius="20,20,0,0" Padding="24,16,24,32"
                MaxWidth="500" BoxShadow="0 -4 16 0 #40000000">
          <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="600">
          <StackPanel Spacing="16">
            <!-- Drag Handle -->
            <Border Width="40" Height="4" CornerRadius="2"
                    Background="{DynamicResource TextMutedBrush}"
                    HorizontalAlignment="Center" Margin="0,0,0,8" />

            <!-- Editor Title -->
            <TextBlock Text="{Binding NewAlarmText}" Classes="HeadlineMedium" />

            <!-- Time Picker (Drum Wheel) -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4">
              <StackPanel Spacing="2">
                <controls:WheelPicker Value="{Binding AlarmHour}" Minimum="0" Maximum="23" FormatString="D2" />
                <TextBlock Text="{Binding HoursShortText}" Classes="Caption" HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextMutedBrush}" />
              </StackPanel>
              <TextBlock Text=":" FontSize="28" FontWeight="Medium" VerticalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16" />
              <StackPanel Spacing="2">
                <controls:WheelPicker Value="{Binding AlarmMinute}" Minimum="0" Maximum="59" FormatString="D2" />
                <TextBlock Text="{Binding MinutesShortText}" Classes="Caption" HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextMutedBrush}" />
              </StackPanel>
            </StackPanel>

            <!-- Alarm Name -->
            <TextBox Text="{Binding AlarmName, Mode=TwoWay}"
                     Watermark="{Binding AlarmNamePlaceholderText}" />

            <!-- Weekday Toggles (runde Buttons) -->
            <StackPanel Spacing="8">
              <TextBlock Text="{Binding RepeatText}" Classes="TitleSmall"
                         Foreground="{DynamicResource TextMutedBrush}" />
              <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsMondaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Monday">
                  <TextBlock Text="{Binding MondayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsTuesdaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Tuesday">
                  <TextBlock Text="{Binding TuesdayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsWednesdaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Wednesday">
                  <TextBlock Text="{Binding WednesdayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsThursdaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Thursday">
                  <TextBlock Text="{Binding ThursdayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsFridaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Friday">
                  <TextBlock Text="{Binding FridayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsSaturdaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Saturday">
                  <TextBlock Text="{Binding SaturdayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
                <Button Classes="WeekdayToggle" Classes.Selected="{Binding IsSundaySelected}"
                        Width="36" Height="36" CornerRadius="18" Padding="0" MinWidth="0" MinHeight="0"
                        Command="{Binding ToggleDayCommand}" CommandParameter="Sunday">
                  <TextBlock Text="{Binding SundayShortText}" FontSize="11" FontWeight="SemiBold"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Button>
              </StackPanel>
            </StackPanel>

            <!-- Sound Selection -->
            <StackPanel Spacing="8">
              <TextBlock Text="{Binding AlarmSoundText}" Classes="TitleSmall"
                         Foreground="{DynamicResource TextMutedBrush}" />
              <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                <ComboBox Grid.Column="0" ItemsSource="{Binding AvailableSounds}"
                          SelectedValue="{Binding SelectedAlarmTone}"
                          SelectedValueBinding="{Binding Id}"
                          DisplayMemberBinding="{Binding Name}"
                          HorizontalAlignment="Stretch" />
                <Button Grid.Column="1" Classes="Outlined" MinWidth="48" MinHeight="48" Padding="8"
                        Command="{Binding PreviewSoundCommand}"
                        ToolTip.Tip="{Binding TestText}">
                  <mi:MaterialIcon Kind="Play" Width="20" Height="20" />
                </Button>
                <Button Grid.Column="2" Classes="Outlined" MinWidth="48" MinHeight="48" Padding="8"
                        Command="{Binding PickAlarmSoundCommand}"
                        ToolTip.Tip="{Binding PickFromDeviceText}">
                  <mi:MaterialIcon Kind="FolderMusic" Width="20" Height="20" />
                </Button>
              </Grid>
            </StackPanel>

            <!-- Vibrate Toggle -->
            <Grid ColumnDefinitions="Auto,*,Auto">
              <mi:MaterialIcon Grid.Column="0" Kind="Vibrate" Width="20" Height="20"
                               Foreground="{DynamicResource AlarmAccentBrush}"
                               VerticalAlignment="Center" Margin="0,0,8,0" />
              <TextBlock Grid.Column="1" Text="{Binding VibrateText}" Classes="BodyMedium"
                         VerticalAlignment="Center" />
              <ToggleSwitch Grid.Column="2" IsChecked="{Binding Vibrate, Mode=TwoWay}"
                            OnContent="" OffContent="" />
            </Grid>

            <!-- Dialog Buttons -->
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
              <Button Classes="Text" Content="{Binding CancelText}"
                      Command="{Binding CancelEditCommand}" />
              <Button Classes="Primary" Content="{Binding SaveText}"
                      Command="{Binding SaveAlarmCommand}" />
            </StackPanel>

          </StackPanel>
          </ScrollViewer>
        </Border>
    </Border>

    <!-- Delete Confirmation Overlay (Bottom-Sheet) -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            IsVisible="{Binding IsDeleteConfirmVisible}"
            Background="#AA000000">
      <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
              Background="{DynamicResource CardBrush}"
              CornerRadius="20,20,0,0" Padding="24,16,24,32"
              MaxWidth="500" BoxShadow="0 -4 16 0 #40000000">
        <StackPanel Spacing="16">
          <!-- Drag Handle -->
          <Border Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  HorizontalAlignment="Center" Margin="0,0,0,8" />
          <TextBlock Text="{Binding ConfirmDeleteTitleText}" Classes="TitleLarge" />
          <TextBlock Text="{Binding ConfirmDeleteMessageText}" Classes="BodyMedium"
                     TextWrapping="Wrap" />
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding NoText}"
                    Command="{Binding CancelDeleteAlarmCommand}" />
            <Button Classes="Primary" Content="{Binding YesText}"
                    Command="{Binding ConfirmDeleteAlarmCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Pause Dialog Overlay (Bottom-Sheet) -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            IsVisible="{Binding IsPauseDialogVisible}"
            Background="#AA000000">
      <Border VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
              Background="{DynamicResource CardBrush}"
              CornerRadius="20,20,0,0" Padding="24,16,24,32"
              MaxWidth="500" BoxShadow="0 -4 16 0 #40000000">
        <StackPanel Spacing="16">
          <!-- Drag Handle -->
          <Border Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  HorizontalAlignment="Center" Margin="0,0,0,8" />
          <StackPanel Orientation="Horizontal" Spacing="8">
            <mi:MaterialIcon Kind="Beach" Width="24" Height="24"
                             Foreground="{DynamicResource AlarmAccentBrush}" />
            <TextBlock Text="{Binding VacationModeText}" Classes="TitleLarge" />
          </StackPanel>
          <TextBlock Text="{Binding PauseDurationText}" Classes="BodyMedium"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
            <controls:WheelPicker Value="{Binding PauseDays}" Minimum="1" Maximum="30" />
            <TextBlock Text="{Binding DaysText}" Classes="TitleMedium" VerticalAlignment="Center" />
          </StackPanel>
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding CancelText}"
                    Command="{Binding CancelPauseDialogCommand}" />
            <Button Classes="Primary" Content="{Binding PauseAllAlarmsText}"
                    Command="{Binding PauseAllAlarmsCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
