<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FitnessRechner.ViewModels"
             xmlns:calcVm="using:FitnessRechner.ViewModels.Calculators"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:views="using:FitnessRechner.Views"
             xmlns:calcViews="using:FitnessRechner.Views.Calculators"
             xmlns:controls="using:MeineApps.UI.Controls"
             x:Class="FitnessRechner.Views.MainView"
             x:DataType="vm:MainViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <UserControl.Styles>
    <!-- Fade transition for tab content switching -->
    <Style Selector="Border.TabContent">
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.15" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.TabContent:not(.Active)">
      <Setter Property="Opacity" Value="0" />
      <Setter Property="IsHitTestVisible" Value="False" />
    </Style>
    <Style Selector="Border.TabContent.Active">
      <Setter Property="Opacity" Value="1" />
      <Setter Property="IsHitTestVisible" Value="True" />
    </Style>

    <!-- Calculator Slide-In Transition -->
    <Style Selector="Panel.CalculatorOverlay">
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut" />
          <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Panel.CalculatorOverlay.Open">
      <Setter Property="RenderTransform" Value="translate(0px, 0px)" />
      <Setter Property="Opacity" Value="1" />
    </Style>
    <Style Selector="Panel.CalculatorOverlay:not(.Open)">
      <Setter Property="RenderTransform" Value="translate(400px, 0px)" />
      <Setter Property="Opacity" Value="0" />
    </Style>
  </UserControl.Styles>

  <UserControl.DataTemplates>
    <DataTemplate DataType="calcVm:BmiViewModel">
      <calcViews:BmiView />
    </DataTemplate>
    <DataTemplate DataType="calcVm:CaloriesViewModel">
      <calcViews:CaloriesView />
    </DataTemplate>
    <DataTemplate DataType="calcVm:WaterViewModel">
      <calcViews:WaterView />
    </DataTemplate>
    <DataTemplate DataType="calcVm:IdealWeightViewModel">
      <calcViews:IdealWeightView />
    </DataTemplate>
    <DataTemplate DataType="calcVm:BodyFatViewModel">
      <calcViews:BodyFatView />
    </DataTemplate>
    <DataTemplate DataType="vm:BarcodeScannerViewModel">
      <views:BarcodeScannerView />
    </DataTemplate>
  </UserControl.DataTemplates>

  <Grid RowDefinitions="*,Auto,Auto">

    <!-- Content Area -->
    <Panel Grid.Row="0">
      <!-- Tab Pages -->
      <Border Classes="TabContent"
              Classes.Active="{Binding IsHomeActive}"
              IsVisible="{Binding !IsCalculatorOpen}">
        <views:HomeView DataContext="{Binding}" />
      </Border>
      <Border Classes="TabContent"
              Classes.Active="{Binding IsProgressActive}"
              IsVisible="{Binding !IsCalculatorOpen}">
        <views:ProgressView DataContext="{Binding ProgressViewModel}" />
      </Border>
      <Border Classes="TabContent"
              Classes.Active="{Binding IsFoodActive}"
              IsVisible="{Binding !IsCalculatorOpen}">
        <views:FoodSearchView DataContext="{Binding FoodSearchViewModel}" />
      </Border>
      <Border Classes="TabContent"
              Classes.Active="{Binding IsSettingsActive}"
              IsVisible="{Binding !IsCalculatorOpen}">
        <views:SettingsView DataContext="{Binding SettingsViewModel}" />
      </Border>

      <!-- Calculator Page Overlay (Slide-In von rechts) -->
      <Panel Classes="CalculatorOverlay"
             Classes.Open="{Binding IsCalculatorOpen}"
             IsVisible="{Binding IsCalculatorOpen}"
             Background="{DynamicResource BackgroundBrush}">
        <ContentControl Content="{Binding CurrentCalculatorVm}" />
      </Panel>

      <!-- Achievements Overlay (Fullscreen) -->
      <Panel Classes="CalculatorOverlay"
             Classes.Open="{Binding ShowAchievements}"
             IsVisible="{Binding ShowAchievements}"
             Background="{DynamicResource BackgroundBrush}">
        <views:AchievementsView DataContext="{Binding}" />
      </Panel>
    </Panel>

    <!-- Ad Banner Spacer (64dp fuer adaptive Banner) -->
    <Border Grid.Row="1" Height="64"
            IsVisible="{Binding IsAdBannerVisible}" />

    <!-- Bottom Navigation Bar -->
    <Border Grid.Row="2"
            Background="{DynamicResource SurfaceBrush}"
            BorderBrush="{DynamicResource BorderSubtleBrush}"
            BorderThickness="0,1,0,0">
      <Grid ColumnDefinitions="*,*,*,*" Margin="0,2">

        <!-- Home Tab -->
        <Button Grid.Column="0"
                Classes="Text"
                Command="{Binding SelectHomeTabCommand}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Padding="0"
                Height="56">
          <StackPanel Spacing="2">
            <Border Height="3" CornerRadius="2" Margin="12,0"
                    IsVisible="{Binding IsHomeActive}">
              <Border.Background>
                <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
              </Border.Background>
            </Border>
            <Border Height="3" IsVisible="{Binding !IsHomeActive}" />
            <Panel>
              <mi:MaterialIcon Kind="Home" Width="24" Height="24"
                               Foreground="{DynamicResource PrimaryBrush}"
                               IsVisible="{Binding IsHomeActive}" />
              <mi:MaterialIcon Kind="HomeOutline" Width="24" Height="24"
                               Foreground="{DynamicResource TextMutedBrush}"
                               IsVisible="{Binding !IsHomeActive}" />
            </Panel>
            <Panel>
              <TextBlock Text="{Binding NavHomeText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource PrimaryBrush}"
                         FontWeight="Medium"
                         IsVisible="{Binding IsHomeActive}" />
              <TextBlock Text="{Binding NavHomeText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}"
                         IsVisible="{Binding !IsHomeActive}" />
            </Panel>
          </StackPanel>
        </Button>

        <!-- Progress Tab -->
        <Button Grid.Column="1"
                Classes="Text"
                Command="{Binding SelectProgressTabCommand}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Padding="0"
                Height="56">
          <StackPanel Spacing="2">
            <Border Height="3" CornerRadius="2" Margin="12,0"
                    IsVisible="{Binding IsProgressActive}">
              <Border.Background>
                <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
              </Border.Background>
            </Border>
            <Border Height="3" IsVisible="{Binding !IsProgressActive}" />
            <Panel>
              <mi:MaterialIcon Kind="ChartLine" Width="24" Height="24"
                               Foreground="{DynamicResource PrimaryBrush}"
                               IsVisible="{Binding IsProgressActive}" />
              <mi:MaterialIcon Kind="ChartLineVariant" Width="24" Height="24"
                               Foreground="{DynamicResource TextMutedBrush}"
                               IsVisible="{Binding !IsProgressActive}" />
            </Panel>
            <Panel>
              <TextBlock Text="{Binding NavProgressText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource PrimaryBrush}"
                         FontWeight="Medium"
                         IsVisible="{Binding IsProgressActive}" />
              <TextBlock Text="{Binding NavProgressText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}"
                         IsVisible="{Binding !IsProgressActive}" />
            </Panel>
          </StackPanel>
        </Button>

        <!-- Food Tab -->
        <Button Grid.Column="2"
                Classes="Text"
                Command="{Binding SelectFoodTabCommand}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Padding="0"
                Height="56">
          <StackPanel Spacing="2">
            <Border Height="3" CornerRadius="2" Margin="12,0"
                    IsVisible="{Binding IsFoodActive}">
              <Border.Background>
                <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
              </Border.Background>
            </Border>
            <Border Height="3" IsVisible="{Binding !IsFoodActive}" />
            <Panel>
              <mi:MaterialIcon Kind="FoodApple" Width="24" Height="24"
                               Foreground="{DynamicResource PrimaryBrush}"
                               IsVisible="{Binding IsFoodActive}" />
              <mi:MaterialIcon Kind="FoodAppleOutline" Width="24" Height="24"
                               Foreground="{DynamicResource TextMutedBrush}"
                               IsVisible="{Binding !IsFoodActive}" />
            </Panel>
            <Panel>
              <TextBlock Text="{Binding NavFoodText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource PrimaryBrush}"
                         FontWeight="Medium"
                         IsVisible="{Binding IsFoodActive}" />
              <TextBlock Text="{Binding NavFoodText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}"
                         IsVisible="{Binding !IsFoodActive}" />
            </Panel>
          </StackPanel>
        </Button>

        <!-- Settings Tab -->
        <Button Grid.Column="3"
                Classes="Text"
                Command="{Binding SelectSettingsTabCommand}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                Padding="0"
                Height="56">
          <StackPanel Spacing="2">
            <Border Height="3" CornerRadius="2" Margin="12,0"
                    IsVisible="{Binding IsSettingsActive}">
              <Border.Background>
                <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
              </Border.Background>
            </Border>
            <Border Height="3" IsVisible="{Binding !IsSettingsActive}" />
            <Panel>
              <mi:MaterialIcon Kind="Cog" Width="24" Height="24"
                               Foreground="{DynamicResource PrimaryBrush}"
                               IsVisible="{Binding IsSettingsActive}" />
              <mi:MaterialIcon Kind="CogOutline" Width="24" Height="24"
                               Foreground="{DynamicResource TextMutedBrush}"
                               IsVisible="{Binding !IsSettingsActive}" />
            </Panel>
            <Panel>
              <TextBlock Text="{Binding NavSettingsText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource PrimaryBrush}"
                         FontWeight="Medium"
                         IsVisible="{Binding IsSettingsActive}" />
              <TextBlock Text="{Binding NavSettingsText}" FontSize="11"
                         HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}"
                         IsVisible="{Binding !IsSettingsActive}" />
            </Panel>
          </StackPanel>
        </Button>

      </Grid>
    </Border>

    <!-- Game Juice Overlays -->
    <controls:FloatingTextOverlay x:Name="FloatingTextCanvas"
                                   Grid.RowSpan="99"
                                   ZIndex="15"
                                   IsHitTestVisible="False" />
    <controls:CelebrationOverlay x:Name="CelebrationCanvas"
                                  Grid.RowSpan="99"
                                  ZIndex="16"
                                  IsHitTestVisible="False" />

  </Grid>

</UserControl>
