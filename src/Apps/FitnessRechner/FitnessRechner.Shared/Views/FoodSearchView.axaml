<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FitnessRechner.ViewModels"
             xmlns:models="using:FitnessRechner.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:conv="using:FitnessRechner.Converters"
             xmlns:behaviors="using:MeineApps.Core.Ava.Behaviors"
             xmlns:i="using:Avalonia.Xaml.Interactivity"
             xmlns:uiControls="using:MeineApps.UI.Controls"
             x:Class="FitnessRechner.Views.FoodSearchView"
             x:DataType="vm:FoodSearchViewModel">

  <UserControl.Resources>
    <conv:IsNotNullConverter x:Key="IsNotNullConverter" />
    <conv:BoolToStringConverter x:Key="FavoriteIconConverter"
                                TrueValue="StarFace"
                                FalseValue="StarOutline" />
    <conv:FoodCategoryToIconConverter x:Key="CategoryIconConverter" />
    <conv:FoodCategoryToColorConverter x:Key="CategoryColorConverter" />
  </UserControl.Resources>

  <Grid RowDefinitions="Auto,Auto,*,Auto,Auto"
        AutomationProperties.AutomationId="Food_RootPanel">

    <!-- ============================================ -->
    <!-- Row 0: Header with Title + Barcode Button    -->
    <!-- ============================================ -->
    <Border Grid.Row="0"
            AutomationProperties.AutomationId="Food_HeaderBorder"
            Background="{DynamicResource SurfaceBrush}"
            BorderThickness="0,0,0,1"
            BorderBrush="{DynamicResource BorderSubtleBrush}"
            Padding="16,12">
      <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
        <TextBlock AutomationProperties.AutomationId="Food_TxtTitle"
                   Text="{loc:Translate FoodSearch}"
                   FontSize="20" FontWeight="Bold"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   VerticalAlignment="Center" />
        <Button Grid.Column="1"
                AutomationProperties.AutomationId="Food_BtnQuickAdd"
                Classes="Small"
                Command="{Binding OpenQuickAddCommand}"
                ToolTip.Tip="{loc:Translate QuickAddCalories}">
          <StackPanel Orientation="Horizontal" Spacing="4">
            <mi:MaterialIcon Kind="LightningBolt" Width="18" Height="18" />
            <TextBlock Text="kcal" FontSize="12" VerticalAlignment="Center" />
          </StackPanel>
        </Button>
        <Button Grid.Column="2"
                AutomationProperties.AutomationId="Food_BtnBarcode"
                Classes="Primary Small"
                Command="{Binding OpenBarcodeScannerCommand}">
          <mi:MaterialIcon Kind="Barcode" Width="20" Height="20" />
        </Button>
      </Grid>
    </Border>

    <!-- ============================================ -->
    <!-- Row 1: Search Bar                            -->
    <!-- ============================================ -->
    <Border Grid.Row="1" Classes="Card StatsCard" Margin="16,12,16,0" Padding="12"
            AutomationProperties.AutomationId="Food_SearchBarBorder">
      <Grid ColumnDefinitions="Auto,*">
        <mi:MaterialIcon Kind="Magnify" Width="20" Height="20"
                         Foreground="{DynamicResource TextMutedBrush}"
                         VerticalAlignment="Center"
                         Margin="0,0,10,0" />
        <TextBox Grid.Column="1"
                 AutomationProperties.AutomationId="Food_TxtBoxSearch"
                 Text="{Binding SearchQuery}"
                 Watermark="{loc:Translate SearchFoodPlaceholder}"
                 Background="Transparent"
                 BorderThickness="0"
                 Height="NaN" />
      </Grid>
    </Border>

    <!-- ============================================ -->
    <!-- Row 2: Content Area (Scrollable)             -->
    <!-- ============================================ -->
    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto"
                  AutomationProperties.AutomationId="Food_ScrollViewer">
      <StackPanel Spacing="16" Margin="12,12,12,80">

        <!-- Favorites Section -->
        <StackPanel IsVisible="{Binding HasFavorites}" Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <mi:MaterialIcon Kind="Star" Width="16" Height="16"
                             Foreground="{DynamicResource WarningBrush}"
                             VerticalAlignment="Center" />
            <TextBlock AutomationProperties.AutomationId="Food_TxtFavoritesHeader"
                       Text="{loc:Translate Favorites}"
                       FontSize="16" FontWeight="SemiBold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       VerticalAlignment="Center" />
          </StackPanel>
          <ScrollViewer HorizontalScrollBarVisibility="Auto"
                        VerticalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding Favorites}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Orientation="Horizontal" Spacing="8" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:FavoriteFoodEntry">
                  <Button Classes="Text" Padding="0" Height="NaN"
                          Command="{Binding $parent[ItemsControl].((vm:FoodSearchViewModel)DataContext).SelectFavoriteCommand}"
                          CommandParameter="{Binding .}">
                    <i:Interaction.Behaviors>
                      <behaviors:TapScaleBehavior PressedScale="0.95" />
                    </i:Interaction.Behaviors>
                    <Border Classes="Card Compact Interactive" Padding="12,8" MinWidth="100"
                            Cursor="Hand">
                      <StackPanel Spacing="4">
                        <TextBlock Text="{Binding Food.Name}" FontSize="12" FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   TextTrimming="CharacterEllipsis" MaxWidth="120" />
                        <TextBlock Text="{Binding Food.CaloriesPer100g, StringFormat='{}{0:F0} kcal'}"
                                   FontSize="10" Foreground="{DynamicResource TextMutedBrush}" />
                      </StackPanel>
                    </Border>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </StackPanel>

        <!-- Recent Foods Chips -->
        <StackPanel IsVisible="{Binding HasRecentFoods}" Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <mi:MaterialIcon Kind="History" Width="16" Height="16"
                             Foreground="{DynamicResource TextMutedBrush}"
                             VerticalAlignment="Center" />
            <TextBlock AutomationProperties.AutomationId="Food_TxtRecentHeader"
                       Text="{loc:Translate RecentFoods}"
                       FontSize="14" FontWeight="SemiBold"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       VerticalAlignment="Center" />
          </StackPanel>
          <ScrollViewer HorizontalScrollBarVisibility="Auto"
                        VerticalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding RecentFoods}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Orientation="Horizontal" Spacing="8" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:FoodItem">
                  <Button Classes="Text" Padding="0" Height="NaN"
                          Command="{Binding $parent[ItemsControl].((vm:FoodSearchViewModel)DataContext).SelectRecentFoodCommand}"
                          CommandParameter="{Binding .}">
                    <Border CornerRadius="16" Padding="10,6" MinWidth="60"
                            Background="{DynamicResource SurfaceBrush}"
                            BorderBrush="{DynamicResource BorderSubtleBrush}"
                            BorderThickness="1"
                            Cursor="Hand">
                      <StackPanel Orientation="Horizontal" Spacing="6">
                        <!-- Kategorie-Farbpunkt -->
                        <Border Width="8" Height="8" CornerRadius="4"
                                Background="{Binding Category, Converter={StaticResource CategoryColorConverter}}" />
                        <TextBlock Text="{Binding Name}" FontSize="12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100" />
                      </StackPanel>
                    </Border>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </StackPanel>

        <!-- Quick-Add Panel -->
        <Border Classes="Card StatsCard" Padding="16"
                AutomationProperties.AutomationId="Food_CardQuickAdd"
                IsVisible="{Binding ShowQuickAddPanel}">
          <Border.Background>
            <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
              <GradientStop Color="#F59E0B" Offset="0" />
              <GradientStop Color="#D97706" Offset="1" />
            </LinearGradientBrush>
          </Border.Background>
          <StackPanel Spacing="12">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <mi:MaterialIcon Kind="LightningBolt" Width="20" Height="20" Foreground="White" />
              <TextBlock AutomationProperties.AutomationId="Food_TxtQuickAddTitle"
                         Text="{loc:Translate QuickAddCalories}"
                         FontSize="18" FontWeight="Bold" Foreground="White" />
            </StackPanel>
            <TextBlock Text="{loc:Translate QuickAddCaloriesHint}"
                       FontSize="12" Foreground="#CCFFFFFF" />
            <!-- Kalorien-Eingabe -->
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
              <NumericUpDown AutomationProperties.AutomationId="Food_NumQuickAddCalories"
                             Value="{Binding QuickAddCalories}"
                             Minimum="1" Maximum="10000"
                             Increment="50"
                             FormatString="F0"
                             Watermark="kcal"
                             HorizontalAlignment="Stretch" />
              <TextBlock Grid.Column="1" Text="kcal" Foreground="White"
                         VerticalAlignment="Center" FontSize="14" FontWeight="Bold" />
            </Grid>
            <!-- Beschreibung (optional) -->
            <TextBox AutomationProperties.AutomationId="Food_TxtBoxQuickAddName"
                     Text="{Binding QuickAddName}"
                     Watermark="{loc:Translate QuickAddFoodName}"
                     Background="Transparent"
                     Foreground="White"
                     BorderBrush="#66FFFFFF"
                     Height="NaN" />
            <!-- Mahlzeit-Auswahl -->
            <ComboBox AutomationProperties.AutomationId="Food_CmbQuickAddMeal"
                      ItemsSource="{Binding Meals}"
                      SelectedIndex="{Binding QuickAddMeal}"
                      HorizontalAlignment="Stretch" />
            <!-- Buttons -->
            <Grid ColumnDefinitions="*,8,*">
              <Button Grid.Column="0"
                      AutomationProperties.AutomationId="Food_BtnCancelQuickAdd"
                      Command="{Binding CancelQuickAddCommand}"
                      Background="Transparent"
                      Foreground="White"
                      BorderBrush="White"
                      BorderThickness="1"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Center">
                <TextBlock Text="{loc:Translate Cancel}" />
              </Button>
              <Button Grid.Column="2" Classes="Success"
                      AutomationProperties.AutomationId="Food_BtnConfirmQuickAdd"
                      Command="{Binding ConfirmQuickAddCommand}"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <mi:MaterialIcon Kind="Plus" Width="18" Height="18" />
                  <TextBlock Text="{loc:Translate Add}" VerticalAlignment="Center" />
                </StackPanel>
              </Button>
            </Grid>
          </StackPanel>
        </Border>

        <!-- Add Food Panel (when food is selected) -->
        <Border Classes="Card StatsCard" Padding="16"
                AutomationProperties.AutomationId="Food_CardAddFood"
                Background="{DynamicResource PrimaryBrush}"
                IsVisible="{Binding ShowAddPanel}">
          <StackPanel Spacing="12">

            <!-- Food Name + Favorite Toggle -->
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock AutomationProperties.AutomationId="Food_TxtSelectedFoodName"
                         Text="{Binding SelectedFood.Name}"
                         FontSize="20" FontWeight="Bold" Foreground="White"
                         TextWrapping="Wrap" />
              <Button Grid.Column="1" Classes="Icon"
                      AutomationProperties.AutomationId="Food_BtnToggleFavorite"
                      Command="{Binding ToggleFavoriteCommand}">
                <Panel>
                  <mi:MaterialIcon Kind="Star" Width="24" Height="24"
                                   Foreground="{DynamicResource WarningBrush}"
                                   IsVisible="{Binding IsSelectedFoodFavorite}" />
                  <mi:MaterialIcon Kind="StarOutline" Width="24" Height="24"
                                   Foreground="White"
                                   IsVisible="{Binding !IsSelectedFoodFavorite}" />
                </Panel>
              </Button>
            </Grid>

            <!-- Portion Input -->
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
              <NumericUpDown Grid.Column="0"
                             AutomationProperties.AutomationId="Food_NumPortionGrams"
                             Value="{Binding PortionGrams}"
                             Minimum="1" Maximum="10000"
                             Increment="10"
                             FormatString="F0"
                             Watermark="{loc:Translate AmountGrams}"
                             HorizontalAlignment="Stretch" />
              <TextBlock Grid.Column="1" Text="g" Foreground="White"
                         VerticalAlignment="Center" FontSize="14" />
              <Button Grid.Column="2"
                      AutomationProperties.AutomationId="Food_BtnDefaultPortion"
                      Command="{Binding UseDefaultPortionCommand}"
                      Background="Transparent"
                      Foreground="White"
                      BorderBrush="White"
                      BorderThickness="1"
                      Padding="8,0"
                      Height="{DynamicResource ButtonHeightSm}">
                <TextBlock Text="{Binding SelectedFood.DefaultPortion}" FontSize="12" />
              </Button>
            </Grid>

            <!-- Nutrition Preview -->
            <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="8">
              <StackPanel HorizontalAlignment="Center">
                <TextBlock AutomationProperties.AutomationId="Food_TxtCalcCalories"
                           Text="{Binding CalculatedCalories, StringFormat='{}{0:F0}'}"
                           FontSize="18" FontWeight="Bold" Foreground="White"
                           HorizontalAlignment="Center" />
                <TextBlock Text="kcal" FontSize="10" Foreground="White" Opacity="0.8"
                           HorizontalAlignment="Center" />
              </StackPanel>
              <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                <TextBlock AutomationProperties.AutomationId="Food_TxtCalcProtein"
                           Text="{Binding CalculatedProtein, StringFormat='{}{0:F1}g'}"
                           FontSize="14" Foreground="White"
                           HorizontalAlignment="Center" />
                <TextBlock Text="{loc:Translate Protein}" FontSize="10" Foreground="White" Opacity="0.8"
                           HorizontalAlignment="Center" />
              </StackPanel>
              <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                <TextBlock AutomationProperties.AutomationId="Food_TxtCalcCarbs"
                           Text="{Binding CalculatedCarbs, StringFormat='{}{0:F1}g'}"
                           FontSize="14" Foreground="White"
                           HorizontalAlignment="Center" />
                <TextBlock Text="{loc:Translate Carbs}" FontSize="10" Foreground="White" Opacity="0.8"
                           HorizontalAlignment="Center" />
              </StackPanel>
              <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                <TextBlock AutomationProperties.AutomationId="Food_TxtCalcFat"
                           Text="{Binding CalculatedFat, StringFormat='{}{0:F1}g'}"
                           FontSize="14" Foreground="White"
                           HorizontalAlignment="Center" />
                <TextBlock Text="{loc:Translate Fat}" FontSize="10" Foreground="White" Opacity="0.8"
                           HorizontalAlignment="Center" />
              </StackPanel>
            </Grid>

            <!-- Meal Selection -->
            <ComboBox AutomationProperties.AutomationId="Food_CmbMeal"
                      ItemsSource="{Binding Meals}"
                      SelectedIndex="{Binding SelectedMeal}"
                      HorizontalAlignment="Stretch" />

            <!-- Action Buttons -->
            <Grid ColumnDefinitions="*,8,*">
              <Button Grid.Column="0"
                      AutomationProperties.AutomationId="Food_BtnCancelAdd"
                      Command="{Binding CancelAddCommand}"
                      Background="Transparent"
                      Foreground="White"
                      BorderBrush="White"
                      BorderThickness="1"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Center">
                <TextBlock Text="{loc:Translate Cancel}" />
              </Button>
              <Button Grid.Column="2" Classes="Success"
                      AutomationProperties.AutomationId="Food_BtnAddToLog"
                      Command="{Binding AddToLogCommand}"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <mi:MaterialIcon Kind="Plus" Width="18" Height="18" />
                  <TextBlock Text="{loc:Translate Add}" VerticalAlignment="Center" />
                </StackPanel>
              </Button>
            </Grid>
          </StackPanel>
        </Border>

        <!-- Search Results -->
        <StackPanel IsVisible="{Binding HasResults}" Spacing="8">
          <TextBlock AutomationProperties.AutomationId="Food_TxtSearchResultsHeader"
                     Text="{loc:Translate SearchResults}"
                     FontSize="16" FontWeight="SemiBold"
                     Foreground="{DynamicResource TextPrimaryBrush}" />

          <ItemsControl ItemsSource="{Binding SearchResults}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="models:FoodSearchResult">
                <Border Classes="Card Interactive Compact" Margin="0,4" Padding="12"
                        Cursor="Hand">
                  <i:Interaction.Behaviors>
                    <behaviors:TapScaleBehavior PressedScale="0.95" />
                  </i:Interaction.Behaviors>
                  <Button Classes="Text" Padding="0" Height="NaN"
                          Command="{Binding $parent[ItemsControl].((vm:FoodSearchViewModel)DataContext).SelectFoodCommand}"
                          CommandParameter="{Binding .}"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Stretch">
                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                      <!-- Kategorie-Icon -->
                      <Border Grid.Column="0" Width="32" Height="32" CornerRadius="16"
                              Background="{Binding Food.Category, Converter={StaticResource CategoryColorConverter}}"
                              VerticalAlignment="Center">
                        <mi:MaterialIcon Width="16" Height="16" Foreground="White"
                                         Kind="{Binding Food.Category, Converter={StaticResource CategoryIconConverter}}"
                                         HorizontalAlignment="Center" VerticalAlignment="Center" />
                      </Border>
                      <StackPanel Grid.Column="1" Spacing="4">
                        <TextBlock Text="{Binding Food.Name}"
                                   FontSize="14" FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                        <TextBlock Text="{Binding Food.CaloriesPer100g, StringFormat='{}{0:F0} kcal / 100g'}"
                                   Classes="Caption" />
                        <StackPanel Orientation="Horizontal" Spacing="4">
                          <TextBlock Text="P:" FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                          <TextBlock Text="{Binding Food.ProteinPer100g, StringFormat='{}{0:F1}g'}"
                                     FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                          <TextBlock Text=" | C:" FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                          <TextBlock Text="{Binding Food.CarbsPer100g, StringFormat='{}{0:F1}g'}"
                                     FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                          <TextBlock Text=" | F:" FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                          <TextBlock Text="{Binding Food.FatPer100g, StringFormat='{}{0:F1}g'}"
                                     FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                        </StackPanel>
                      </StackPanel>
                      <mi:MaterialIcon Grid.Column="2" Kind="Plus" Width="24" Height="24"
                                       Foreground="{DynamicResource PrimaryBrush}"
                                       VerticalAlignment="Center" />
                    </Grid>
                  </Button>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Load More Button -->
          <Button AutomationProperties.AutomationId="Food_BtnLoadMore"
                  Classes="Outlined"
                  Command="{Binding LoadMoreResultsCommand}"
                  IsVisible="{Binding HasMoreResults}"
                  HorizontalAlignment="Center"
                  Margin="0,8,0,0">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="ChevronDown" Width="18" Height="18" />
              <TextBlock Text="{loc:Translate LoadMore}" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
        </StackPanel>

        <!-- Extended Database Hint (wenig lokale Ergebnisse) -->
        <Border Classes="Card StatsCard" Padding="12" Margin="0,4"
                AutomationProperties.AutomationId="Food_CardExtendedDbHint"
                IsVisible="{Binding ShowExtendedDbHint}">
          <Button AutomationProperties.AutomationId="Food_BtnExtendedDb"
                  Classes="Text" Padding="0" Height="NaN"
                  Command="{Binding RequestExtendedDbCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <mi:MaterialIcon Kind="DatabaseSearch" Width="20" Height="20"
                               Foreground="{DynamicResource InfoBrush}" />
              <TextBlock Text="{loc:Translate ExtendedFoodDb}"
                         FontSize="14" FontWeight="SemiBold"
                         Foreground="{DynamicResource InfoBrush}"
                         VerticalAlignment="Center" />
            </StackPanel>
          </Button>
        </Border>

        <!-- Skeleton-Loader wÃ¤hrend der Suche -->
        <uiControls:SkeletonLoader AutomationProperties.AutomationId="Food_SkeletonLoader"
                                    Lines="3" LineHeight="56"
                                    IsVisible="{Binding IsSearching}" />

        <!-- Search hint wenn kein Query und keine Ergebnisse -->
        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                    Spacing="8" Margin="0,40"
                    IsVisible="{Binding !HasResults}">
          <mi:MaterialIcon Kind="FoodApple" Width="48" Height="48"
                           Foreground="{DynamicResource TextMutedBrush}"
                           HorizontalAlignment="Center"
                           IsVisible="{Binding !IsSearching}" />
          <TextBlock AutomationProperties.AutomationId="Food_TxtSearchHint"
                     Text="{loc:Translate TapToSearch}" Classes="Caption"
                     HorizontalAlignment="Center"
                     IsVisible="{Binding !IsSearching}" />
        </StackPanel>

        <!-- Today's Food Log -->
        <StackPanel Spacing="8">
          <TextBlock AutomationProperties.AutomationId="Food_TxtTodayLogHeader"
                     Text="{loc:Translate TodayLog}"
                     FontSize="16" FontWeight="SemiBold"
                     Foreground="{DynamicResource TextPrimaryBrush}" />

          <TextBlock AutomationProperties.AutomationId="Food_TxtNoEntries"
                     Text="{loc:Translate NoFoodEntries}" Classes="Caption"
                     HorizontalAlignment="Center" Margin="0,20"
                     IsVisible="{Binding !HasLogEntries}" />

          <ItemsControl ItemsSource="{Binding TodayLog}"
                        IsVisible="{Binding HasLogEntries}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="models:FoodLogEntry">
                <Border Classes="Card Compact" Margin="0,4" Padding="12">
                  <Grid ColumnDefinitions="*,Auto,Auto">
                    <StackPanel>
                      <TextBlock Text="{Binding FoodName}"
                                 FontSize="14" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TextPrimaryBrush}" />
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="{Binding Grams, StringFormat='{}{0:F0}g'}"
                                   Classes="Caption" />
                        <TextBlock Text=" P:" FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                        <TextBlock Text="{Binding Protein, StringFormat='{}{0:F0}'}"
                                   FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                        <TextBlock Text=" C:" FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                        <TextBlock Text="{Binding Carbs, StringFormat='{}{0:F0}'}"
                                   FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                        <TextBlock Text=" F:" FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                        <TextBlock Text="{Binding Fat, StringFormat='{}{0:F0}'}"
                                   FontSize="11" Foreground="{DynamicResource TextMutedBrush}" />
                      </StackPanel>
                    </StackPanel>
                    <TextBlock Grid.Column="1"
                               Text="{Binding Calories, StringFormat='{}{0:F0} kcal'}"
                               FontSize="16" FontWeight="Bold"
                               Foreground="{DynamicResource ErrorBrush}"
                               VerticalAlignment="Center" />
                    <Button Grid.Column="2" Classes="Icon"
                            Command="{Binding $parent[ItemsControl].((vm:FoodSearchViewModel)DataContext).DeleteLogEntryCommand}"
                            CommandParameter="{Binding .}"
                            Margin="4,0,0,0">
                      <mi:MaterialIcon Kind="Delete" Width="18" Height="18"
                                       Foreground="{DynamicResource ErrorBrush}" />
                    </Button>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </StackPanel>

      </StackPanel>
    </ScrollViewer>

    <!-- ============================================ -->
    <!-- Row 3: Nutrition Summary Footer              -->
    <!-- ============================================ -->
    <Border Grid.Row="3"
            AutomationProperties.AutomationId="Food_FooterSummary"
            Background="{DynamicResource SurfaceBrush}"
            BorderThickness="0,1,0,0"
            BorderBrush="{DynamicResource BorderSubtleBrush}"
            Padding="16,12"
            IsVisible="{Binding HasLogEntries}">
      <StackPanel Spacing="8">

        <!-- Macro Progress Bars (when macro goals set) -->
        <StackPanel Spacing="4" IsVisible="{Binding HasMacroGoals}">
          <!-- Protein -->
          <Grid ColumnDefinitions="50,*,60" ColumnSpacing="8">
            <TextBlock Text="{loc:Translate Protein}" FontSize="11"
                       Foreground="{DynamicResource SuccessBrush}" VerticalAlignment="Center" />
            <ProgressBar Grid.Column="1"
                         AutomationProperties.AutomationId="Food_ProgressProtein"
                         Value="{Binding DailyMacroSummary.ProteinProgress.PercentageComplete}"
                         Maximum="100"
                         Foreground="{DynamicResource SuccessBrush}"
                         Height="6" />
            <TextBlock Grid.Column="2"
                       Text="{Binding DailyMacroSummary.ProteinProgress.PercentageComplete, StringFormat='{}{0:F0}%'}"
                       FontSize="11" FontWeight="SemiBold"
                       Foreground="{DynamicResource SuccessBrush}"
                       HorizontalAlignment="Right" VerticalAlignment="Center" />
          </Grid>
          <!-- Carbs -->
          <Grid ColumnDefinitions="50,*,60" ColumnSpacing="8">
            <TextBlock Text="{loc:Translate Carbs}" FontSize="11"
                       Foreground="{DynamicResource WarningBrush}" VerticalAlignment="Center" />
            <ProgressBar Grid.Column="1"
                         AutomationProperties.AutomationId="Food_ProgressCarbs"
                         Value="{Binding DailyMacroSummary.CarbsProgress.PercentageComplete}"
                         Maximum="100"
                         Foreground="{DynamicResource WarningBrush}"
                         Height="6" />
            <TextBlock Grid.Column="2"
                       Text="{Binding DailyMacroSummary.CarbsProgress.PercentageComplete, StringFormat='{}{0:F0}%'}"
                       FontSize="11" FontWeight="SemiBold"
                       Foreground="{DynamicResource WarningBrush}"
                       HorizontalAlignment="Right" VerticalAlignment="Center" />
          </Grid>
          <!-- Fat -->
          <Grid ColumnDefinitions="50,*,60" ColumnSpacing="8">
            <TextBlock Text="{loc:Translate Fat}" FontSize="11"
                       Foreground="{DynamicResource ErrorBrush}" VerticalAlignment="Center" />
            <ProgressBar Grid.Column="1"
                         AutomationProperties.AutomationId="Food_ProgressFat"
                         Value="{Binding DailyMacroSummary.FatProgress.PercentageComplete}"
                         Maximum="100"
                         Foreground="{DynamicResource ErrorBrush}"
                         Height="6" />
            <TextBlock Grid.Column="2"
                       Text="{Binding DailyMacroSummary.FatProgress.PercentageComplete, StringFormat='{}{0:F0}%'}"
                       FontSize="11" FontWeight="SemiBold"
                       Foreground="{DynamicResource ErrorBrush}"
                       HorizontalAlignment="Right" VerticalAlignment="Center" />
          </Grid>
        </StackPanel>

        <!-- Totals Summary Row -->
        <Grid ColumnDefinitions="*,*,*,*">
          <StackPanel HorizontalAlignment="Center">
            <TextBlock AutomationProperties.AutomationId="Food_TxtTotalCalories"
                       Text="{Binding TodaySummary.TotalCalories, StringFormat='{}{0:F0}'}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />
            <TextBlock Text="kcal" Classes="Caption" HorizontalAlignment="Center" />
          </StackPanel>
          <StackPanel Grid.Column="1" HorizontalAlignment="Center">
            <TextBlock AutomationProperties.AutomationId="Food_TxtTotalProtein"
                       Text="{Binding TodaySummary.TotalProtein, StringFormat='{}{0:F0}g'}"
                       FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />
            <TextBlock Text="{loc:Translate Protein}" Classes="Caption" HorizontalAlignment="Center" />
          </StackPanel>
          <StackPanel Grid.Column="2" HorizontalAlignment="Center">
            <TextBlock AutomationProperties.AutomationId="Food_TxtTotalCarbs"
                       Text="{Binding TodaySummary.TotalCarbs, StringFormat='{}{0:F0}g'}"
                       FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />
            <TextBlock Text="{loc:Translate Carbs}" Classes="Caption" HorizontalAlignment="Center" />
          </StackPanel>
          <StackPanel Grid.Column="3" HorizontalAlignment="Center">
            <TextBlock AutomationProperties.AutomationId="Food_TxtTotalFat"
                       Text="{Binding TodaySummary.TotalFat, StringFormat='{}{0:F0}g'}"
                       FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />
            <TextBlock Text="{loc:Translate Fat}" Classes="Caption" HorizontalAlignment="Center" />
          </StackPanel>
        </Grid>

        <!-- Calorie Status Banner -->
        <Border AutomationProperties.AutomationId="Food_CardCalorieStatus"
                CornerRadius="8" Padding="8,6"
                Background="{DynamicResource PrimaryBrush}"
                IsVisible="{Binding HasCalorieGoal}">
          <TextBlock AutomationProperties.AutomationId="Food_TxtCalorieStatus"
                     Text="{Binding CalorieStatusText}"
                     FontSize="13" FontWeight="SemiBold" Foreground="White"
                     HorizontalAlignment="Center" />
        </Border>
      </StackPanel>
    </Border>

    <!-- ============================================ -->
    <!-- Row 4: Undo Banner                           -->
    <!-- ============================================ -->
    <Border Grid.Row="4"
            AutomationProperties.AutomationId="Food_CardUndo"
            Background="{DynamicResource SurfaceBrush}"
            CornerRadius="8"
            Padding="16,12"
            Margin="16,8"
            IsVisible="{Binding ShowUndoBanner}">
      <Grid ColumnDefinitions="*,Auto">
        <TextBlock AutomationProperties.AutomationId="Food_TxtUndoMessage"
                   Text="{Binding UndoMessage}"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   FontSize="14" VerticalAlignment="Center" />
        <Button Grid.Column="1" Classes="Warning Small"
                AutomationProperties.AutomationId="Food_BtnUndo"
                Command="{Binding UndoDeleteLogCommand}">
          <TextBlock Text="{loc:Translate Undo}" FontWeight="Bold" />
        </Button>
      </Grid>
    </Border>

    <!-- ============================================ -->
    <!-- Scan Limit Ad Overlay                         -->
    <!-- ============================================ -->
    <Border Grid.RowSpan="5"
            AutomationProperties.AutomationId="Food_OverlayScanLimit"
            Background="#CC000000"
            IsVisible="{Binding ShowScanLimitOverlay}"
            ZIndex="80">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16"
              Padding="24"
              MaxWidth="350"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16">
          <mi:MaterialIcon Kind="Barcode" Width="48" Height="48"
                           Foreground="{DynamicResource WarningBrush}"
                           HorizontalAlignment="Center" />
          <TextBlock AutomationProperties.AutomationId="Food_TxtScanLimitTitle"
                     Text="{loc:Translate ScanLimitTitle}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />
          <TextBlock AutomationProperties.AutomationId="Food_TxtScanLimitMessage"
                     Text="{loc:Translate ScanLimitMessage}"
                     FontSize="14"
                     Foreground="{DynamicResource TextMutedBrush}"
                     TextWrapping="Wrap" TextAlignment="Center" />
          <Button AutomationProperties.AutomationId="Food_BtnWatchAdScans"
                  Classes="Primary"
                  Command="{Binding WatchAdForScansCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <mi:MaterialIcon Kind="Play" Width="20" Height="20" />
              <TextBlock Text="{loc:Translate WatchAdForScans}" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <Button AutomationProperties.AutomationId="Food_BtnCancelScanLimit"
                  Classes="Text"
                  Command="{Binding CancelScanLimitCommand}"
                  HorizontalAlignment="Center">
            <TextBlock Text="{loc:Translate Cancel}"
                       Foreground="{DynamicResource TextMutedBrush}" />
          </Button>
        </StackPanel>
      </Border>
    </Border>

    <!-- ============================================ -->
    <!-- Extended Food DB Ad Overlay                   -->
    <!-- ============================================ -->
    <Border Grid.RowSpan="5"
            AutomationProperties.AutomationId="Food_OverlayExtendedDb"
            Background="#CC000000"
            IsVisible="{Binding ShowExtendedDbOverlay}"
            ZIndex="80">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16"
              Padding="24"
              MaxWidth="350"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16">
          <mi:MaterialIcon Kind="DatabaseSearch" Width="48" Height="48"
                           Foreground="{DynamicResource InfoBrush}"
                           HorizontalAlignment="Center" />
          <TextBlock AutomationProperties.AutomationId="Food_TxtExtendedDbTitle"
                     Text="{loc:Translate ExtendedFoodDb}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />
          <TextBlock AutomationProperties.AutomationId="Food_TxtExtendedDbDesc"
                     Text="{loc:Translate ExtendedFoodDbDesc}"
                     FontSize="14"
                     Foreground="{DynamicResource TextMutedBrush}"
                     TextWrapping="Wrap" TextAlignment="Center" />
          <Button AutomationProperties.AutomationId="Food_BtnWatchAdExtendedDb"
                  Classes="Primary"
                  Command="{Binding ConfirmExtendedDbAdCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <mi:MaterialIcon Kind="Play" Width="20" Height="20" />
              <TextBlock Text="{loc:Translate ExtendedFoodDb}" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <Button AutomationProperties.AutomationId="Food_BtnCancelExtendedDb"
                  Classes="Text"
                  Command="{Binding CancelExtendedDbCommand}"
                  HorizontalAlignment="Center">
            <TextBlock Text="{loc:Translate Cancel}"
                       Foreground="{DynamicResource TextMutedBrush}" />
          </Button>
        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
