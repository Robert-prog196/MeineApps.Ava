<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WorkTimePro.ViewModels"
             xmlns:models="using:WorkTimePro.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="WorkTimePro.Views.ShiftPlanView"
             x:DataType="vm:ShiftPlanViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <Grid RowDefinitions="Auto,*" AutomationProperties.AutomationId="ShiftPlan_RootPanel">

    <!-- Back Button Header -->
    <Border Grid.Row="0"
            AutomationProperties.AutomationId="ShiftPlan_Header"
            Background="{DynamicResource SurfaceBrush}"
            Padding="8,4">
      <StackPanel Orientation="Horizontal" Spacing="8">
        <Button Classes="Text"
                AutomationProperties.AutomationId="ShiftPlan_BtnBack"
                Command="{Binding GoBackCommand}">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24"
                           Foreground="{DynamicResource PrimaryBrush}" />
        </Button>
        <TextBlock Text="{loc:Translate ShiftPlan}"
                   AutomationProperties.AutomationId="ShiftPlan_TxtTitle"
                   FontSize="18" FontWeight="Bold"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   VerticalAlignment="Center" />
      </StackPanel>
    </Border>

    <Panel Grid.Row="1">
      <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!-- ==================== Week Navigation ==================== -->
        <Border Grid.Row="0" Classes="Card StatsCard"
                AutomationProperties.AutomationId="ShiftPlan_NavCard"
                Margin="16,8,16,0"
                CornerRadius="0,0,12,12">
          <Grid ColumnDefinitions="Auto,*,Auto">
            <Button Grid.Column="0" Classes="Text"
                    AutomationProperties.AutomationId="ShiftPlan_BtnPrevWeek"
                    Command="{Binding PreviousWeekCommand}">
              <mi:MaterialIcon Kind="ChevronLeft" Width="24" Height="24"
                               Foreground="{DynamicResource PrimaryBrush}" />
            </Button>

            <StackPanel Grid.Column="1" HorizontalAlignment="Center">
              <TextBlock Text="{Binding WeekDisplay}"
                         AutomationProperties.AutomationId="ShiftPlan_TxtWeekDisplay"
                         FontSize="18" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}"
                         HorizontalAlignment="Center" />
              <TextBlock Text="{Binding TotalHoursDisplay}"
                         AutomationProperties.AutomationId="ShiftPlan_TxtTotalHours"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         HorizontalAlignment="Center" />
            </StackPanel>

            <Button Grid.Column="2" Classes="Text"
                    AutomationProperties.AutomationId="ShiftPlan_BtnNextWeek"
                    Command="{Binding NextWeekCommand}">
              <mi:MaterialIcon Kind="ChevronRight" Width="24" Height="24"
                               Foreground="{DynamicResource PrimaryBrush}" />
            </Button>
          </Grid>
        </Border>

        <!-- ==================== Shift Pattern Selection ==================== -->
        <Border Grid.Row="1" Classes="Card StatsCard" AutomationProperties.AutomationId="ShiftPlan_PatternCard" Margin="16,8">
          <StackPanel Spacing="8">
            <TextBlock Text="{loc:Translate SelectShiftPattern}"
                       FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}" />

            <!-- Horizontal Shift Pattern List -->
            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                          AutomationProperties.AutomationId="ShiftPlan_PatternScroller"
                          VerticalScrollBarVisibility="Disabled"
                          Height="70">
              <ItemsControl ItemsSource="{Binding ShiftPatterns}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="8" />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="models:ShiftPattern">
                    <Button Classes="Text" Padding="0"
                            Command="{Binding $parent[UserControl].((vm:ShiftPlanViewModel)DataContext).SelectPatternCommand}"
                            CommandParameter="{Binding .}">
                      <Border Background="{Binding Color}"
                              CornerRadius="12"
                              Padding="12,8"
                              MinWidth="80">
                        <StackPanel HorizontalAlignment="Center">
                          <TextBlock Text="{Binding Name}"
                                     FontSize="12" FontWeight="Bold"
                                     Foreground="White"
                                     HorizontalAlignment="Center" />
                          <TextBlock Text="{Binding TimeRangeDisplay}"
                                     FontSize="10"
                                     Foreground="White" Opacity="0.8"
                                     HorizontalAlignment="Center" />
                        </StackPanel>
                      </Border>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>

            <!-- Empty State for Patterns -->
            <StackPanel IsVisible="{Binding HasNoPatterns}"
                        AutomationProperties.AutomationId="ShiftPlan_EmptyPatterns"
                        HorizontalAlignment="Center" Margin="0,8">
              <mi:MaterialIcon Kind="CalendarCheck" Width="32" Height="32"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" />
              <TextBlock Text="{loc:Translate NoEntries}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         HorizontalAlignment="Center" />
            </StackPanel>

            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right" Spacing="8">
              <Button Content="{loc:Translate AddNew}"
                      AutomationProperties.AutomationId="ShiftPlan_BtnAddPattern"
                      Classes="Outlined Small"
                      Command="{Binding ShowPatternEditorCommand}" />
              <Button Content="{loc:Translate ApplyToWeek}"
                      AutomationProperties.AutomationId="ShiftPlan_BtnApplyPattern"
                      Classes="Primary Small"
                      Command="{Binding ApplyPatternToWeekCommand}" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- ==================== Week Days ==================== -->
        <ScrollViewer Grid.Row="2" AutomationProperties.AutomationId="ShiftPlan_DaysScroller">
          <StackPanel Spacing="8" Margin="16,0">
            <ItemsControl ItemsSource="{Binding WeekDays}" AutomationProperties.AutomationId="ShiftPlan_DaysList">
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:ShiftDayItem">
                  <Border Classes="Card" Padding="16" Margin="0,2"
                          BorderThickness="{Binding TodayBorderThickness}"
                          BorderBrush="{DynamicResource PrimaryBrush}"
                          Opacity="{Binding DayOpacity}">
                    <Grid ColumnDefinitions="60,*,Auto,Auto">

                      <!-- Day -->
                      <StackPanel Grid.Column="0">
                        <TextBlock Text="{Binding DayName}"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                        <TextBlock Text="{Binding DateDisplay}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                      </StackPanel>

                      <!-- Shift -->
                      <Button Grid.Column="1" Classes="Text" Padding="0"
                              Command="{Binding $parent[UserControl].((vm:ShiftPlanViewModel)DataContext).AssignShiftCommand}"
                              CommandParameter="{Binding .}"
                              HorizontalAlignment="Left">
                        <Border Background="{Binding PatternColor}"
                                CornerRadius="8"
                                Padding="12,8"
                                MinWidth="100">
                          <TextBlock Text="{Binding PatternName}"
                                     FontSize="14"
                                     Foreground="White"
                                     HorizontalAlignment="Center" />
                        </Border>
                      </Button>

                      <!-- Work Time -->
                      <TextBlock Grid.Column="2"
                                 Text="{Binding WorkTimeDisplay}"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 VerticalAlignment="Center"
                                 Margin="8,0" />

                      <!-- Delete Button -->
                      <Button Grid.Column="3" Classes="Text"
                              Command="{Binding $parent[UserControl].((vm:ShiftPlanViewModel)DataContext).ClearDayCommand}"
                              CommandParameter="{Binding .}">
                        <mi:MaterialIcon Kind="Close" Width="16" Height="16"
                                         Foreground="{DynamicResource TextSecondaryBrush}" />
                      </Button>

                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Bottom Spacer (Ad-Banner) -->
            <Border Height="60" />
          </StackPanel>
        </ScrollViewer>

        <!-- Today Button -->
        <Button Grid.Row="3"
                AutomationProperties.AutomationId="ShiftPlan_BtnToday"
                Content="{loc:Translate TodayButton}"
                Classes="Primary"
                CornerRadius="24"
                Margin="16"
                Command="{Binding GoToTodayCommand}"
                HorizontalAlignment="Center" />

      </Grid>

      <!-- ==================== Pattern Editor Modal ==================== -->
      <Panel IsVisible="{Binding IsPatternEditorVisible}" AutomationProperties.AutomationId="ShiftPlan_EditorOverlay">

        <!-- Backdrop -->
        <Border Background="#80000000"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch" />

        <!-- Modal Content -->
        <Border Background="{DynamicResource SurfaceBrush}"
                AutomationProperties.AutomationId="ShiftPlan_EditorCard"
                CornerRadius="16"
                Padding="24"
                Margin="32"
                VerticalAlignment="Center"
                BoxShadow="0 8 32 0 #40000000">
          <StackPanel Spacing="16">
            <TextBlock Text="{loc:Translate ShiftPattern}"
                       Classes="PageTitle" />

            <!-- Name -->
            <StackPanel Spacing="4">
              <TextBlock Text="{loc:Translate Name}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBox Text="{Binding PatternName}"
                       AutomationProperties.AutomationId="ShiftPlan_TxtPatternName"
                       Watermark="{loc:Translate EarlyShiftExample}" />
            </StackPanel>

            <!-- Times -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
              <StackPanel Grid.Column="0" Spacing="4">
                <TextBlock Text="{loc:Translate Start}"
                           FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}" />
                <TextBox Text="{Binding PatternStartTimeDisplay}"
                         AutomationProperties.AutomationId="ShiftPlan_TxtStartTime"
                         Watermark="HH:mm" />
              </StackPanel>

              <StackPanel Grid.Column="1" Spacing="4">
                <TextBlock Text="{loc:Translate End}"
                           FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}" />
                <TextBox Text="{Binding PatternEndTimeDisplay}"
                         AutomationProperties.AutomationId="ShiftPlan_TxtEndTime"
                         Watermark="HH:mm" />
              </StackPanel>
            </Grid>

            <!-- Color Selection -->
            <StackPanel Spacing="4">
              <TextBlock Text="{loc:Translate Color}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Classes="Text" Padding="0"
                        AutomationProperties.AutomationId="ShiftPlan_BtnColorBlue"
                        Command="{Binding SetPatternColorCommand}"
                        CommandParameter="#1565C0">
                  <Border Background="#1565C0" Width="48" Height="48"
                          CornerRadius="8" />
                </Button>
                <Button Classes="Text" Padding="0"
                        AutomationProperties.AutomationId="ShiftPlan_BtnColorGreen"
                        Command="{Binding SetPatternColorCommand}"
                        CommandParameter="#2E7D32">
                  <Border Background="#2E7D32" Width="48" Height="48"
                          CornerRadius="8" />
                </Button>
                <Button Classes="Text" Padding="0"
                        AutomationProperties.AutomationId="ShiftPlan_BtnColorOrange"
                        Command="{Binding SetPatternColorCommand}"
                        CommandParameter="#F57C00">
                  <Border Background="#F57C00" Width="48" Height="48"
                          CornerRadius="8" />
                </Button>
                <Button Classes="Text" Padding="0"
                        AutomationProperties.AutomationId="ShiftPlan_BtnColorRed"
                        Command="{Binding SetPatternColorCommand}"
                        CommandParameter="#C62828">
                  <Border Background="#C62828" Width="48" Height="48"
                          CornerRadius="8" />
                </Button>
                <Button Classes="Text" Padding="0"
                        AutomationProperties.AutomationId="ShiftPlan_BtnColorPurple"
                        Command="{Binding SetPatternColorCommand}"
                        CommandParameter="#6A1B9A">
                  <Border Background="#6A1B9A" Width="48" Height="48"
                          CornerRadius="8" />
                </Button>
              </StackPanel>
            </StackPanel>

            <!-- Buttons -->
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right" Spacing="12">
              <Button Content="{loc:Translate Cancel}"
                      AutomationProperties.AutomationId="ShiftPlan_BtnCancelEditor"
                      Classes="Secondary"
                      Command="{Binding HidePatternEditorCommand}" />
              <Button Content="{loc:Translate Save}"
                      AutomationProperties.AutomationId="ShiftPlan_BtnSavePattern"
                      Classes="Primary"
                      Command="{Binding SavePatternCommand}" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Panel>

      <!-- Loading -->
      <ProgressBar AutomationProperties.AutomationId="ShiftPlan_LoadingBar"
                   IsIndeterminate="True"
                   IsVisible="{Binding IsLoading}"
                   VerticalAlignment="Center"
                   HorizontalAlignment="Center" />

    </Panel>

  </Grid>

</UserControl>
