<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WorkTimePro.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:views="using:WorkTimePro.Views"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:controls="using:MeineApps.UI.Controls"
             x:Class="WorkTimePro.Views.MainView"
             x:DataType="vm:MainViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <Grid RowDefinitions="*,Auto,Auto" AutomationProperties.AutomationId="Main_RootGrid">

    <!-- ============================================ -->
    <!-- Row 0: Content Area (switches based on tab)  -->
    <!-- ============================================ -->
    <Panel Grid.Row="0" AutomationProperties.AutomationId="Main_ContentPanel">
      <!-- Today Tab (uses MainViewModel directly) -->
      <Border x:Name="TodayTab" AutomationProperties.AutomationId="Main_TabTodayContent" IsVisible="{Binding IsTodayActive}"
              Opacity="1">
        <Border.Transitions>
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.15" Easing="CubicEaseOut" />
          </Transitions>
        </Border.Transitions>
        <views:TodayView />
      </Border>

      <!-- Week Tab -->
      <Border x:Name="WeekTab" AutomationProperties.AutomationId="Main_TabWeekContent" IsVisible="{Binding IsWeekActive}"
              Opacity="1">
        <Border.Transitions>
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.15" Easing="CubicEaseOut" />
          </Transitions>
        </Border.Transitions>
        <views:WeekOverviewView DataContext="{Binding WeekVm}" />
      </Border>

      <!-- Calendar Tab -->
      <Border x:Name="CalendarTab" AutomationProperties.AutomationId="Main_TabCalendarContent" IsVisible="{Binding IsCalendarActive}"
              Opacity="1">
        <Border.Transitions>
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.15" Easing="CubicEaseOut" />
          </Transitions>
        </Border.Transitions>
        <views:CalendarView DataContext="{Binding CalendarVm}" />
      </Border>

      <!-- Statistics Tab -->
      <Border x:Name="StatisticsTab" AutomationProperties.AutomationId="Main_TabStatisticsContent" IsVisible="{Binding IsStatisticsActive}"
              Opacity="1">
        <Border.Transitions>
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.15" Easing="CubicEaseOut" />
          </Transitions>
        </Border.Transitions>
        <views:StatisticsView DataContext="{Binding StatisticsVm}" />
      </Border>

      <!-- Settings Tab -->
      <Border x:Name="SettingsTab" AutomationProperties.AutomationId="Main_TabSettingsContent" IsVisible="{Binding IsSettingsActive}"
              Opacity="1">
        <Border.Transitions>
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.15" Easing="CubicEaseOut" />
          </Transitions>
        </Border.Transitions>
        <views:SettingsView DataContext="{Binding SettingsVm}" />
      </Border>

      <!-- ============================================ -->
      <!-- Sub-Pages (overlays, higher z-index)         -->
      <!-- ============================================ -->
      <Border x:Name="SubPageOverlay"
              AutomationProperties.AutomationId="Main_SubPageOverlay"
              IsVisible="{Binding IsSubPageActive}"
              ZIndex="5"
              RenderTransform="translateX(0px)"
              ClipToBounds="True">
        <Border.Transitions>
          <Transitions>
            <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut" />
            <DoubleTransition Property="Opacity" Duration="0:0:0.25" Easing="CubicEaseOut" />
          </Transitions>
        </Border.Transitions>

        <Panel>
          <views:DayDetailView DataContext="{Binding DayDetailVm}"
                                IsVisible="{Binding $parent[views:MainView].((vm:MainViewModel)DataContext).IsDayDetailActive}" />

          <views:MonthOverviewView DataContext="{Binding MonthVm}"
                                    IsVisible="{Binding $parent[views:MainView].((vm:MainViewModel)DataContext).IsMonthActive}" />

          <views:YearOverviewView DataContext="{Binding YearVm}"
                                   IsVisible="{Binding $parent[views:MainView].((vm:MainViewModel)DataContext).IsYearActive}" />

          <views:VacationView DataContext="{Binding VacationVm}"
                               IsVisible="{Binding $parent[views:MainView].((vm:MainViewModel)DataContext).IsVacationActive}" />

          <views:ShiftPlanView DataContext="{Binding ShiftPlanVm}"
                                IsVisible="{Binding $parent[views:MainView].((vm:MainViewModel)DataContext).IsShiftPlanActive}" />
        </Panel>
      </Border>
    </Panel>

    <!-- Game Juice Overlays -->
    <controls:FloatingTextOverlay x:Name="FloatingTextCanvas"
                                   AutomationProperties.AutomationId="Main_FloatingTextOverlay"
                                   Grid.RowSpan="3"
                                   ZIndex="15"
                                   IsHitTestVisible="False" />
    <controls:SkiaCelebrationOverlay x:Name="CelebrationCanvas"
                                      AutomationProperties.AutomationId="Main_CelebrationOverlay"
                                      Grid.RowSpan="3"
                                      ZIndex="16"
                                      IsHitTestVisible="False" />

    <!-- ============================================ -->
    <!-- Ad Banner Spacer (64dp fuer adaptive Banner) -->
    <Border Grid.Row="1" Height="64"
            AutomationProperties.AutomationId="Main_AdBannerSpacer"
            IsVisible="{Binding IsAdBannerVisible}" />

    <!-- Ersatz-Spacer wenn Tab-Bar versteckt (SubPage offen) -->
    <Border Grid.Row="2" Height="56"
            IsVisible="{Binding IsSubPageActive}" />

    <!-- Row 2: Bottom Tab Bar                        -->
    <!-- ============================================ -->
    <Border Grid.Row="2"
            AutomationProperties.AutomationId="Main_TabBar"
            Background="{DynamicResource SurfaceBrush}"
            BorderThickness="0,1,0,0"
            BorderBrush="{DynamicResource CardBorderBrush}"
            Padding="0,0"
            IsVisible="{Binding !IsSubPageActive}">

      <Grid RowDefinitions="Auto,Auto">

        <!-- Tab-Indikator (farbiger Balken, gleitet zwischen Tabs) -->
        <Canvas Grid.Row="0" Height="3" Margin="0,0,0,0"
                ClipToBounds="False">
          <Border x:Name="TabIndicator"
                  Height="3" Width="48"
                  CornerRadius="2"
                  Background="{DynamicResource PrimaryBrush}"
                  Canvas.Top="0"
                  RenderTransform="translateX(0px)">
            <Border.Transitions>
              <Transitions>
                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut" />
              </Transitions>
            </Border.Transitions>
          </Border>
        </Canvas>

        <!-- Tab Buttons -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*,*,*,*" Margin="0,6,0,8">

          <!-- Today -->
          <Button Grid.Column="0" Classes="Text"
                  AutomationProperties.AutomationId="Main_TabToday"
                  Command="{Binding SelectTodayTabCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Spacing="2" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="ClockOutline" Width="24" Height="24"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               x:Name="TabIconToday" />
              <TextBlock Text="{loc:Translate Today}"
                         FontSize="10" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         x:Name="TabLabelToday" />
            </StackPanel>
          </Button>

          <!-- Week -->
          <Button Grid.Column="1" Classes="Text"
                  AutomationProperties.AutomationId="Main_TabWeek"
                  Command="{Binding SelectWeekTabCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Spacing="2" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="CalendarWeek" Width="24" Height="24"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               x:Name="TabIconWeek" />
              <TextBlock Text="{loc:Translate Week}"
                         FontSize="10" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         x:Name="TabLabelWeek" />
            </StackPanel>
          </Button>

          <!-- Calendar -->
          <Button Grid.Column="2" Classes="Text"
                  AutomationProperties.AutomationId="Main_TabCalendar"
                  Command="{Binding SelectCalendarTabCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Spacing="2" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="CalendarMonth" Width="24" Height="24"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               x:Name="TabIconCalendar" />
              <TextBlock Text="{loc:Translate Calendar}"
                         FontSize="10" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         x:Name="TabLabelCalendar" />
            </StackPanel>
          </Button>

          <!-- Statistics -->
          <Button Grid.Column="3" Classes="Text"
                  AutomationProperties.AutomationId="Main_TabStatistics"
                  Command="{Binding SelectStatisticsTabCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Spacing="2" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="ChartBar" Width="24" Height="24"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               x:Name="TabIconStatistics" />
              <TextBlock Text="{loc:Translate Statistics}"
                         FontSize="10" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         x:Name="TabLabelStatistics" />
            </StackPanel>
          </Button>

          <!-- Settings -->
          <Button Grid.Column="4" Classes="Text"
                  AutomationProperties.AutomationId="Main_TabSettings"
                  Command="{Binding SelectSettingsTabCommand}"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center">
            <StackPanel Spacing="2" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="CogOutline" Width="24" Height="24"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               x:Name="TabIconSettings" />
              <TextBlock Text="{loc:Translate Settings}"
                         FontSize="10" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         x:Name="TabLabelSettings" />
            </StackPanel>
          </Button>

        </Grid>
      </Grid>
    </Border>

  </Grid>

</UserControl>
