<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WorkTimePro.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:skia="using:Avalonia.Labs.Controls"
             x:Class="WorkTimePro.Views.YearOverviewView"
             x:DataType="vm:YearOverviewViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <Grid RowDefinitions="Auto,*" AutomationProperties.AutomationId="Year_RootPanel">

    <!-- Back + Year Navigation Header -->
    <Border Grid.Row="0"
            AutomationProperties.AutomationId="Year_Header"
            Background="{DynamicResource SurfaceBrush}"
            Padding="8,4">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto">
        <Button Grid.Column="0" Classes="Text"
                AutomationProperties.AutomationId="Year_BtnBack"
                Command="{Binding GoBackCommand}">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24"
                           Foreground="{DynamicResource PrimaryBrush}" />
        </Button>
        <Button Grid.Column="1" Classes="Text"
                AutomationProperties.AutomationId="Year_BtnPrevious"
                Command="{Binding PreviousYearCommand}">
          <mi:MaterialIcon Kind="ChevronLeft" Width="24" Height="24"
                           Foreground="{DynamicResource PrimaryBrush}" />
        </Button>
        <Button Grid.Column="2" Classes="Text"
                AutomationProperties.AutomationId="Year_BtnCurrentYear"
                Command="{Binding GoToCurrentYearCommand}"
                HorizontalAlignment="Center">
          <TextBlock Text="{Binding SelectedYear}"
                     AutomationProperties.AutomationId="Year_TxtYear"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}" />
        </Button>
        <Button Grid.Column="3" Classes="Text"
                AutomationProperties.AutomationId="Year_BtnNext"
                Command="{Binding NextYearCommand}">
          <mi:MaterialIcon Kind="ChevronRight" Width="24" Height="24"
                           Foreground="{DynamicResource PrimaryBrush}" />
        </Button>
      </Grid>
    </Border>

    <!-- Loading Overlay -->
    <ProgressBar Grid.Row="1"
                 AutomationProperties.AutomationId="Year_LoadingBar"
                 IsIndeterminate="True"
                 IsVisible="{Binding IsLoading}"
                 VerticalAlignment="Top"
                 ZIndex="100" />

    <ScrollViewer Grid.Row="1" AutomationProperties.AutomationId="Year_ScrollViewer">
      <StackPanel Spacing="16" Margin="16">

        <!-- ==================== Year Summary Card ==================== -->
        <Border Classes="CardElevated StatsCard" AutomationProperties.AutomationId="Year_SummaryCard">
          <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                ColumnDefinitions="*,*"
                RowSpacing="12">

            <!-- Work Time -->
            <StackPanel Grid.Row="0" Grid.Column="0">
              <TextBlock Text="{loc:Translate ActualTime}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding TotalWorkTimeDisplay}"
                         AutomationProperties.AutomationId="Year_TxtWorkTime"
                         FontSize="26" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
            </StackPanel>

            <!-- Target Time -->
            <StackPanel Grid.Row="0" Grid.Column="1">
              <TextBlock Text="{loc:Translate TargetTime}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding TotalTargetTimeDisplay}"
                         AutomationProperties.AutomationId="Year_TxtTargetTime"
                         FontSize="26" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
            </StackPanel>

            <!-- Balance -->
            <StackPanel Grid.Row="1" Grid.Column="0">
              <TextBlock Text="{loc:Translate Balance}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding TotalBalanceDisplay}"
                         AutomationProperties.AutomationId="Year_TxtBalance"
                         FontSize="26" FontWeight="Bold"
                         Foreground="{Binding BalanceColor}" />
            </StackPanel>

            <!-- Work Days -->
            <StackPanel Grid.Row="1" Grid.Column="1">
              <TextBlock Text="{loc:Translate WorkDaysTotal}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding TotalWorkDays}"
                         AutomationProperties.AutomationId="Year_TxtWorkDays"
                         FontSize="26" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
            </StackPanel>

            <!-- Average -->
            <StackPanel Grid.Row="2" Grid.Column="0">
              <TextBlock Text="{loc:Translate AvgPerDayShort}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding AverageHoursPerDayDisplay}"
                         AutomationProperties.AutomationId="Year_TxtAverage"
                         FontSize="18" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
            </StackPanel>

            <!-- Vacation / Sick -->
            <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Spacing="16">
              <StackPanel>
                <TextBlock Text="{loc:Translate VacationLabel}"
                           FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}" />
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <mi:MaterialIcon Kind="Beach" Width="14" Height="14"
                                   Foreground="{DynamicResource PrimaryBrush}"
                                   VerticalAlignment="Center" />
                  <TextBlock Text="{Binding VacationDaysTakenDisplay}"
                             AutomationProperties.AutomationId="Year_TxtVacationDays"
                             FontSize="14"
                             Foreground="{DynamicResource TextPrimaryBrush}" />
                </StackPanel>
              </StackPanel>
              <StackPanel>
                <TextBlock Text="{loc:Translate SickLabel}"
                           FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}" />
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <mi:MaterialIcon Kind="Thermometer" Width="14" Height="14"
                                   Foreground="{DynamicResource ErrorBrush}"
                                   VerticalAlignment="Center" />
                  <TextBlock Text="{Binding SickDaysDisplay}"
                             AutomationProperties.AutomationId="Year_TxtSickDays"
                             FontSize="14"
                             Foreground="{DynamicResource TextPrimaryBrush}" />
                </StackPanel>
              </StackPanel>
            </StackPanel>

            <!-- Export Button -->
            <Button Grid.Row="3" Grid.ColumnSpan="2"
                    AutomationProperties.AutomationId="Year_BtnExportPdf"
                    Content="{loc:Translate PdfExport}"
                    Classes="Primary"
                    Command="{Binding ExportPdfCommand}"
                    IsVisible="{Binding IsPremium}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center" />

          </Grid>
        </Border>

        <!-- ==================== Chart: Monthly Work Hours ==================== -->
        <Border Classes="Card StatsCard"
                AutomationProperties.AutomationId="Year_MonthlyChartCard"
                IsVisible="{Binding IsPremium}">
          <StackPanel>
            <TextBlock Text="{loc:Translate WorkHoursPerMonth}"
                       AutomationProperties.AutomationId="Year_TxtMonthlyChartTitle"
                       FontSize="16" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Margin="0,0,0,8" />
            <skia:SKCanvasView x:Name="MonthlyChartCanvas"
                                   AutomationProperties.AutomationId="Year_MonthlyChartCanvas"
                                   PaintSurface="OnPaintMonthlyChart"
                                   Height="200" />
          </StackPanel>
        </Border>

        <!-- ==================== Chart: Cumulative Balance ==================== -->
        <Border Classes="Card StatsCard"
                AutomationProperties.AutomationId="Year_BalanceChartCard"
                IsVisible="{Binding IsPremium}">
          <StackPanel>
            <TextBlock Text="{loc:Translate OvertimeDevelopment}"
                       AutomationProperties.AutomationId="Year_TxtBalanceChartTitle"
                       FontSize="16" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Margin="0,0,0,8" />
            <skia:SKCanvasView x:Name="BalanceChartCanvas"
                                   AutomationProperties.AutomationId="Year_BalanceChartCanvas"
                                   PaintSurface="OnPaintBalanceChart"
                                   Height="180" />
          </StackPanel>
        </Border>

        <!-- ==================== Months List (kompakt) ==================== -->
        <TextBlock Text="{loc:Translate MonthsOverviewTitle}"
                   AutomationProperties.AutomationId="Year_TxtMonthsTitle"
                   FontSize="18" FontWeight="Bold"
                   Foreground="{DynamicResource TextPrimaryBrush}" />

        <ItemsControl ItemsSource="{Binding Months}" AutomationProperties.AutomationId="Year_MonthsList">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="vm:MonthSummary">
              <Button Classes="Text"
                      Command="{Binding $parent[UserControl].((vm:YearOverviewViewModel)DataContext).NavigateToMonthCommand}"
                      CommandParameter="{Binding .}"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Stretch"
                      Padding="0" Margin="0,2">
                <Border Classes="Card" Padding="12" Margin="0">
                  <Grid ColumnDefinitions="*,Auto,Auto,60" ColumnSpacing="8">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                      <TextBlock Text="{Binding MonthName}" FontSize="15" FontWeight="Bold"
                                 Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                      <mi:MaterialIcon Kind="Lock" Width="14" Height="14"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       IsVisible="{Binding IsLocked}" VerticalAlignment="Center" />
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="{Binding WorkTimeDisplay}" FontSize="14"
                               Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                    <TextBlock Grid.Column="2" Text="{Binding TargetTimeDisplay}" FontSize="13"
                               Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                    <TextBlock Grid.Column="3" Text="{Binding BalanceDisplay}" FontSize="14" FontWeight="Bold"
                               Foreground="{Binding BalanceColor}" VerticalAlignment="Center" HorizontalAlignment="Right" />
                  </Grid>
                </Border>
              </Button>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Bottom Spacer (Ad-Banner) -->
        <Border Height="60" />

      </StackPanel>
    </ScrollViewer>

    <!-- ==================== Rewarded Ad Overlay ==================== -->
    <Border IsVisible="{Binding ShowRewardedAdOverlay}"
            AutomationProperties.AutomationId="Year_AdOverlay"
            Background="#CC000000"
            ZIndex="100"
            Grid.RowSpan="2">
      <Border Background="{DynamicResource CardBrush}"
              AutomationProperties.AutomationId="Year_AdOverlayCard"
              CornerRadius="16"
              Padding="24"
              MaxWidth="340"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock Text="{loc:Translate PremiumFeatureTitle}"
                     AutomationProperties.AutomationId="Year_TxtAdTitle"
                     FontSize="22" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="30"
                  Width="60" Height="60"
                  HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                             Foreground="{DynamicResource AccentBrush}" />
          </Border>
          <TextBlock Text="{loc:Translate PremiumFeatureDesc}"
                     AutomationProperties.AutomationId="Year_TxtAdDesc"
                     FontSize="14"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     TextWrapping="Wrap" TextAlignment="Center" />
          <StackPanel Spacing="8">
            <Button Classes="Filled"
                    AutomationProperties.AutomationId="Year_BtnWatchAd"
                    Command="{Binding WatchAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="16,12">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Video" Width="20" Height="20" />
                <TextBlock Text="{loc:Translate WatchVideoOnce}"
                           FontSize="15" FontWeight="SemiBold" />
              </StackPanel>
            </Button>
            <Button Classes="Text"
                    AutomationProperties.AutomationId="Year_BtnCancelAd"
                    Command="{Binding CancelAdOverlayCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,10">
              <TextBlock Text="{loc:Translate Cancel}"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
