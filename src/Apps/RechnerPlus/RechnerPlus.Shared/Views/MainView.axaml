<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RechnerPlus.ViewModels"
             xmlns:views="using:RechnerPlus.Views"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:calc="using:MeineApps.CalcLib"
             xmlns:controls="using:MeineApps.UI.Controls"
             x:Class="RechnerPlus.Views.MainView"
             x:DataType="vm:MainViewModel"
             Background="{DynamicResource BackgroundBrush}">

  <UserControl.Styles>
    <!-- Fade transition for tab content switching -->
    <Style Selector="Border.TabContent">
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.15" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.TabContent:not(.Active)">
      <Setter Property="Opacity" Value="0" />
      <Setter Property="IsHitTestVisible" Value="False" />
    </Style>
    <Style Selector="Border.TabContent.Active">
      <Setter Property="Opacity" Value="1" />
      <Setter Property="IsHitTestVisible" Value="True" />
    </Style>

    <!-- History backdrop fade -->
    <Style Selector="Border.HistoryBackdrop">
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
        </Transitions>
      </Setter>
    </Style>

    <!-- History panel slide -->
    <Style Selector="Border.HistoryPanel">
      <Setter Property="RenderTransform" Value="translate(0px, 400px)"/>
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.HistoryPanel.Visible">
      <Setter Property="RenderTransform" Value="translate(0px, 0px)"/>
    </Style>

    <!-- History entry hover -->
    <Style Selector="Button.HistoryEntry:pointerover">
      <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
    </Style>
  </UserControl.Styles>

  <Panel>
    <Grid RowDefinitions="*,Auto">

      <!-- Content Area -->
      <Panel Grid.Row="0" Name="ContentPanel">
        <Border Classes="TabContent"
                Classes.Active="{Binding IsCalculatorActive}">
          <Grid RowDefinitions="*,Auto">
            <views:CalculatorView Grid.Row="0" DataContext="{Binding CalculatorViewModel}" />

            <!-- Mini-History unter dem Calculator (letzte 2 Berechnungen) -->
            <ItemsControl Grid.Row="1"
                          ItemsSource="{Binding CalculatorViewModel.RecentHistory}"
                          IsVisible="{Binding CalculatorViewModel.HasHistory}"
                          Margin="16,0,16,4">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Orientation="Horizontal" Spacing="8"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="calc:CalculationHistoryEntry">
                  <Button Classes="Text"
                          Padding="8,4"
                          CornerRadius="12"
                          MinHeight="0" MinWidth="0"
                          Background="{DynamicResource DigitButtonBrush}"
                          Command="{Binding $parent[ItemsControl].((vm:MainViewModel)DataContext).CalculatorViewModel.SelectHistoryEntryCommand}"
                          CommandParameter="{Binding}">
                    <TextBlock FontSize="11"
                               Foreground="{DynamicResource TextMutedBrush}"
                               TextTrimming="CharacterEllipsis"
                               MaxWidth="160">
                      <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0} = {1}">
                          <Binding Path="Expression"/>
                          <Binding Path="Result"/>
                        </MultiBinding>
                      </TextBlock.Text>
                    </TextBlock>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </Grid>
        </Border>
        <Border Classes="TabContent"
                Classes.Active="{Binding IsConverterActive}">
          <views:ConverterView DataContext="{Binding ConverterViewModel}" />
        </Border>
        <Border Classes="TabContent"
                Classes.Active="{Binding IsSettingsActive}">
          <views:SettingsView DataContext="{Binding SettingsViewModel}" />
        </Border>
      </Panel>

      <!-- Bottom Navigation Bar -->
      <Border Grid.Row="1"
              Background="{DynamicResource SurfaceBrush}"
              BorderBrush="{DynamicResource BorderSubtleBrush}"
              BorderThickness="0,1,0,0">
        <Grid ColumnDefinitions="*,*,*" Margin="0,2">

          <!-- Calculator Tab -->
          <Button Grid.Column="0"
                  Classes="Text"
                  Command="{Binding NavigateToCalculatorCommand}"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="0"
                  Height="56">
            <StackPanel Spacing="2">
              <Border Height="3" CornerRadius="2" Margin="12,0"
                      IsVisible="{Binding IsCalculatorActive}">
                <Border.Background>
                  <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
                </Border.Background>
              </Border>
              <Border Height="3" IsVisible="{Binding !IsCalculatorActive}" />
              <Panel>
                <mi:MaterialIcon Kind="Calculator" Width="24" Height="24"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 IsVisible="{Binding IsCalculatorActive}" />
                <mi:MaterialIcon Kind="CalculatorVariantOutline" Width="24" Height="24"
                                 Foreground="{DynamicResource TextMutedBrush}"
                                 IsVisible="{Binding !IsCalculatorActive}" />
              </Panel>
              <Panel>
                <TextBlock Text="{Binding NavCalculatorText}" FontSize="11"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource PrimaryBrush}"
                           FontWeight="Medium"
                           IsVisible="{Binding IsCalculatorActive}" />
                <TextBlock Text="{Binding NavCalculatorText}" FontSize="11"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextMutedBrush}"
                           IsVisible="{Binding !IsCalculatorActive}" />
              </Panel>
            </StackPanel>
          </Button>

          <!-- Converter Tab -->
          <Button Grid.Column="1"
                  Classes="Text"
                  Command="{Binding NavigateToConverterCommand}"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="0"
                  Height="56">
            <StackPanel Spacing="2">
              <Border Height="3" CornerRadius="2" Margin="12,0"
                      IsVisible="{Binding IsConverterActive}">
                <Border.Background>
                  <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
                </Border.Background>
              </Border>
              <Border Height="3" IsVisible="{Binding !IsConverterActive}" />
              <Panel>
                <mi:MaterialIcon Kind="SwapHorizontalBold" Width="24" Height="24"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 IsVisible="{Binding IsConverterActive}" />
                <mi:MaterialIcon Kind="SwapHorizontal" Width="24" Height="24"
                                 Foreground="{DynamicResource TextMutedBrush}"
                                 IsVisible="{Binding !IsConverterActive}" />
              </Panel>
              <Panel>
                <TextBlock Text="{Binding NavConverterText}" FontSize="11"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource PrimaryBrush}"
                           FontWeight="Medium"
                           IsVisible="{Binding IsConverterActive}" />
                <TextBlock Text="{Binding NavConverterText}" FontSize="11"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextMutedBrush}"
                           IsVisible="{Binding !IsConverterActive}" />
              </Panel>
            </StackPanel>
          </Button>

          <!-- Settings Tab -->
          <Button Grid.Column="2"
                  Classes="Text"
                  Command="{Binding NavigateToSettingsCommand}"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="0"
                  Height="56">
            <StackPanel Spacing="2">
              <Border Height="3" CornerRadius="2" Margin="12,0"
                      IsVisible="{Binding IsSettingsActive}">
                <Border.Background>
                  <SolidColorBrush Color="{DynamicResource PrimaryColor}" />
                </Border.Background>
              </Border>
              <Border Height="3" IsVisible="{Binding !IsSettingsActive}" />
              <Panel>
                <mi:MaterialIcon Kind="Cog" Width="24" Height="24"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 IsVisible="{Binding IsSettingsActive}" />
                <mi:MaterialIcon Kind="CogOutline" Width="24" Height="24"
                                 Foreground="{DynamicResource TextMutedBrush}"
                                 IsVisible="{Binding !IsSettingsActive}" />
              </Panel>
              <Panel>
                <TextBlock Text="{Binding NavSettingsText}" FontSize="11"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource PrimaryBrush}"
                           FontWeight="Medium"
                           IsVisible="{Binding IsSettingsActive}" />
                <TextBlock Text="{Binding NavSettingsText}" FontSize="11"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextMutedBrush}"
                           IsVisible="{Binding !IsSettingsActive}" />
              </Panel>
            </StackPanel>
          </Button>

        </Grid>
      </Border>

    </Grid>

    <!-- Floating Text Overlay -->
    <controls:FloatingTextOverlay x:Name="FloatingTextCanvas"
                                   IsHitTestVisible="False" />

    <!-- Onboarding Overlay -->
    <Panel x:Name="OnboardingOverlay" IsVisible="False">
      <!-- Halbtransparenter Hintergrund -->
      <Border Background="#60000000" />
      <!-- Tooltip wird per Code-Behind positioniert -->
      <controls:TooltipBubble x:Name="OnboardingTooltip"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Margin="32,0">
        <controls:TooltipBubble.Transitions>
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.3" Easing="CubicEaseOut"/>
            <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3" Easing="CubicEaseOut"/>
          </Transitions>
        </controls:TooltipBubble.Transitions>
      </controls:TooltipBubble>
    </Panel>

    <!-- ============================================ -->
    <!-- History Bottom Sheet Overlay                  -->
    <!-- ============================================ -->

    <!-- Backdrop -->
    <Border Classes="HistoryBackdrop"
            Background="#80000000"
            IsVisible="{Binding CalculatorViewModel.IsHistoryVisible}"
            IsHitTestVisible="{Binding CalculatorViewModel.IsHistoryVisible}"
            PointerPressed="OnHistoryBackdropTapped" />

    <!-- History Panel -->
    <Border Classes="HistoryPanel"
            Classes.Visible="{Binding CalculatorViewModel.IsHistoryVisible}"
            VerticalAlignment="Bottom"
            MaxHeight="500"
            CornerRadius="24,24,0,0"
            Background="{DynamicResource CardBrush}"
            BoxShadow="0 -4 16 0 #40000000"
            IsHitTestVisible="{Binding CalculatorViewModel.IsHistoryVisible}">
      <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!-- Drag Handle -->
        <Border Grid.Row="0"
                Width="40" Height="4"
                CornerRadius="2"
                Background="{DynamicResource TextMutedBrush}"
                Opacity="0.4"
                HorizontalAlignment="Center"
                Margin="0,12,0,8" />

        <!-- Header -->
        <Grid Grid.Row="1"
              ColumnDefinitions="Auto,*,Auto"
              Margin="20,0,12,12">
          <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
            <mi:MaterialIcon Kind="History" Width="22" Height="22"
                             Foreground="{DynamicResource PrimaryBrush}" />
            <TextBlock Text="{Binding CalculatorViewModel.HistoryTitleText}"
                       Classes="TitleMedium"
                       VerticalAlignment="Center" />
          </StackPanel>
          <Button Grid.Column="2"
                  Classes="Text Small"
                  Command="{Binding CalculatorViewModel.HideHistoryCommand}"
                  Padding="8">
            <mi:MaterialIcon Kind="Close" Width="20" Height="20" />
          </Button>
        </Grid>

        <!-- History Entries -->
        <ScrollViewer Grid.Row="2" Margin="0,0,0,0">
          <Panel>
            <!-- Empty State (mit Puls-Animation) -->
            <StackPanel IsVisible="{Binding !CalculatorViewModel.HasHistory}"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Spacing="8"
                        Margin="0,32">
              <mi:MaterialIcon Kind="CalculatorVariantOutline" Width="48" Height="48"
                               Foreground="{DynamicResource TextMutedBrush}"
                               HorizontalAlignment="Center"
                               Opacity="0.4">
                <mi:MaterialIcon.Styles>
                  <Style Selector="mi|MaterialIcon">
                    <Style.Animations>
                      <Animation Duration="0:0:2" IterationCount="INFINITE" PlaybackDirection="Alternate">
                        <KeyFrame Cue="0%">
                          <Setter Property="Opacity" Value="0.3"/>
                        </KeyFrame>
                        <KeyFrame Cue="100%">
                          <Setter Property="Opacity" Value="0.6"/>
                        </KeyFrame>
                      </Animation>
                    </Style.Animations>
                  </Style>
                </mi:MaterialIcon.Styles>
              </mi:MaterialIcon>
              <TextBlock Text="{Binding CalculatorViewModel.NoCalculationsYetText}"
                         Foreground="{DynamicResource TextMutedBrush}"
                         HorizontalAlignment="Center"
                         FontSize="14" />
            </StackPanel>

            <!-- Gruppierte Entries (Heute/Gestern/Älter) -->
            <ItemsControl ItemsSource="{Binding CalculatorViewModel.GroupedHistory}"
                          IsVisible="{Binding CalculatorViewModel.HasHistory}">
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:HistoryGroup">
                  <StackPanel>
                    <!-- Gruppen-Header -->
                    <TextBlock Text="{Binding Header}"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextMutedBrush}"
                               Opacity="0.7"
                               Margin="20,12,20,4"/>

                    <!-- Einträge der Gruppe -->
                    <ItemsControl ItemsSource="{Binding Entries}">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="calc:CalculationHistoryEntry">
                          <Grid ColumnDefinitions="*,Auto"
                                x:Name="HistoryEntryRow">
                            <Grid.RenderTransform>
                              <TranslateTransform X="0"/>
                            </Grid.RenderTransform>
                            <Button Grid.Column="0"
                                    Classes="Text HistoryEntry"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Stretch"
                                    Padding="20,14,4,14"
                                    CornerRadius="0"
                                    Command="{Binding $parent[Border].((vm:MainViewModel)DataContext).CalculatorViewModel.SelectHistoryEntryCommand}"
                                    CommandParameter="{Binding}">
                              <StackPanel Spacing="4">
                                <TextBlock Text="{Binding Expression}"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextMutedBrush}"
                                           TextTrimming="CharacterEllipsis" />
                                <TextBlock Text="{Binding Result}"
                                           FontSize="20"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           TextTrimming="CharacterEllipsis" />
                              </StackPanel>
                            </Button>
                            <!-- Einzelnen Eintrag löschen -->
                            <Button Grid.Column="1"
                                    Classes="Text"
                                    Padding="8"
                                    MinWidth="0"
                                    MinHeight="0"
                                    VerticalAlignment="Center"
                                    Margin="0,0,12,0"
                                    Command="{Binding $parent[Border].((vm:MainViewModel)DataContext).CalculatorViewModel.DeleteHistoryEntryCommand}"
                                    CommandParameter="{Binding}">
                              <mi:MaterialIcon Kind="Close" Width="16" Height="16"
                                               Foreground="{DynamicResource TextMutedBrush}"
                                               Opacity="0.5" />
                            </Button>
                          </Grid>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </Panel>
        </ScrollViewer>

        <!-- Verlauf löschen Button + Bestätigungsdialog -->
        <Border Grid.Row="3" Padding="16,8,16,16"
                IsVisible="{Binding CalculatorViewModel.HasHistory}">
          <Panel>
            <!-- Normaler Löschen-Button -->
            <Button Classes="Outlined Small"
                    Content="{Binding CalculatorViewModel.ClearHistoryText}"
                    Command="{Binding CalculatorViewModel.ClearHistoryCommand}"
                    HorizontalAlignment="Center"
                    IsVisible="{Binding !CalculatorViewModel.ShowClearHistoryConfirm}" />
            <!-- Bestätigungspanel -->
            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Center"
                        IsVisible="{Binding CalculatorViewModel.ShowClearHistoryConfirm}">
              <Button Classes="Primary Small"
                      Content="&#x2714;"
                      Command="{Binding CalculatorViewModel.ConfirmClearHistoryCommand}"
                      Padding="16,6"/>
              <Button Classes="Outlined Small"
                      Content="&#x2716;"
                      Command="{Binding CalculatorViewModel.CancelClearHistoryCommand}"
                      Padding="16,6"/>
            </StackPanel>
          </Panel>
        </Border>

      </Grid>
    </Border>

  </Panel>

</UserControl>
