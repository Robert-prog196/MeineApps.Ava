<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RechnerPlus.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:ctrl="using:RechnerPlus.Controls"
             x:Class="RechnerPlus.Views.CalculatorView"
             x:DataType="vm:CalculatorViewModel">

  <UserControl.Styles>
    <!-- Base calculator button: fills grid cell, larger touch target, centered content -->
    <Style Selector="Button.CalcButton">
      <Setter Property="Height" Value="NaN"/>
      <Setter Property="MinHeight" Value="56"/>
      <Setter Property="CornerRadius" Value="16"/>
      <Setter Property="HorizontalAlignment" Value="Stretch"/>
      <Setter Property="VerticalAlignment" Value="Stretch"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.08"/>
          <BrushTransition Property="Background" Duration="0:0:0.15"/>
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Button.CalcButton:pressed">
      <Setter Property="RenderTransform" Value="scale(0.92)"/>
    </Style>

    <!-- Digit button styling (fast transparent, glasmorphism-ähnlich) -->
    <Style Selector="Button.Digit">
      <Setter Property="Background" Value="{DynamicResource DigitButtonBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
      <Setter Property="FontSize" Value="24"/>
      <Setter Property="FontWeight" Value="Bold"/>
    </Style>
    <Style Selector="Button.Digit:pointerover">
      <Setter Property="Background" Value="{DynamicResource DigitButtonHoverBrush}"/>
    </Style>

    <!-- Operator button styling -->
    <Style Selector="Button.Operator">
      <Setter Property="FontSize" Value="24"/>
      <Setter Property="FontWeight" Value="Bold"/>
    </Style>

    <!-- Aktiver Operator: invertierte Farben + auffälliger Border -->
    <Style Selector="Button.ActiveOp">
      <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource PrimaryContrastBrush}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHoverBrush}"/>
      <Setter Property="BorderThickness" Value="2"/>
    </Style>

    <!-- Scientific function button styling -->
    <Style Selector="Button.Function">
      <Setter Property="FontSize" Value="13"/>
      <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.08"/>
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Button.Function:pressed">
      <Setter Property="RenderTransform" Value="scale(0.92)"/>
    </Style>

    <!-- INV-Button aktiv -->
    <Style Selector="Button.InvActive">
      <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
    </Style>

    <!-- Equals-Button: Gradient + Auffällig -->
    <Style Selector="Button.Equals">
      <Setter Property="FontSize" Value="28"/>
      <Setter Property="FontWeight" Value="ExtraBold"/>
      <Setter Property="Background" Value="{DynamicResource EqualsGradientBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource PrimaryContrastBrush}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHoverBrush}"/>
      <Setter Property="BorderThickness" Value="1"/>
    </Style>

    <!-- Memory-Row: dezent wenn leer, volle Sichtbarkeit wenn aktiv -->
    <Style Selector="Grid.MemoryRow">
      <Setter Property="Opacity" Value="0.4"/>
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.2"/>
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Grid.MemoryActive">
      <Setter Property="Opacity" Value="1"/>
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,Auto,Auto,Auto,*" Margin="16">

    <!-- ============================================ -->
    <!-- 1. Display Area                              -->
    <!-- ============================================ -->
    <Border Grid.Row="0"
            Background="{DynamicResource DisplayGradientBrush}"
            CornerRadius="16"
            Padding="16"
            Margin="0,0,0,8"
            x:Name="DisplayBorder">
      <Grid RowDefinitions="Auto,Auto,Auto,Auto">
        <!-- Expression line mit Copy + Backspace-Button -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto,Auto">
          <TextBlock Grid.Column="0"
                     Text="M"
                     FontSize="13"
                     FontWeight="Bold"
                     Foreground="{DynamicResource PrimaryBrush}"
                     IsVisible="{Binding HasMemory}"
                     VerticalAlignment="Center"
                     Margin="0,0,6,0"
                     ToolTip.Tip="{Binding MemoryDisplay}"/>
          <ctrl:ExpressionHighlightControl Grid.Column="1"
                     x:Name="ExpressionText"
                     Expression="{Binding Expression}"
                     FontSize="14"
                     Foreground="{DynamicResource TextMutedBrush}"
                     HorizontalAlignment="Right"
                     VerticalAlignment="Center"
                     MinHeight="20"
                     TextTrimming="CharacterEllipsis"/>
          <Button Grid.Column="2"
                  Classes="Text"
                  Padding="8,4"
                  MinWidth="0"
                  MinHeight="0"
                  Command="{Binding ShareDisplayCommand}"
                  ToolTip.Tip="Share">
            <mi:MaterialIcon Kind="ShareVariantOutline" Width="16" Height="16"
                             Foreground="{DynamicResource TextMutedBrush}"
                             Opacity="0.6"/>
          </Button>
          <Button Grid.Column="3"
                  Classes="Text"
                  Padding="8,4"
                  MinWidth="0"
                  MinHeight="0"
                  Command="{Binding CopyDisplayCommand}"
                  ToolTip.Tip="Copy">
            <mi:MaterialIcon Kind="ContentCopy" Width="16" Height="16"
                             Foreground="{DynamicResource TextMutedBrush}"
                             Opacity="0.6"/>
          </Button>
          <Button Grid.Column="4"
                  Classes="Text"
                  Padding="8,4"
                  MinWidth="0"
                  MinHeight="0"
                  Command="{Binding BackspaceCommand}">
            <mi:MaterialIcon Kind="BackspaceOutline" Width="20" Height="20"
                             Foreground="{DynamicResource TextMutedBrush}"/>
          </Button>
        </Grid>

        <!-- Main display (größere Schrift, Animation via Code-Behind) -->
        <TextBlock Grid.Row="1"
                   x:Name="DisplayText"
                   Text="{Binding Display}"
                   FontSize="{Binding DisplayFontSize}"
                   FontFamily="JetBrains Mono, Consolas, monospace"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   HorizontalAlignment="Right"
                   Margin="0,4,0,0"
                   TextTrimming="CharacterEllipsis"
                   RenderTransformOrigin="1,0.5">
          <TextBlock.Transitions>
            <Transitions>
              <DoubleTransition Property="Opacity" Duration="0:0:0.2" Easing="CubicEaseOut"/>
            </Transitions>
          </TextBlock.Transitions>
        </TextBlock>

        <!-- Live Preview -->
        <TextBlock Grid.Row="2"
                   Text="{Binding PreviewResult}"
                   FontSize="16"
                   Foreground="{DynamicResource TextMutedBrush}"
                   Opacity="0.6"
                   HorizontalAlignment="Right"
                   MinHeight="20"
                   Margin="0,0,0,2"
                   IsVisible="{Binding PreviewResult, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

        <!-- Error message -->
        <TextBlock Grid.Row="3"
                   Text="{Binding ErrorMessage}"
                   FontSize="12"
                   Foreground="{DynamicResource ErrorBrush}"
                   IsVisible="{Binding HasError}"
                   HorizontalAlignment="Right"/>
      </Grid>
    </Border>

    <!-- ============================================ -->
    <!-- 2. Mode Selector + INV + Angle Mode          -->
    <!-- ============================================ -->
    <Grid Grid.Row="1"
          ColumnDefinitions="Auto,Auto,*,Auto,Auto"
          Margin="0,0,0,8">

      <!-- Basic mode button -->
      <Button Grid.Column="0"
              Classes="Primary Small"
              Content="{Binding ModeBasicText}"
              IsVisible="{Binding IsBasicMode}"
              Command="{Binding SetModeCommand}"
              CommandParameter="{x:Static vm:CalculatorMode.Basic}"
              Margin="0,0,6,0"/>
      <Button Grid.Column="0"
              Classes="Outlined Small"
              Content="{Binding ModeBasicText}"
              IsVisible="{Binding !IsBasicMode}"
              Command="{Binding SetModeCommand}"
              CommandParameter="{x:Static vm:CalculatorMode.Basic}"
              Margin="0,0,6,0"/>

      <!-- Scientific mode button -->
      <Button Grid.Column="1"
              Classes="Primary Small"
              Content="{Binding ModeScientificText}"
              IsVisible="{Binding IsScientificMode}"
              Command="{Binding SetModeCommand}"
              CommandParameter="{x:Static vm:CalculatorMode.Scientific}"/>
      <Button Grid.Column="1"
              Classes="Outlined Small"
              Content="{Binding ModeScientificText}"
              IsVisible="{Binding !IsScientificMode}"
              Command="{Binding SetModeCommand}"
              CommandParameter="{x:Static vm:CalculatorMode.Scientific}"/>

      <!-- INV toggle (nur im Scientific Mode sichtbar) -->
      <Button Grid.Column="3"
              Classes="Outlined Small"
              Classes.InvActive="{Binding IsInverseMode}"
              Content="INV"
              Command="{Binding ToggleInverseCommand}"
              IsVisible="{Binding IsScientificMode}"
              Margin="0,0,6,0"/>

      <!-- Angle mode toggle (right-aligned) -->
      <Button Grid.Column="4"
              Classes="Text Small"
              Content="{Binding AngleModeText}"
              Command="{Binding ToggleAngleModeCommand}"/>
    </Grid>

    <!-- ============================================ -->
    <!-- 3. Scientific Functions Panel (Slide-Animation) -->
    <!-- ============================================ -->
    <Grid Grid.Row="2"
          RowDefinitions="Auto,Auto,Auto"
          ColumnDefinitions="*,*,*,*,*"
          RowSpacing="6"
          ColumnSpacing="6"
          Margin="0,0,0,8"
          Classes.ScientificVisible="{Binding IsScientificMode}"
          Opacity="0"
          MaxHeight="0"
          IsHitTestVisible="False">
      <Grid.Styles>
        <Style Selector="Grid">
          <Setter Property="Transitions">
            <Transitions>
              <DoubleTransition Property="Opacity" Duration="0:0:0.2"/>
              <DoubleTransition Property="MaxHeight" Duration="0:0:0.25" Easing="CubicEaseOut"/>
            </Transitions>
          </Setter>
        </Style>
        <Style Selector="Grid.ScientificVisible">
          <Setter Property="Opacity" Value="1"/>
          <Setter Property="MaxHeight" Value="500"/>
          <Setter Property="IsHitTestVisible" Value="True"/>
        </Style>
      </Grid.Styles>

      <!-- Row 0: sin/asin, cos/acos, tan/atan, log/10^x, ln/e^x -->
      <Button Grid.Row="0" Grid.Column="0" Content="{Binding SinButtonText}"
              Classes="Outlined Small Function"
              Command="{Binding SinOrInverseCommand}"/>
      <Button Grid.Row="0" Grid.Column="1" Content="{Binding CosButtonText}"
              Classes="Outlined Small Function"
              Command="{Binding CosOrInverseCommand}"/>
      <Button Grid.Row="0" Grid.Column="2" Content="{Binding TanButtonText}"
              Classes="Outlined Small Function"
              Command="{Binding TanOrInverseCommand}"/>
      <Button Grid.Row="0" Grid.Column="3" Content="{Binding LogButtonText}"
              Classes="Outlined Small Function"
              Command="{Binding LogOrInverseCommand}"/>
      <Button Grid.Row="0" Grid.Column="4" Content="{Binding LnButtonText}"
              Classes="Outlined Small Function"
              Command="{Binding LnOrInverseCommand}"/>

      <!-- Row 1: (, ), x^y, 1/x, |x| -->
      <Button Grid.Row="1" Grid.Column="0" Content="("
              Classes="Outlined Small Function"
              Command="{Binding InputParenthesisCommand}"
              CommandParameter="("/>
      <Button Grid.Row="1" Grid.Column="1" Content=")"
              Classes="Outlined Small Function"
              Command="{Binding InputParenthesisCommand}"
              CommandParameter=")"/>
      <Button Grid.Row="1" Grid.Column="2" Content="x&#x02B8;"
              Classes="Outlined Small Function"
              Command="{Binding PowerCommand}"/>
      <Button Grid.Row="1" Grid.Column="3" Content="1/x"
              Classes="Outlined Small Function"
              Command="{Binding ReciprocalCommand}"/>
      <Button Grid.Row="1" Grid.Column="4" Content="Ans"
              Classes="Outlined Small Function"
              Command="{Binding AnsCommand}"/>

      <!-- Row 2: pi, e, x^2, sqrt(x), x! -->
      <Button Grid.Row="2" Grid.Column="0" Content="&#x03C0;"
              Classes="Outlined Small Function"
              Command="{Binding PiCommand}"/>
      <Button Grid.Row="2" Grid.Column="1" Content="e"
              Classes="Outlined Small Function"
              Command="{Binding EulerCommand}"/>
      <Button Grid.Row="2" Grid.Column="2" Content="x&#x00B2;"
              Classes="Outlined Small Function"
              Command="{Binding SquareCommand}"/>
      <Button Grid.Row="2" Grid.Column="3" Content="&#x221A;x"
              Classes="Outlined Small Function"
              Command="{Binding SquareRootCommand}"/>
      <Button Grid.Row="2" Grid.Column="4" Content="x!"
              Classes="Outlined Small Function"
              Command="{Binding FactorialCommand}"/>
    </Grid>

    <!-- ============================================ -->
    <!-- 4. Memory Row (dezent wenn leer)             -->
    <!-- ============================================ -->
    <Grid Grid.Row="3"
          Classes="MemoryRow"
          Classes.MemoryActive="{Binding HasMemory}"
          ColumnDefinitions="*,*,*,*,*"
          ColumnSpacing="6"
          Margin="0,0,0,8">

      <Button Grid.Column="0" Content="MC"
              Classes="Text Small"
              Command="{Binding MemoryClearCommand}"/>
      <Button Grid.Column="1" Content="MR"
              Classes="Text Small"
              Command="{Binding MemoryRecallCommand}"/>
      <Button Grid.Column="2" Content="M+"
              Classes="Text Small"
              Command="{Binding MemoryAddCommand}"/>
      <Button Grid.Column="3" Content="M-"
              Classes="Text Small"
              Command="{Binding MemorySubtractCommand}"/>
      <Button Grid.Column="4" Content="MS"
              Classes="Text Small"
              Command="{Binding MemoryStoreCommand}"/>
    </Grid>

    <!-- ============================================ -->
    <!-- 5. Main Calculator Button Grid               -->
    <!-- ============================================ -->
    <Grid Grid.Row="4"
          RowDefinitions="*,*,*,*,*"
          ColumnDefinitions="*,*,*,*"
          RowSpacing="8"
          ColumnSpacing="8">

      <!-- Row 0: C, ( ), %, ÷ -->
      <Button Grid.Row="0" Grid.Column="0"
              Content="C"
              Classes="Secondary CalcButton"
              FontSize="18"
              FontWeight="SemiBold"
              Command="{Binding ClearCommand}"/>
      <Button Grid.Row="0" Grid.Column="1"
              Content="( )"
              Classes="Outlined CalcButton"
              FontSize="18"
              Command="{Binding InputSmartParenthesisCommand}"/>
      <Button Grid.Row="0" Grid.Column="2"
              Content="%"
              Classes="Outlined CalcButton"
              FontSize="18"
              Command="{Binding PercentCommand}"/>
      <Button Grid.Row="0" Grid.Column="3"
              Content="&#x00F7;"
              Classes="Primary Operator CalcButton"
              Classes.ActiveOp="{Binding IsDivideActive}"
              Command="{Binding InputOperatorCommand}"
              CommandParameter="&#x00F7;"/>

      <!-- Row 1: 7, 8, 9, Multiply -->
      <Button Grid.Row="1" Grid.Column="0"
              Content="7"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="7"/>
      <Button Grid.Row="1" Grid.Column="1"
              Content="8"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="8"/>
      <Button Grid.Row="1" Grid.Column="2"
              Content="9"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="9"/>
      <Button Grid.Row="1" Grid.Column="3"
              Content="&#x00D7;"
              Classes="Primary Operator CalcButton"
              Classes.ActiveOp="{Binding IsMultiplyActive}"
              Command="{Binding InputOperatorCommand}"
              CommandParameter="&#x00D7;"/>

      <!-- Row 2: 4, 5, 6, Subtract -->
      <Button Grid.Row="2" Grid.Column="0"
              Content="4"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="4"/>
      <Button Grid.Row="2" Grid.Column="1"
              Content="5"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="5"/>
      <Button Grid.Row="2" Grid.Column="2"
              Content="6"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="6"/>
      <Button Grid.Row="2" Grid.Column="3"
              Content="&#x2212;"
              Classes="Primary Operator CalcButton"
              Classes.ActiveOp="{Binding IsSubtractActive}"
              Command="{Binding InputOperatorCommand}"
              CommandParameter="&#x2212;"/>

      <!-- Row 3: 1, 2, 3, Add -->
      <Button Grid.Row="3" Grid.Column="0"
              Content="1"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="1"/>
      <Button Grid.Row="3" Grid.Column="1"
              Content="2"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="2"/>
      <Button Grid.Row="3" Grid.Column="2"
              Content="3"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="3"/>
      <Button Grid.Row="3" Grid.Column="3"
              Content="+"
              Classes="Primary Operator CalcButton"
              Classes.ActiveOp="{Binding IsAddActive}"
              Command="{Binding InputOperatorCommand}"
              CommandParameter="+"/>

      <!-- Row 4: Negate, 0, Decimal, Equals -->
      <Button Grid.Row="4" Grid.Column="0"
              Content="&#x00B1;"
              Classes="Digit CalcButton"
              Command="{Binding NegateCommand}"/>
      <Button Grid.Row="4" Grid.Column="1"
              Content="0"
              Classes="Digit CalcButton"
              Command="{Binding InputDigitCommand}"
              CommandParameter="0"/>
      <Button Grid.Row="4" Grid.Column="2"
              Content="{Binding DecimalButtonText}"
              Classes="Digit CalcButton"
              Command="{Binding InputDecimalCommand}"/>
      <Button Grid.Row="4" Grid.Column="3"
              x:Name="EqualsButton"
              Content="="
              Classes="Primary Operator CalcButton Equals"
              Command="{Binding CalculateCommand}"/>
    </Grid>

  </Grid>

</UserControl>
