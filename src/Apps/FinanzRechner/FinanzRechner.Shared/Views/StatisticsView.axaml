<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FinanzRechner.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             x:Class="FinanzRechner.Views.StatisticsView"
             x:DataType="vm:StatisticsViewModel">

  <Grid RowDefinitions="Auto,Auto,*" Margin="16">

    <!-- Header -->
    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,8,0,16">
      <TextBlock Grid.Column="0"
                 Text="{Binding StatisticsTitleText}"
                 Classes="PageTitle"
                 VerticalAlignment="Center" />

      <!-- Export Button -->
      <Button Grid.Column="1" Classes="Text"
              Command="{Binding ExportToPdfCommand}"
              Width="48" Height="48" Padding="0">
        <mi:MaterialIcon Kind="Export" Width="22" Height="22"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
      </Button>
    </Grid>

    <!-- Time Period Selection -->
    <Border Grid.Row="1"
            Background="{DynamicResource CardBrush}"
            CornerRadius="12"
            Padding="16"
            Margin="0,0,0,16">
      <StackPanel Spacing="12">

        <!-- Period Buttons -->
        <WrapPanel>
          <!-- Week -->
          <Panel Margin="0,0,4,4">
            <Button Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding IsWeekSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Week">
              <TextBlock Text="{Binding WeekText}" Foreground="White" FontSize="12" />
            </Button>
            <Button Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding !IsWeekSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Week">
              <TextBlock Text="{Binding WeekText}" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12" />
            </Button>
          </Panel>

          <!-- Month -->
          <Panel Margin="0,0,4,4">
            <Button Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding IsMonthSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Month">
              <TextBlock Text="{Binding MonthText}" Foreground="White" FontSize="12" />
            </Button>
            <Button Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding !IsMonthSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Month">
              <TextBlock Text="{Binding MonthText}" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12" />
            </Button>
          </Panel>

          <!-- Quarter -->
          <Panel Margin="0,0,4,4">
            <Button Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding IsQuarterSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Quarter">
              <TextBlock Text="{Binding QuarterText}" Foreground="White" FontSize="12" />
            </Button>
            <Button Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding !IsQuarterSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Quarter">
              <TextBlock Text="{Binding QuarterText}" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12" />
            </Button>
          </Panel>

          <!-- Half Year -->
          <Panel Margin="0,0,4,4">
            <Button Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding IsHalfYearSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="HalfYear">
              <TextBlock Text="{Binding HalfYearText}" Foreground="White" FontSize="12" />
            </Button>
            <Button Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding !IsHalfYearSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="HalfYear">
              <TextBlock Text="{Binding HalfYearText}" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12" />
            </Button>
          </Panel>

          <!-- Year -->
          <Panel Margin="0,0,4,4">
            <Button Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding IsYearSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Year">
              <TextBlock Text="{Binding YearText}" Foreground="White" FontSize="12" />
            </Button>
            <Button Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12,8"
                    IsVisible="{Binding !IsYearSelected}"
                    Command="{Binding SelectPeriodCommand}" CommandParameter="Year">
              <TextBlock Text="{Binding YearText}" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12" />
            </Button>
          </Panel>
        </WrapPanel>

        <!-- Period Navigation -->
        <Grid ColumnDefinitions="Auto,*,Auto">
          <Button Grid.Column="0" Classes="Text"
                  Command="{Binding PreviousPeriodCommand}"
                  Padding="8">
            <mi:MaterialIcon Kind="ChevronLeft" Width="20" Height="20"
                             Foreground="{DynamicResource PrimaryBrush}" />
          </Button>

          <StackPanel Grid.Column="1" HorizontalAlignment="Center">
            <TextBlock Text="{Binding PeriodLabel}"
                       FontSize="16" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />
            <Button Classes="Text" Padding="4,2" HorizontalAlignment="Center"
                    Command="{Binding GoToTodayCommand}">
              <TextBlock Text="{Binding TodayText}"
                         FontSize="12"
                         Foreground="{DynamicResource PrimaryBrush}"
                         TextDecorations="Underline" />
            </Button>
          </StackPanel>

          <Button Grid.Column="2" Classes="Text"
                  Command="{Binding NextPeriodCommand}"
                  Padding="8">
            <mi:MaterialIcon Kind="ChevronRight" Width="20" Height="20"
                             Foreground="{DynamicResource PrimaryBrush}" />
          </Button>
        </Grid>

        <!-- Summary -->
        <StackPanel Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
            <TextBlock Text="{Binding IncomeLabelText}" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}" />
            <TextBlock Text="{Binding TotalIncomeDisplay}" FontSize="14" FontWeight="Bold" Foreground="{DynamicResource IncomeBrush}" />
          </StackPanel>

          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
            <TextBlock Text="{Binding ExpensesLabelText}" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}" />
            <TextBlock Text="{Binding TotalExpensesDisplay}" FontSize="14" FontWeight="Bold" Foreground="{DynamicResource ExpenseBrush}" />
          </StackPanel>

          <Border Background="{DynamicResource AccentBrush}"
                  CornerRadius="8"
                  Padding="8,4"
                  HorizontalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="{Binding BalanceLabelText}" FontSize="16" FontWeight="Bold" Foreground="White" />
              <TextBlock Text="{Binding BalanceDisplay}" FontSize="16" FontWeight="Bold" Foreground="White" />
            </StackPanel>
          </Border>
        </StackPanel>
      </StackPanel>
    </Border>

    <!-- Charts ScrollView -->
    <ScrollViewer Grid.Row="2">
      <StackPanel Spacing="16">

        <!-- Empty State: No Data -->
        <StackPanel IsVisible="{Binding HasNoData}"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Spacing="8" Margin="0,40,0,0">
          <mi:MaterialIcon Kind="ChartBar" Width="48" Height="48"
                           Foreground="{DynamicResource TextMutedBrush}"
                           HorizontalAlignment="Center" />
          <TextBlock Text="{Binding NoStatsTitleText}"
                     FontSize="16" FontWeight="Bold"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center" />
          <TextBlock Text="{Binding NoStatsDescText}"
                     FontSize="13"
                     Foreground="{DynamicResource TextMutedBrush}"
                     HorizontalAlignment="Center" />
        </StackPanel>

        <!-- Expenses PieChart -->
        <Border Background="{DynamicResource CardBrush}"
                CornerRadius="12"
                Padding="16"
                IsVisible="{Binding HasExpenseData}">
          <StackPanel Spacing="12">
            <TextBlock Text="{Binding ExpensesByCategoryText}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

            <lvc:PieChart Series="{Binding ExpenseChartSeries}"
                          Height="250"
                          LegendPosition="Right"
                          InitialRotation="-90" />
          </StackPanel>
        </Border>

        <!-- Expenses by Category (Details) -->
        <Border Background="{DynamicResource CardBrush}"
                CornerRadius="12"
                Padding="16"
                IsVisible="{Binding HasExpenseData}">
          <StackPanel Spacing="12">
            <TextBlock Text="{Binding CategoryBreakdownText}"
                       FontSize="16"
                       Foreground="{DynamicResource TextSecondaryBrush}" />

            <ItemsControl ItemsSource="{Binding ExpensesByCategory}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <StackPanel Spacing="4" Margin="0,0,0,8">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                      <TextBlock Grid.Column="0"
                                 Text="{Binding CategoryIcon}"
                                 FontSize="20"
                                 VerticalAlignment="Center"
                                 Margin="0,0,8,0" />
                      <TextBlock Grid.Column="1"
                                 Text="{Binding CategoryName}"
                                 FontSize="14"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center" />
                      <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding AmountDisplay}"
                                   FontSize="14" FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center" />
                        <TextBlock Text="{Binding PercentageDisplay}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   VerticalAlignment="Center" />
                      </StackPanel>
                    </Grid>
                    <Border Background="{DynamicResource ExpenseBrush}"
                            Height="8"
                            HorizontalAlignment="Left"
                            CornerRadius="4" />
                  </StackPanel>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>

        <!-- Income PieChart -->
        <Border Background="{DynamicResource CardBrush}"
                CornerRadius="12"
                Padding="16"
                IsVisible="{Binding HasIncomeData}">
          <StackPanel Spacing="12">
            <TextBlock Text="{Binding IncomeByCategoryText}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

            <lvc:PieChart Series="{Binding IncomeChartSeries}"
                          Height="250"
                          LegendPosition="Right"
                          InitialRotation="-90" />
          </StackPanel>
        </Border>

        <!-- 6-Month Trend LineChart -->
        <Border Background="{DynamicResource CardBrush}"
                CornerRadius="12"
                Padding="16">
          <StackPanel Spacing="12">
            <TextBlock Text="{Binding TrendOverviewText}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

            <!-- Month Comparison -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,0,0,8">
              <Border Grid.Column="0"
                      Background="{DynamicResource SurfaceBrush}"
                      CornerRadius="8"
                      Padding="12">
                <StackPanel Spacing="4">
                  <TextBlock Text="{Binding LastMonthText}" FontSize="12"
                             Foreground="{DynamicResource TextSecondaryBrush}" />
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding LastMonthExpensesDisplay}"
                               FontSize="14" FontWeight="Bold"
                               Foreground="{DynamicResource ExpenseBrush}" />
                    <TextBlock Text="{Binding ExpensesTrend}"
                               FontSize="12"
                               Foreground="{DynamicResource TextMutedBrush}" />
                  </StackPanel>
                </StackPanel>
              </Border>
              <Border Grid.Column="1"
                      Background="{DynamicResource SurfaceBrush}"
                      CornerRadius="8"
                      Padding="12">
                <StackPanel Spacing="4">
                  <TextBlock Text="{Binding LastMonthText}" FontSize="12"
                             Foreground="{DynamicResource TextSecondaryBrush}" />
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding LastMonthIncomeDisplay}"
                               FontSize="14" FontWeight="Bold"
                               Foreground="{DynamicResource IncomeBrush}" />
                    <TextBlock Text="{Binding IncomeTrend}"
                               FontSize="12"
                               Foreground="{DynamicResource TextMutedBrush}" />
                  </StackPanel>
                </StackPanel>
              </Border>
            </Grid>

            <!-- Trend Chart -->
            <lvc:CartesianChart Series="{Binding TrendChartSeries}"
                                XAxes="{Binding TrendXAxes}"
                                YAxes="{Binding TrendYAxes}"
                                Height="200"
                                ZoomMode="None"
                                TooltipPosition="Top" />

            <!-- Legend -->
            <StackPanel Orientation="Horizontal" Spacing="16" HorizontalAlignment="Center">
              <StackPanel Orientation="Horizontal" Spacing="4">
                <Border Background="{DynamicResource IncomeBrush}" Width="16" Height="4"
                        CornerRadius="2" VerticalAlignment="Center" />
                <TextBlock Text="{Binding IncomeText}" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" />
              </StackPanel>
              <StackPanel Orientation="Horizontal" Spacing="4">
                <Border Background="{DynamicResource ExpenseBrush}" Width="16" Height="4"
                        CornerRadius="2" VerticalAlignment="Center" />
                <TextBlock Text="{Binding ExpensesText}" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" />
              </StackPanel>
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Bottom Spacer (60dp fuer Ad-Banner Overlay) -->
        <Border Height="60" />

      </StackPanel>
    </ScrollViewer>

    <!-- Loading Indicator -->
    <ProgressBar Grid.Row="2"
                 IsIndeterminate="True"
                 IsVisible="{Binding IsLoading}"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Center" />

    <!-- PDF Export Indicator -->
    <Border Grid.RowSpan="3"
            IsVisible="{Binding IsExportingPdf}"
            Background="#80000000"
            ZIndex="100">
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
        <ProgressBar IsIndeterminate="True" Width="48" />
        <TextBlock Text="{Binding ExportingPdfText}"
                   FontSize="16"
                   Foreground="White"
                   HorizontalAlignment="Center" />
      </StackPanel>
    </Border>

    <!-- Export Ad Overlay -->
    <Border Grid.RowSpan="3"
            IsVisible="{Binding ShowExportAdOverlay}"
            Background="#CC000000"
            ZIndex="150">
      <Border Background="{DynamicResource CardBrush}"
              CornerRadius="16"
              Padding="24"
              MaxWidth="340"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock Text="{Binding ExportLockedText}"
                     FontSize="22" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />

          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="30"
                  Width="60" Height="60"
                  HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="Export" Width="32" Height="32"
                             Foreground="{DynamicResource AccentBrush}" />
          </Border>

          <TextBlock Text="{Binding ExportLockedDescText}"
                     FontSize="14"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     TextWrapping="Wrap"
                     TextAlignment="Center" />

          <StackPanel Spacing="8">
            <Button Classes="Filled"
                    Command="{Binding ConfirmExportAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="16,12">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Video" Width="20" Height="20" />
                <TextBlock Text="{Binding WatchVideoExportText}"
                           FontSize="15" FontWeight="SemiBold" />
              </StackPanel>
            </Button>

            <Button Classes="Text"
                    Command="{Binding CancelExportAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,10">
              <TextBlock Text="{loc:Translate Cancel}"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Extended Stats Ad Overlay -->
    <Border Grid.RowSpan="3"
            IsVisible="{Binding ShowExtendedStatsAdOverlay}"
            Background="#CC000000"
            ZIndex="160">
      <Border Background="{DynamicResource CardBrush}"
              CornerRadius="16"
              Padding="24"
              MaxWidth="340"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock Text="{Binding ExtendedStatsTitleText}"
                     FontSize="22" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />

          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="30"
                  Width="60" Height="60"
                  HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="ChartTimelineVariant" Width="32" Height="32"
                             Foreground="{DynamicResource AccentBrush}" />
          </Border>

          <TextBlock Text="{Binding ExtendedStatsDescText}"
                     FontSize="14"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     TextWrapping="Wrap"
                     TextAlignment="Center" />

          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="8" Padding="10,6"
                  HorizontalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="Clock" Width="16" Height="16"
                               Foreground="{DynamicResource AccentBrush}" />
              <TextBlock Text="{Binding AccessFor24hText}"
                         FontSize="13" FontWeight="SemiBold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
            </StackPanel>
          </Border>

          <StackPanel Spacing="8">
            <Button Classes="Filled"
                    Command="{Binding ConfirmExtendedStatsAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="16,12">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Video" Width="20" Height="20" />
                <TextBlock Text="{Binding WatchVideoExportText}"
                           FontSize="15" FontWeight="SemiBold" />
              </StackPanel>
            </Button>

            <Button Classes="Text"
                    Command="{Binding CancelExtendedStatsAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,10">
              <TextBlock Text="{loc:Translate Cancel}"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Export Status Toast -->
    <Border Grid.RowSpan="3"
            IsVisible="{Binding IsExportStatusVisible}"
            Background="{DynamicResource CardBrush}"
            CornerRadius="8"
            Padding="12,8"
            HorizontalAlignment="Center"
            VerticalAlignment="Bottom"
            Margin="0,0,0,16"
            ZIndex="200">
      <StackPanel Orientation="Horizontal" Spacing="8">
        <mi:MaterialIcon Kind="CheckCircle" Width="18" Height="18"
                         Foreground="{DynamicResource PrimaryBrush}" />
        <TextBlock Text="{Binding ExportStatusMessage}"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   FontSize="13" VerticalAlignment="Center" />
      </StackPanel>
    </Border>

  </Grid>

</UserControl>
