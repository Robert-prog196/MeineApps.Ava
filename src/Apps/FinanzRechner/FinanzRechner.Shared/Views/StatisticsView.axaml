<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FinanzRechner.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:conv="using:FinanzRechner.Converters"
             xmlns:skia="using:Avalonia.Labs.Controls"
             x:Class="FinanzRechner.Views.StatisticsView"
             x:DataType="vm:StatisticsViewModel">

  <!-- Styles aus ModernCardStyles.axaml (global) -->

  <Grid AutomationProperties.AutomationId="Stats_Root" RowDefinitions="Auto,Auto,Auto,*" Margin="16,8,16,0">

    <!-- ═══ Row 0: Header (Titel + Period-Navigation + Export) ═══ -->
    <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,4,0,10"
          AutomationProperties.AutomationId="Statistics_Panel_Header">
      <!-- Titel -->
      <TextBlock Grid.Column="0"
                 AutomationProperties.AutomationId="Stats_TxtTitle"
                 Text="{Binding StatisticsTitleText}"
                 FontSize="22" FontWeight="Bold"
                 Foreground="{DynamicResource TextPrimaryBrush}"
                 VerticalAlignment="Center" />

      <!-- Period-Navigation: < Februar 2026 > + Heute -->
      <StackPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                  AutomationProperties.AutomationId="Statistics_Panel_PeriodNav">
        <Grid ColumnDefinitions="Auto,*,Auto">
          <Button Grid.Column="0" Classes="Text"
                  AutomationProperties.AutomationId="Stats_BtnPreviousPeriod"
                  Command="{Binding PreviousPeriodCommand}"
                  Padding="6" VerticalAlignment="Center">
            <mi:MaterialIcon Kind="ChevronLeft" Width="18" Height="18"
                             AutomationProperties.AutomationId="Statistics_Icon_PrevPeriod"
                             Foreground="{DynamicResource PrimaryBrush}" />
          </Button>

          <StackPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center">
            <TextBlock AutomationProperties.AutomationId="Stats_TxtPeriodLabel"
                       Text="{Binding PeriodLabel}"
                       FontSize="14" FontWeight="SemiBold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />
            <Button AutomationProperties.AutomationId="Stats_BtnToday"
                    Classes="Text" Padding="2,0" HorizontalAlignment="Center"
                    Command="{Binding GoToTodayCommand}">
              <TextBlock AutomationProperties.AutomationId="Stats_TxtToday"
                         Text="{Binding TodayText}"
                         FontSize="11"
                         Foreground="{DynamicResource PrimaryBrush}"
                         TextDecorations="Underline" />
            </Button>
          </StackPanel>

          <Button Grid.Column="2" Classes="Text"
                  AutomationProperties.AutomationId="Stats_BtnNextPeriod"
                  Command="{Binding NextPeriodCommand}"
                  Padding="6" VerticalAlignment="Center">
            <mi:MaterialIcon Kind="ChevronRight" Width="18" Height="18"
                             AutomationProperties.AutomationId="Statistics_Icon_NextPeriod"
                             Foreground="{DynamicResource PrimaryBrush}" />
          </Button>
        </Grid>
      </StackPanel>

      <!-- Export Button -->
      <Button Grid.Column="2" Classes="Text"
              AutomationProperties.AutomationId="Stats_BtnExport"
              Command="{Binding ExportToPdfCommand}"
              Width="40" Height="40" Padding="0"
              VerticalAlignment="Center">
        <mi:MaterialIcon Kind="Export" Width="20" Height="20"
                         AutomationProperties.AutomationId="Statistics_Icon_Export"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
      </Button>
    </Grid>

    <!-- ═══ Row 1: Period-Chips (kompakte Pill-Leiste) ═══ -->
    <Border Grid.Row="1"
            AutomationProperties.AutomationId="Stats_SectionPeriodChips"
            Background="{DynamicResource SurfaceBrush}"
            CornerRadius="20"
            Padding="4"
            Margin="0,0,0,10">
      <WrapPanel HorizontalAlignment="Center"
                 AutomationProperties.AutomationId="Statistics_Panel_PeriodChips">
        <!-- Woche -->
        <Panel Margin="2">
          <Button AutomationProperties.AutomationId="Stats_ChipWeekSelected"
                  Background="{DynamicResource PrimaryBrush}" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding IsWeekSelected}"
                  RenderTransformOrigin="50%,50%" RenderTransform="scale(1.05,1.05)"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Week">
            <TextBlock Text="{Binding WeekText}" AutomationProperties.AutomationId="Statistics_Txt_WeekSelected" Foreground="White" FontSize="12" FontWeight="SemiBold" />
          </Button>
          <Button AutomationProperties.AutomationId="Stats_ChipWeekUnselected"
                  Background="Transparent" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding !IsWeekSelected}"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Week">
            <TextBlock Text="{Binding WeekText}" AutomationProperties.AutomationId="Statistics_Txt_WeekUnselected" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
          </Button>
        </Panel>

        <!-- Monat -->
        <Panel Margin="2">
          <Button AutomationProperties.AutomationId="Stats_ChipMonthSelected"
                  Background="{DynamicResource PrimaryBrush}" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding IsMonthSelected}"
                  RenderTransformOrigin="50%,50%" RenderTransform="scale(1.05,1.05)"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Month">
            <TextBlock Text="{Binding MonthText}" AutomationProperties.AutomationId="Statistics_Txt_MonthSelected" Foreground="White" FontSize="12" FontWeight="SemiBold" />
          </Button>
          <Button AutomationProperties.AutomationId="Stats_ChipMonthUnselected"
                  Background="Transparent" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding !IsMonthSelected}"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Month">
            <TextBlock Text="{Binding MonthText}" AutomationProperties.AutomationId="Statistics_Txt_MonthUnselected" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
          </Button>
        </Panel>

        <!-- Quartal -->
        <Panel Margin="2">
          <Button AutomationProperties.AutomationId="Stats_ChipQuarterSelected"
                  Background="{DynamicResource PrimaryBrush}" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding IsQuarterSelected}"
                  RenderTransformOrigin="50%,50%" RenderTransform="scale(1.05,1.05)"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Quarter">
            <TextBlock Text="{Binding QuarterText}" AutomationProperties.AutomationId="Statistics_Txt_QuarterSelected" Foreground="White" FontSize="12" FontWeight="SemiBold" />
          </Button>
          <Button AutomationProperties.AutomationId="Stats_ChipQuarterUnselected"
                  Background="Transparent" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding !IsQuarterSelected}"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Quarter">
            <TextBlock Text="{Binding QuarterText}" AutomationProperties.AutomationId="Statistics_Txt_QuarterUnselected" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
          </Button>
        </Panel>

        <!-- Halbjahr -->
        <Panel Margin="2">
          <Button AutomationProperties.AutomationId="Stats_ChipHalfYearSelected"
                  Background="{DynamicResource PrimaryBrush}" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding IsHalfYearSelected}"
                  RenderTransformOrigin="50%,50%" RenderTransform="scale(1.05,1.05)"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="HalfYear">
            <TextBlock Text="{Binding HalfYearText}" AutomationProperties.AutomationId="Statistics_Txt_HalfYearSelected" Foreground="White" FontSize="12" FontWeight="SemiBold" />
          </Button>
          <Button AutomationProperties.AutomationId="Stats_ChipHalfYearUnselected"
                  Background="Transparent" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding !IsHalfYearSelected}"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="HalfYear">
            <TextBlock Text="{Binding HalfYearText}" AutomationProperties.AutomationId="Statistics_Txt_HalfYearUnselected" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
          </Button>
        </Panel>

        <!-- Jahr -->
        <Panel Margin="2">
          <Button AutomationProperties.AutomationId="Stats_ChipYearSelected"
                  Background="{DynamicResource PrimaryBrush}" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding IsYearSelected}"
                  RenderTransformOrigin="50%,50%" RenderTransform="scale(1.05,1.05)"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Year">
            <TextBlock Text="{Binding YearText}" AutomationProperties.AutomationId="Statistics_Txt_YearSelected" Foreground="White" FontSize="12" FontWeight="SemiBold" />
          </Button>
          <Button AutomationProperties.AutomationId="Stats_ChipYearUnselected"
                  Background="Transparent" CornerRadius="16" Padding="10,6"
                  IsVisible="{Binding !IsYearSelected}"
                  Command="{Binding SelectPeriodCommand}" CommandParameter="Year">
            <TextBlock Text="{Binding YearText}" AutomationProperties.AutomationId="Statistics_Txt_YearUnselected" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
          </Button>
        </Panel>
      </WrapPanel>
    </Border>

    <!-- ═══ Row 2: Summary-Band (Einnahmen | Ausgaben | Bilanz) ═══ -->
    <Border Grid.Row="2"
            AutomationProperties.AutomationId="Stats_CardSummary"
            Background="{DynamicResource CardBrush}"
            CornerRadius="16"
            Padding="12,10"
            Margin="0,0,0,10">
      <Grid ColumnDefinitions="*,Auto,*,Auto,*"
            AutomationProperties.AutomationId="Statistics_Panel_SummaryGrid">

        <!-- Einnahmen -->
        <StackPanel Grid.Column="0" Spacing="2" HorizontalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
            <Border Background="#2022C55E" Width="18" Height="18" CornerRadius="9"
                    AutomationProperties.AutomationId="Statistics_Border_IncomeIconBg">
              <mi:MaterialIcon Kind="TrendingUp" Width="11" Height="11"
                               AutomationProperties.AutomationId="Statistics_Icon_Income"
                               Foreground="{DynamicResource IncomeBrush}" />
            </Border>
            <TextBlock AutomationProperties.AutomationId="Stats_TxtIncomeLabel"
                       Text="{Binding IncomeLabelText}" FontSize="10"
                       Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center" />
          </StackPanel>
          <TextBlock AutomationProperties.AutomationId="Stats_TxtTotalIncome"
                     Text="{Binding TotalIncomeDisplay}"
                     FontSize="15" FontWeight="Bold"
                     Foreground="{DynamicResource IncomeBrush}"
                     HorizontalAlignment="Center" />
        </StackPanel>

        <!-- Trennlinie -->
        <Border Grid.Column="1" Width="1" Height="32"
                Background="{DynamicResource BorderSubtleBrush}" Margin="6,0" />

        <!-- Ausgaben -->
        <StackPanel Grid.Column="2" Spacing="2" HorizontalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
            <Border Background="#20EF4444" Width="18" Height="18" CornerRadius="9"
                    AutomationProperties.AutomationId="Statistics_Border_ExpenseIconBg">
              <mi:MaterialIcon Kind="TrendingDown" Width="11" Height="11"
                               AutomationProperties.AutomationId="Statistics_Icon_Expense"
                               Foreground="{DynamicResource ExpenseBrush}" />
            </Border>
            <TextBlock AutomationProperties.AutomationId="Stats_TxtExpensesLabel"
                       Text="{Binding ExpensesLabelText}" FontSize="10"
                       Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center" />
          </StackPanel>
          <TextBlock AutomationProperties.AutomationId="Stats_TxtTotalExpenses"
                     Text="{Binding TotalExpensesDisplay}"
                     FontSize="15" FontWeight="Bold"
                     Foreground="{DynamicResource ExpenseBrush}"
                     HorizontalAlignment="Center" />
        </StackPanel>

        <!-- Trennlinie -->
        <Border Grid.Column="3" Width="1" Height="32"
                Background="{DynamicResource BorderSubtleBrush}" Margin="6,0" />

        <!-- Bilanz -->
        <StackPanel Grid.Column="4" Spacing="2" HorizontalAlignment="Center">
          <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
            <Border Background="#206366F1" Width="18" Height="18" CornerRadius="9"
                    AutomationProperties.AutomationId="Statistics_Border_BalanceIconBg">
              <mi:MaterialIcon Kind="ScaleBalance" Width="11" Height="11"
                               AutomationProperties.AutomationId="Statistics_Icon_Balance"
                               Foreground="{DynamicResource PrimaryBrush}" />
            </Border>
            <TextBlock AutomationProperties.AutomationId="Stats_TxtBalanceLabel"
                       Text="{Binding BalanceLabelText}" FontSize="10"
                       Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center" />
          </StackPanel>
          <TextBlock AutomationProperties.AutomationId="Stats_TxtBalance"
                     Text="{Binding BalanceDisplay}"
                     FontSize="16" FontWeight="Bold"
                     Foreground="{DynamicResource PrimaryBrush}"
                     HorizontalAlignment="Center" />
        </StackPanel>

      </Grid>
    </Border>

    <!-- ═══ Row 3: ScrollViewer mit Charts ═══ -->
    <ScrollViewer Grid.Row="3" AutomationProperties.AutomationId="Stats_ScrollContent" VerticalScrollBarVisibility="Auto">
      <StackPanel Spacing="12" Margin="0,0,0,0"
                  AutomationProperties.AutomationId="Statistics_Panel_Charts">

        <!-- ── Empty State ── -->
        <StackPanel AutomationProperties.AutomationId="Stats_SectionEmptyState"
                    IsVisible="{Binding HasNoData}"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Spacing="12" Margin="0,48,0,0">

          <!-- Pulsierendes Icon -->
          <Border Classes="EmptyPulse" Width="80" Height="80" CornerRadius="40"
                  Background="{DynamicResource SurfaceBrush}"
                  HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="ChartDonut" Width="40" Height="40"
                             AutomationProperties.AutomationId="Statistics_Icon_Empty"
                             Foreground="{DynamicResource PrimaryBrush}" />
          </Border>

          <TextBlock AutomationProperties.AutomationId="Stats_TxtEmptyTitle"
                     Text="{Binding NoStatsTitleText}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />
          <TextBlock AutomationProperties.AutomationId="Stats_TxtEmptyDesc"
                     Text="{Binding NoStatsDescText}"
                     FontSize="13" MaxWidth="280"
                     Foreground="{DynamicResource TextMutedBrush}"
                     HorizontalAlignment="Center"
                     TextWrapping="Wrap" TextAlignment="Center" />
        </StackPanel>

        <!-- ── Ausgaben: PieChart + Kategorie-Breakdown in einer Card ── -->
        <Border AutomationProperties.AutomationId="Stats_CardExpenses" Classes="StatsCard" IsVisible="{Binding HasExpenseData}">
          <StackPanel Spacing="12">
            <!-- Überschrift mit Akzent-Icon -->
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Border Background="#20EF4444" Width="28" Height="28" CornerRadius="8"
                      AutomationProperties.AutomationId="Statistics_Border_ExpenseChartIconBg">
                <mi:MaterialIcon Kind="ChartDonut" Width="16" Height="16"
                                 AutomationProperties.AutomationId="Statistics_Icon_ExpenseChart"
                                 Foreground="{DynamicResource ExpenseBrush}" />
              </Border>
              <TextBlock AutomationProperties.AutomationId="Stats_TxtExpensesByCategoryTitle"
                         Text="{Binding ExpensesByCategoryText}"
                         Classes="SectionTitle"
                         VerticalAlignment="Center" />
            </StackPanel>

            <!-- Donut-Chart -->
            <skia:SKCanvasView x:Name="ExpenseDonutCanvas"
                                 AutomationProperties.AutomationId="Stats_CanvasExpenseDonut"
                                 PaintSurface="OnPaintExpenseDonut"
                                 Height="220" />

            <!-- Kategorie-Breakdown (Details mit Fortschrittsbalken) -->
            <TextBlock AutomationProperties.AutomationId="Stats_TxtCategoryBreakdown"
                       Text="{Binding CategoryBreakdownText}"
                       FontSize="13" FontWeight="SemiBold"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       Margin="0,4,0,0" />

            <ItemsControl ItemsSource="{Binding ExpensesByCategory}"
                          AutomationProperties.AutomationId="Statistics_Items_ExpenseCategories">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <StackPanel Spacing="4" Margin="0,0,0,8"
                              AutomationProperties.AutomationId="Statistics_Panel_CategoryItem">
                    <Grid ColumnDefinitions="Auto,*,Auto,Auto"
                          AutomationProperties.AutomationId="Statistics_Panel_CategoryRow">
                      <Border Grid.Column="0" Width="10" Height="10" CornerRadius="5"
                              AutomationProperties.AutomationId="Statistics_Border_CategoryDot"
                              Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                              VerticalAlignment="Center" Margin="0,0,8,0" />
                      <TextBlock Grid.Column="1"
                                 AutomationProperties.AutomationId="Statistics_Txt_CategoryName"
                                 Text="{Binding CategoryName}"
                                 FontSize="13"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center" />
                      <TextBlock Grid.Column="2" Text="{Binding AmountDisplay}"
                                 AutomationProperties.AutomationId="Statistics_Txt_CategoryAmount"
                                 FontSize="13" FontWeight="Bold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center" Margin="0,0,8,0" />
                      <Border Grid.Column="3" CornerRadius="10"
                              Padding="6,2"
                              AutomationProperties.AutomationId="Statistics_Border_CategoryPercent"
                              Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}, ConverterParameter=0.15}">
                        <TextBlock Text="{Binding PercentageDisplay}"
                                   AutomationProperties.AutomationId="Statistics_Txt_CategoryPercent"
                                   FontSize="10" FontWeight="SemiBold"
                                   Foreground="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}" />
                      </Border>
                    </Grid>
                    <!-- Fortschrittsbalken -->
                    <Grid>
                      <Border Background="{DynamicResource SurfaceBrush}"
                              Height="4" CornerRadius="2"
                              HorizontalAlignment="Stretch" />
                      <ProgressBar Minimum="0" Maximum="1"
                                   Value="{Binding Percentage}"
                                   Height="4" CornerRadius="2"
                                   Foreground="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                                   Background="Transparent" />
                    </Grid>
                  </StackPanel>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>

        <!-- ── Einnahmen: PieChart in eigener Card ── -->
        <Border AutomationProperties.AutomationId="Stats_CardIncome" Classes="StatsCard" IsVisible="{Binding HasIncomeData}">
          <StackPanel Spacing="12">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Border Background="#2022C55E" Width="28" Height="28" CornerRadius="8"
                      AutomationProperties.AutomationId="Statistics_Border_IncomeChartIconBg">
                <mi:MaterialIcon Kind="ChartArc" Width="16" Height="16"
                                 AutomationProperties.AutomationId="Statistics_Icon_IncomeChart"
                                 Foreground="{DynamicResource IncomeBrush}" />
              </Border>
              <TextBlock AutomationProperties.AutomationId="Stats_TxtIncomeByCategoryTitle"
                         Text="{Binding IncomeByCategoryText}"
                         Classes="SectionTitle"
                         VerticalAlignment="Center" />
            </StackPanel>

            <skia:SKCanvasView x:Name="IncomeDonutCanvas"
                                 AutomationProperties.AutomationId="Stats_CanvasIncomeDonut"
                                 PaintSurface="OnPaintIncomeDonut"
                                 Height="220" />
          </StackPanel>
        </Border>

        <!-- ── 6-Monats-Trend ── -->
        <Border AutomationProperties.AutomationId="Stats_CardTrend" Classes="StatsCard">
          <StackPanel Spacing="12">
            <!-- Überschrift mit Durchschnitts-Pills -->
            <Grid ColumnDefinitions="Auto,*">
              <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                <Border Background="#206366F1" Width="28" Height="28" CornerRadius="8"
                        AutomationProperties.AutomationId="Statistics_Border_TrendIconBg">
                  <mi:MaterialIcon Kind="ChartLine" Width="16" Height="16"
                                   AutomationProperties.AutomationId="Statistics_Icon_TrendChart"
                                   Foreground="{DynamicResource PrimaryBrush}" />
                </Border>
                <TextBlock AutomationProperties.AutomationId="Stats_TxtTrendTitle"
                           Text="{Binding TrendOverviewText}"
                           Classes="SectionTitle"
                           VerticalAlignment="Center" />
              </StackPanel>

              <!-- Durchschnitts-Pills rechts -->
              <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6"
                          HorizontalAlignment="Right" VerticalAlignment="Center">
                <Border Background="{DynamicResource SurfaceBrush}"
                        AutomationProperties.AutomationId="Statistics_Border_AvgIncomePill"
                        CornerRadius="10" Padding="6,3">
                  <StackPanel Orientation="Horizontal" Spacing="3">
                    <mi:MaterialIcon Kind="TrendingUp" Width="12" Height="12"
                                     AutomationProperties.AutomationId="Statistics_Icon_AvgIncome"
                                     Foreground="{DynamicResource IncomeBrush}" />
                    <TextBlock AutomationProperties.AutomationId="Stats_TxtAvgIncome"
                               Text="{Binding AvgMonthlyIncomeDisplay}" FontSize="10"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                  </StackPanel>
                </Border>
                <Border Background="{DynamicResource SurfaceBrush}"
                        AutomationProperties.AutomationId="Statistics_Border_AvgExpensePill"
                        CornerRadius="10" Padding="6,3">
                  <StackPanel Orientation="Horizontal" Spacing="3">
                    <mi:MaterialIcon Kind="TrendingDown" Width="12" Height="12"
                                     AutomationProperties.AutomationId="Statistics_Icon_AvgExpense"
                                     Foreground="{DynamicResource ExpenseBrush}" />
                    <TextBlock AutomationProperties.AutomationId="Stats_TxtAvgExpense"
                               Text="{Binding AvgMonthlyExpenseDisplay}" FontSize="10"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                  </StackPanel>
                </Border>
              </StackPanel>
            </Grid>

            <!-- Trend Chart -->
            <skia:SKCanvasView x:Name="TrendChartCanvas"
                                 AutomationProperties.AutomationId="Stats_CanvasTrendChart"
                                 PaintSurface="OnPaintTrendChart"
                                 Height="200" />

            <!-- Legend -->
            <StackPanel Orientation="Horizontal" Spacing="16" HorizontalAlignment="Center"
                        AutomationProperties.AutomationId="Statistics_Panel_Legend">
              <StackPanel Orientation="Horizontal" Spacing="4"
                          AutomationProperties.AutomationId="Statistics_Panel_LegendIncome">
                <Border Background="{DynamicResource IncomeBrush}" Width="16" Height="4"
                        AutomationProperties.AutomationId="Statistics_Border_LegendIncomeLine"
                        CornerRadius="2" VerticalAlignment="Center" />
                <TextBlock AutomationProperties.AutomationId="Stats_TxtLegendIncome"
                           Text="{Binding IncomeText}" FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}" />
              </StackPanel>
              <StackPanel Orientation="Horizontal" Spacing="4"
                          AutomationProperties.AutomationId="Statistics_Panel_LegendExpenses">
                <Border Background="{DynamicResource ExpenseBrush}" Width="16" Height="4"
                        AutomationProperties.AutomationId="Statistics_Border_LegendExpenseLine"
                        CornerRadius="2" VerticalAlignment="Center" />
                <TextBlock AutomationProperties.AutomationId="Stats_TxtLegendExpenses"
                           Text="{Binding ExpensesText}" FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}" />
              </StackPanel>
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Bottom Spacer (60dp für Ad-Banner Overlay) -->
        <Border Height="60" />

      </StackPanel>
    </ScrollViewer>

    <!-- Loading Indicator -->
    <ProgressBar Grid.Row="3"
                 AutomationProperties.AutomationId="Stats_ProgressLoading"
                 IsIndeterminate="True"
                 IsVisible="{Binding IsLoading}"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Center" />

    <!-- PDF Export Indicator -->
    <Border Grid.RowSpan="4"
            AutomationProperties.AutomationId="Stats_OverlayExporting"
            IsVisible="{Binding IsExporting}"
            Background="#80000000"
            ZIndex="100">
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
        <ProgressBar IsIndeterminate="True" Width="48"
                     AutomationProperties.AutomationId="Statistics_Progress_Exporting" />
        <TextBlock AutomationProperties.AutomationId="Stats_TxtExportingPdf"
                   Text="{Binding ExportingPdfText}"
                   FontSize="16"
                   Foreground="White"
                   HorizontalAlignment="Center" />
      </StackPanel>
    </Border>

    <!-- Export Ad Overlay -->
    <Border Grid.RowSpan="4"
            AutomationProperties.AutomationId="Stats_OverlayExportAd"
            IsVisible="{Binding ShowExportAdOverlay}"
            Background="#CC000000"
            ZIndex="150">
      <Border Background="{DynamicResource CardBrush}"
              CornerRadius="16"
              Padding="24"
              MaxWidth="340"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock AutomationProperties.AutomationId="Stats_TxtExportLockedTitle"
                     Text="{Binding ExportLockedText}"
                     FontSize="22" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />

          <Border Background="{DynamicResource SurfaceBrush}"
                  AutomationProperties.AutomationId="Statistics_Border_ExportLockedIcon"
                  CornerRadius="30"
                  Width="60" Height="60"
                  HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="Export" Width="32" Height="32"
                             AutomationProperties.AutomationId="Statistics_Icon_ExportLocked"
                             Foreground="{DynamicResource AccentBrush}" />
          </Border>

          <TextBlock AutomationProperties.AutomationId="Stats_TxtExportLockedDesc"
                     Text="{Binding ExportLockedDescText}"
                     FontSize="14"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     TextWrapping="Wrap"
                     TextAlignment="Center" />

          <StackPanel Spacing="8">
            <Button AutomationProperties.AutomationId="Stats_BtnConfirmExportAd"
                    Classes="Filled"
                    Command="{Binding ConfirmExportAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="16,12">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Video" Width="20" Height="20"
                                 AutomationProperties.AutomationId="Statistics_Icon_WatchVideoExport" />
                <TextBlock Text="{Binding WatchVideoExportText}"
                           AutomationProperties.AutomationId="Statistics_Txt_WatchVideoExport"
                           FontSize="15" FontWeight="SemiBold" />
              </StackPanel>
            </Button>

            <Button AutomationProperties.AutomationId="Stats_BtnCancelExportAd"
                    Classes="Text"
                    Command="{Binding CancelExportAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,10">
              <TextBlock Text="{loc:Translate Cancel}"
                         AutomationProperties.AutomationId="Statistics_Txt_CancelExportAd"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Extended Stats Ad Overlay -->
    <Border Grid.RowSpan="4"
            AutomationProperties.AutomationId="Stats_OverlayExtendedStatsAd"
            IsVisible="{Binding ShowExtendedStatsAdOverlay}"
            Background="#CC000000"
            ZIndex="160">
      <Border Background="{DynamicResource CardBrush}"
              CornerRadius="16"
              Padding="24"
              MaxWidth="340"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock AutomationProperties.AutomationId="Stats_TxtExtendedStatsTitle"
                     Text="{Binding ExtendedStatsTitleText}"
                     FontSize="22" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />

          <Border Background="{DynamicResource SurfaceBrush}"
                  AutomationProperties.AutomationId="Statistics_Border_ExtendedStatsIcon"
                  CornerRadius="30"
                  Width="60" Height="60"
                  HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="ChartTimelineVariant" Width="32" Height="32"
                             AutomationProperties.AutomationId="Statistics_Icon_ExtendedStats"
                             Foreground="{DynamicResource AccentBrush}" />
          </Border>

          <TextBlock AutomationProperties.AutomationId="Stats_TxtExtendedStatsDesc"
                     Text="{Binding ExtendedStatsDescText}"
                     FontSize="14"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     TextWrapping="Wrap"
                     TextAlignment="Center" />

          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="8" Padding="10,6"
                  HorizontalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="Clock" Width="16" Height="16"
                               AutomationProperties.AutomationId="Statistics_Icon_Clock24h"
                               Foreground="{DynamicResource AccentBrush}" />
              <TextBlock AutomationProperties.AutomationId="Stats_TxtAccessFor24h"
                         Text="{Binding AccessFor24hText}"
                         FontSize="13" FontWeight="SemiBold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
            </StackPanel>
          </Border>

          <StackPanel Spacing="8">
            <Button AutomationProperties.AutomationId="Stats_BtnConfirmExtendedStatsAd"
                    Classes="Filled"
                    Command="{Binding ConfirmExtendedStatsAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="16,12">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Video" Width="20" Height="20"
                                 AutomationProperties.AutomationId="Statistics_Icon_WatchVideoExtended" />
                <TextBlock Text="{Binding WatchVideoExportText}"
                           AutomationProperties.AutomationId="Statistics_Txt_WatchVideoExtended"
                           FontSize="15" FontWeight="SemiBold" />
              </StackPanel>
            </Button>

            <Button AutomationProperties.AutomationId="Stats_BtnCancelExtendedStatsAd"
                    Classes="Text"
                    Command="{Binding CancelExtendedStatsAdCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,10">
              <TextBlock Text="{loc:Translate Cancel}"
                         AutomationProperties.AutomationId="Statistics_Txt_CancelExtendedStatsAd"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
            </Button>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Export Status Toast -->
    <Border Grid.RowSpan="4"
            AutomationProperties.AutomationId="Stats_ToastExportStatus"
            IsVisible="{Binding IsExportStatusVisible}"
            Background="{DynamicResource CardBrush}"
            CornerRadius="8"
            Padding="12,8"
            HorizontalAlignment="Center"
            VerticalAlignment="Bottom"
            Margin="0,0,0,16"
            ZIndex="200">
      <StackPanel Orientation="Horizontal" Spacing="8">
        <mi:MaterialIcon Kind="CheckCircle" Width="18" Height="18"
                         AutomationProperties.AutomationId="Statistics_Icon_ExportSuccess"
                         Foreground="{DynamicResource PrimaryBrush}" />
        <TextBlock AutomationProperties.AutomationId="Stats_TxtExportStatusMessage"
                   Text="{Binding ExportStatusMessage}"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   FontSize="13" VerticalAlignment="Center" />
      </StackPanel>
    </Border>

  </Grid>

</UserControl>
