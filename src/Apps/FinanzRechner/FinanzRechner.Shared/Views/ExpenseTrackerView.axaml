<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FinanzRechner.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:conv="using:FinanzRechner.Converters"
             xmlns:skia="using:Avalonia.Labs.Controls"
             x:Class="FinanzRechner.Views.ExpenseTrackerView"
             x:DataType="vm:ExpenseTrackerViewModel">

  <!-- Äußerstes Grid: ScrollView + FAB + Dialog Overlay -->
  <Grid RowDefinitions="*,Auto"
        AutomationProperties.AutomationId="Tracker_Root">

    <!-- Ganzseitige ScrollView (Header, Filter, Chart, Monatsnavigation, Transaktionen) -->
    <ScrollViewer Grid.Row="0"
                  VerticalScrollBarVisibility="Auto"
                  IsVisible="{Binding !IsAddingExpense}"
                  AutomationProperties.AutomationId="Tracker_ScrollMain">
      <StackPanel Spacing="0" Margin="16"
                  AutomationProperties.AutomationId="ExpenseTracker_Panel_MainContent">

        <!-- Header -->
        <Grid ColumnDefinitions="*,Auto,Auto,Auto" Margin="0,8,0,16"
              AutomationProperties.AutomationId="ExpenseTracker_Panel_Header">
          <TextBlock Grid.Column="0"
                     Text="{Binding FinanceTrackerText}"
                     Classes="PageTitle"
                     VerticalAlignment="Center"
                     AutomationProperties.AutomationId="Tracker_TxtTitle" />

          <!-- Recurring Transactions Button -->
          <Button Grid.Column="1" Classes="Text"
                  Command="{Binding ShowRecurringTransactionsCommand}"
                  Width="48" Height="48" Padding="0"
                  AutomationProperties.AutomationId="Tracker_BtnRecurring">
            <mi:MaterialIcon Kind="CalendarClock" Width="22" Height="22"
                             AutomationProperties.AutomationId="ExpenseTracker_Icon_Recurring"
                             Foreground="{DynamicResource TextSecondaryBrush}" />
          </Button>

          <!-- Budgets Button -->
          <Button Grid.Column="2" Classes="Text"
                  Command="{Binding ShowBudgetsCommand}"
                  Width="48" Height="48" Padding="0"
                  AutomationProperties.AutomationId="Tracker_BtnBudgets">
            <mi:MaterialIcon Kind="Target" Width="22" Height="22"
                             AutomationProperties.AutomationId="ExpenseTracker_Icon_Budgets"
                             Foreground="{DynamicResource TextSecondaryBrush}" />
          </Button>

          <!-- Export Button -->
          <Button Grid.Column="3" Classes="Text"
                  Command="{Binding ExportToCsvCommand}"
                  Width="48" Height="48" Padding="0"
                  AutomationProperties.AutomationId="Tracker_BtnExport">
            <mi:MaterialIcon Kind="Export" Width="22" Height="22"
                             AutomationProperties.AutomationId="ExpenseTracker_Icon_Export"
                             Foreground="{DynamicResource TextSecondaryBrush}" />
          </Button>
        </Grid>

        <!-- Search & Filter Controls -->
        <StackPanel Spacing="8" Margin="0,0,0,16"
                    AutomationProperties.AutomationId="ExpenseTracker_Panel_SearchFilter">

          <!-- SearchBar -->
          <TextBox Watermark="{Binding SearchTransactionsText}"
                   Text="{Binding SearchTerm}"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   Background="{DynamicResource InputBackgroundBrush}"
                   AutomationProperties.AutomationId="Tracker_InputSearch" />

          <!-- Sort & Filter Row -->
          <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
            <!-- Sort Picker -->
            <Border Grid.Column="0"
                    AutomationProperties.AutomationId="ExpenseTracker_Border_Sort"
                    Background="{DynamicResource CardBrush}"
                    CornerRadius="8"
                    Padding="8,4">
              <ComboBox ItemsSource="{Binding SortOptions}"
                        SelectedItem="{Binding SelectedSort}"
                        PlaceholderText="{Binding SortText}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                        HorizontalAlignment="Stretch"
                        AutomationProperties.AutomationId="Tracker_ComboSort">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Converter={x:Static conv:SortOptionToStringConverter.Instance}}" />
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </Border>

            <!-- Filter Type Picker -->
            <Border Grid.Column="1"
                    AutomationProperties.AutomationId="ExpenseTracker_Border_Filter"
                    Background="{DynamicResource CardBrush}"
                    CornerRadius="8"
                    Padding="8,4">
              <ComboBox ItemsSource="{Binding FilterTypeOptions}"
                        SelectedItem="{Binding SelectedFilter}"
                        PlaceholderText="{Binding FilterText}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                        HorizontalAlignment="Stretch"
                        AutomationProperties.AutomationId="Tracker_ComboFilter">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Converter={x:Static conv:FilterTypeToStringConverter.Instance}}" />
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </Border>
          </Grid>

          <!-- Kategorie-Verteilung (Kreisdiagramm) -->
          <Border Background="{DynamicResource CardBrush}"
                  CornerRadius="12"
                  Padding="12"
                  IsVisible="{Binding HasCategoryChartData}"
                  AutomationProperties.AutomationId="Tracker_CardCategoryChart">
            <StackPanel Spacing="4">
              <TextBlock Text="{Binding CategoryBreakdownText}"
                         FontSize="13" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}"
                         AutomationProperties.AutomationId="Tracker_TxtCategoryBreakdown" />
              <skia:SKCanvasView x:Name="CategoryDonutCanvas"
                                   PaintSurface="OnPaintCategoryDonut"
                                   Height="180"
                                   AutomationProperties.AutomationId="Tracker_CanvasCategoryDonut" />
            </StackPanel>
          </Border>

          <!-- Category & Amount Filters (Collapsible) -->
          <Border IsVisible="{Binding IsFilterActive}"
                  Background="{DynamicResource CardBrush}"
                  CornerRadius="8"
                  Padding="12"
                  AutomationProperties.AutomationId="Tracker_CardFilterDetails">
            <StackPanel Spacing="8">

              <!-- Category Filter -->
              <StackPanel Spacing="4">
                <TextBlock Text="{Binding FilterByCategoryText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="12"
                           AutomationProperties.AutomationId="Tracker_TxtFilterByCategory" />
                <ComboBox ItemsSource="{Binding CategoryFilterOptions}"
                          SelectedItem="{Binding SelectedCategoryFilter}"
                          Foreground="{DynamicResource TextPrimaryBrush}"
                          HorizontalAlignment="Stretch"
                          AutomationProperties.AutomationId="Tracker_ComboCategory" />
              </StackPanel>

              <!-- Amount Range Filter -->
              <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <StackPanel Grid.Column="0" Spacing="4">
                  <TextBlock Text="{Binding MinAmountText}"
                             Foreground="{DynamicResource TextSecondaryBrush}"
                             FontSize="12"
                             AutomationProperties.AutomationId="Tracker_TxtMinAmount" />
                  <TextBox Text="{Binding MinAmountFilter}"
                           Watermark="0"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           Background="{DynamicResource InputBackgroundBrush}"
                           AutomationProperties.AutomationId="Tracker_InputMinAmount" />
                </StackPanel>

                <StackPanel Grid.Column="1" Spacing="4">
                  <TextBlock Text="{Binding MaxAmountText}"
                             Foreground="{DynamicResource TextSecondaryBrush}"
                             FontSize="12"
                             AutomationProperties.AutomationId="Tracker_TxtMaxAmount" />
                  <TextBox Text="{Binding MaxAmountFilter}"
                           Watermark="0"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           Background="{DynamicResource InputBackgroundBrush}"
                           AutomationProperties.AutomationId="Tracker_InputMaxAmount" />
                </StackPanel>
              </Grid>

              <!-- Reset Filters Button -->
              <Button Content="{Binding ResetFiltersText}"
                      Command="{Binding ResetFiltersCommand}"
                      Classes="Secondary"
                      Padding="8,4"
                      Margin="0,4,0,0"
                      AutomationProperties.AutomationId="Tracker_BtnResetFilters" />
            </StackPanel>
          </Border>

          <!-- Filter Status Display -->
          <TextBlock Text="{Binding FilteredCountDisplay}"
                     IsVisible="{Binding IsFilterActive}"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     Margin="0,4,0,0"
                     AutomationProperties.AutomationId="Tracker_TxtFilteredCount" />
        </StackPanel>

        <!-- Monats-Navigation (kompakt) -->
        <Border Background="{DynamicResource CardBrush}"
                CornerRadius="12"
                Padding="12,8"
                Margin="0,0,0,12"
                AutomationProperties.AutomationId="Tracker_CardMonthNav">
          <Grid ColumnDefinitions="Auto,*,Auto">
            <Button Grid.Column="0" Classes="Text"
                    Command="{Binding PreviousMonthCommand}" Padding="4"
                    AutomationProperties.AutomationId="Tracker_BtnPrevMonth">
              <mi:MaterialIcon Kind="ChevronLeft" Width="18" Height="18"
                               Foreground="{DynamicResource PrimaryBrush}" />
            </Button>

            <StackPanel Grid.Column="1" HorizontalAlignment="Center" Spacing="4">
              <!-- Monatsname -->
              <Button Classes="Text" Command="{Binding GoToCurrentMonthCommand}"
                      HorizontalAlignment="Center" Padding="4,0"
                      AutomationProperties.AutomationId="Tracker_BtnCurrentMonth">
                <TextBlock Text="{Binding MonthYearDisplay}"
                           FontSize="15" FontWeight="Bold"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           AutomationProperties.AutomationId="Tracker_TxtMonthYear" />
              </Button>

              <!-- Einnahmen + Ausgaben + Bilanz kompakt -->
              <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="3">
                  <mi:MaterialIcon Kind="ArrowUpBold" Width="12" Height="12"
                                   Foreground="#22C55E" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding TotalIncomeDisplay}" FontSize="12" FontWeight="SemiBold"
                             Foreground="#22C55E" VerticalAlignment="Center"
                             AutomationProperties.AutomationId="Tracker_TxtIncome" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="3">
                  <mi:MaterialIcon Kind="ArrowDownBold" Width="12" Height="12"
                                   Foreground="#EF4444" VerticalAlignment="Center" />
                  <TextBlock Text="{Binding TotalExpensesDisplay}" FontSize="12" FontWeight="SemiBold"
                             Foreground="#EF4444" VerticalAlignment="Center"
                             AutomationProperties.AutomationId="Tracker_TxtExpenses" />
                </StackPanel>
                <Border Background="{DynamicResource AccentBrush}" CornerRadius="6" Padding="6,2"
                        AutomationProperties.AutomationId="Tracker_CardBalance">
                  <TextBlock Text="{Binding BalanceDisplay}" FontSize="12" FontWeight="Bold" Foreground="White"
                             AutomationProperties.AutomationId="Tracker_TxtBalance" />
                </Border>
              </StackPanel>
            </StackPanel>

            <Button Grid.Column="2" Classes="Text"
                    Command="{Binding NextMonthCommand}" Padding="4"
                    AutomationProperties.AutomationId="Tracker_BtnNextMonth">
              <mi:MaterialIcon Kind="ChevronRight" Width="18" Height="18"
                               Foreground="{DynamicResource PrimaryBrush}" />
            </Button>
          </Grid>
        </Border>

        <!-- Transaktionen -->
        <!-- Empty State -->
        <StackPanel IsVisible="{Binding !HasExpenses}"
                    HorizontalAlignment="Center"
                    Spacing="8" Margin="0,40,0,0"
                    AutomationProperties.AutomationId="Tracker_SectionEmpty">
          <mi:MaterialIcon Kind="Wallet" Width="48" Height="48"
                           AutomationProperties.AutomationId="ExpenseTracker_Icon_Empty"
                           Foreground="{DynamicResource TextMutedBrush}"
                           HorizontalAlignment="Center" />
          <TextBlock Text="{Binding NoTransactionsText}"
                     FontSize="16" FontWeight="Bold"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center"
                     AutomationProperties.AutomationId="Tracker_TxtNoTransactions" />
          <TextBlock Text="{Binding NoTransactionsHintText}"
                     FontSize="13"
                     Foreground="{DynamicResource TextMutedBrush}"
                     HorizontalAlignment="Center"
                     AutomationProperties.AutomationId="Tracker_TxtNoTransactionsHint" />
        </StackPanel>

        <!-- Gruppierte Transaction Items (nach Datum) -->
        <ItemsControl ItemsSource="{Binding GroupedExpenses}"
                      IsVisible="{Binding HasExpenses}"
                      AutomationProperties.AutomationId="Tracker_SectionTransactions">
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <StackPanel Spacing="0" Margin="0,0,0,12"
                          AutomationProperties.AutomationId="ExpenseTracker_Panel_DateGroup">
                <!-- Date-Header: Datum links, Tages-Summe rechts -->
                <Grid ColumnDefinitions="*,Auto" Margin="4,4,4,6"
                      AutomationProperties.AutomationId="ExpenseTracker_Panel_DateHeader">
                  <TextBlock Grid.Column="0" Text="{Binding DateDisplay}"
                             AutomationProperties.AutomationId="ExpenseTracker_Txt_DateDisplay"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource TextSecondaryBrush}" />
                  <TextBlock Grid.Column="1"
                             AutomationProperties.AutomationId="ExpenseTracker_Txt_DayTotal"
                             FontSize="13" FontWeight="Bold"
                             Foreground="{DynamicResource TextSecondaryBrush}">
                    <TextBlock.Text>
                      <MultiBinding StringFormat="{}{0:+#,##0.00;-#,##0.00;0.00} €">
                        <Binding Path="DayTotal" />
                      </MultiBinding>
                    </TextBlock.Text>
                  </TextBlock>
                </Grid>

                <!-- Transaktionen dieser Gruppe -->
                <ItemsControl ItemsSource="{Binding}"
                              AutomationProperties.AutomationId="ExpenseTracker_Items_DayTransactions">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="{DynamicResource CardBrush}"
                              AutomationProperties.AutomationId="ExpenseTracker_Border_TransactionItem"
                              CornerRadius="12"
                              Padding="12"
                              Margin="0,0,0,6">
                        <Grid RowDefinitions="Auto,Auto">
                          <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto,Auto" ColumnSpacing="8">
                            <!-- Farbiges Kategorie-Icon -->
                            <Border Grid.Column="0"
                                    AutomationProperties.AutomationId="ExpenseTracker_Border_CategoryIcon"
                                    Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}, ConverterParameter=0.2}"
                                    CornerRadius="12"
                                    Width="44" Height="44">
                              <mi:MaterialIcon Kind="{Binding Category, Converter={x:Static conv:CategoryToIconConverter.Instance}}"
                                               Width="22" Height="22"
                                               AutomationProperties.AutomationId="ExpenseTracker_Icon_Category"
                                               Foreground="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>

                            <!-- Details -->
                            <StackPanel Grid.Column="1" VerticalAlignment="Center"
                                        AutomationProperties.AutomationId="ExpenseTracker_Panel_TransactionDetails">
                              <TextBlock Text="{Binding Description}"
                                         AutomationProperties.AutomationId="ExpenseTracker_Txt_Description"
                                         FontSize="15" FontWeight="SemiBold"
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         TextTrimming="CharacterEllipsis" />
                              <TextBlock Text="{Binding Date, StringFormat='{}{0:HH:mm}'}"
                                         AutomationProperties.AutomationId="ExpenseTracker_Txt_Time"
                                         FontSize="11"
                                         Foreground="{DynamicResource TextMutedBrush}" />
                            </StackPanel>

                            <!-- Betrag mit Farbe nach Typ -->
                            <TextBlock Grid.Column="2"
                                       AutomationProperties.AutomationId="ExpenseTracker_Txt_Amount"
                                       FontSize="15" FontWeight="Bold"
                                       Foreground="{Binding Type, Converter={x:Static conv:TransactionTypeToColorConverter.Instance}}"
                                       VerticalAlignment="Center">
                              <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0}{1:N2} €">
                                  <Binding Path="Type" Converter="{x:Static conv:TransactionTypeToPrefixConverter.Instance}" />
                                  <Binding Path="Amount" />
                                </MultiBinding>
                              </TextBlock.Text>
                            </TextBlock>

                            <!-- Edit Button -->
                            <Button Grid.Column="3" Classes="Text"
                                    AutomationProperties.AutomationId="ExpenseTracker_Btn_EditTransaction"
                                    Command="{Binding $parent[UserControl].((vm:ExpenseTrackerViewModel)DataContext).EditExpenseCommand}"
                                    CommandParameter="{Binding}"
                                    Width="36" Height="36" Padding="0"
                                    VerticalAlignment="Center">
                              <mi:MaterialIcon Kind="Pencil" Width="18" Height="18"
                                               AutomationProperties.AutomationId="ExpenseTracker_Icon_Edit"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                            </Button>

                            <!-- Delete Button -->
                            <Button Grid.Column="4" Classes="Text"
                                    AutomationProperties.AutomationId="ExpenseTracker_Btn_DeleteTransaction"
                                    Command="{Binding $parent[UserControl].((vm:ExpenseTrackerViewModel)DataContext).DeleteExpenseCommand}"
                                    CommandParameter="{Binding}"
                                    Width="36" Height="36" Padding="0"
                                    VerticalAlignment="Center">
                              <mi:MaterialIcon Kind="Delete" Width="18" Height="18"
                                               AutomationProperties.AutomationId="ExpenseTracker_Icon_Delete"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                            </Button>
                          </Grid>

                          <!-- Notiz (optional, grau, kleiner Text) -->
                          <TextBlock Grid.Row="1"
                                     AutomationProperties.AutomationId="ExpenseTracker_Txt_Note"
                                     Text="{Binding Note}"
                                     IsVisible="{Binding Note, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                     FontSize="12" FontStyle="Italic"
                                     Foreground="{DynamicResource TextMutedBrush}"
                                     Margin="52,2,0,0"
                                     TextTrimming="CharacterEllipsis" />
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </StackPanel>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Bottom Spacer (60dp für Ad-Banner Overlay) -->
        <Border Height="60" />
      </StackPanel>
    </ScrollViewer>

    <!-- Loading Indicator -->
    <ProgressBar Grid.Row="0"
                 IsIndeterminate="True"
                 IsVisible="{Binding IsLoading}"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Center"
                 AutomationProperties.AutomationId="Tracker_ProgressLoading" />

    <!-- Undo Delete Snackbar mit Countdown-Balken -->
    <Border Grid.Row="0"
            IsVisible="{Binding ShowUndoDelete}"
            Background="{DynamicResource CardBrush}"
            CornerRadius="12"
            Padding="16,12"
            Margin="16"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Bottom"
            ZIndex="100"
            AutomationProperties.AutomationId="Tracker_SnackbarUndo">
      <StackPanel Spacing="8">
        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
          <TextBlock Grid.Column="0"
                     Text="{Binding UndoMessage}"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     FontSize="14"
                     VerticalAlignment="Center"
                     TextTrimming="CharacterEllipsis"
                     AutomationProperties.AutomationId="Tracker_TxtUndoMessage" />
          <Button Grid.Column="1"
                  Content="{Binding UndoText}"
                  Command="{Binding UndoDeleteCommand}"
                  Classes="Primary"
                  Padding="16,8"
                  AutomationProperties.AutomationId="Tracker_BtnUndo" />
          <Button Grid.Column="2" Classes="Text"
                  Command="{Binding DismissUndoCommand}"
                  Width="36" Height="36" Padding="0"
                  AutomationProperties.AutomationId="Tracker_BtnDismissUndo">
            <mi:MaterialIcon Kind="Close" Width="18" Height="18"
                             AutomationProperties.AutomationId="ExpenseTracker_Icon_DismissUndo"
                             Foreground="{DynamicResource TextMutedBrush}" />
          </Button>
        </Grid>
        <!-- Undo-Countdown-Balken -->
        <Border Classes="UndoTimer" Height="3" CornerRadius="2"
                AutomationProperties.AutomationId="ExpenseTracker_Border_UndoTimer"
                Background="{DynamicResource AccentBrush}" />
      </StackPanel>
    </Border>

    <!-- Floating Add Button (FAB) -->
    <Button Grid.Row="0"
            Classes="BouncingFab"
            Background="{DynamicResource AccentBrush}"
            CornerRadius="28"
            Width="56" Height="56"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="0,0,24,72"
            RenderTransformOrigin="50%,50%"
            IsVisible="{Binding !IsAddingExpense}"
            Cursor="Hand"
            Command="{Binding ShowAddExpenseFormCommand}"
            Padding="0"
            ZIndex="50"
            AutomationProperties.AutomationId="Tracker_FabAdd">
      <mi:MaterialIcon Kind="Plus" Width="24" Height="24"
                       AutomationProperties.AutomationId="ExpenseTracker_Icon_Add"
                       Foreground="White"
                       HorizontalAlignment="Center" VerticalAlignment="Center" />
    </Button>

    <!-- Export Status Toast -->
    <Border Grid.Row="0"
            IsVisible="{Binding IsExportStatusVisible}"
            Background="{DynamicResource CardBrush}"
            CornerRadius="8"
            Padding="12,8"
            HorizontalAlignment="Center"
            VerticalAlignment="Bottom"
            Margin="0,0,0,72"
            ZIndex="200"
            AutomationProperties.AutomationId="Tracker_SnackbarExport">
      <StackPanel Orientation="Horizontal" Spacing="8">
        <mi:MaterialIcon Kind="CheckCircle" Width="18" Height="18"
                         AutomationProperties.AutomationId="ExpenseTracker_Icon_ExportSuccess"
                         Foreground="{DynamicResource PrimaryBrush}" />
        <TextBlock Text="{Binding ExportStatusMessage}"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   FontSize="13" VerticalAlignment="Center"
                   AutomationProperties.AutomationId="Tracker_TxtExportStatus" />
      </StackPanel>
    </Border>

    <!-- Add/Edit Form (Dialog Overlay) -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            IsVisible="{Binding IsAddingExpense}"
            Background="#80000000"
            ZIndex="10"
            AutomationProperties.AutomationId="Tracker_OverlayAddEdit">
      <ScrollViewer VerticalAlignment="Center" MaxHeight="600" Margin="20"
                    AutomationProperties.AutomationId="ExpenseTracker_Scroll_Dialog">
        <Border Classes="DialogOverlay"
                Background="{DynamicResource CardBrush}"
                CornerRadius="16"
                Padding="24"
                MaxWidth="420"
                HorizontalAlignment="Center"
                AutomationProperties.AutomationId="Tracker_CardDialog">
          <StackPanel Spacing="20">

            <!-- HEADER: Title + Close -->
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Grid.Column="0"
                         Text="{Binding DialogTitleText}"
                         Classes="SectionHeader"
                         AutomationProperties.AutomationId="Tracker_TxtDialogTitle" />
              <Button Grid.Column="1" Classes="Text"
                      Command="{Binding CancelAddExpenseCommand}"
                      Width="48" Height="48" Padding="0"
                      AutomationProperties.AutomationId="Tracker_BtnCloseDialog">
                <mi:MaterialIcon Kind="Close" Width="22" Height="22"
                                 AutomationProperties.AutomationId="ExpenseTracker_Icon_CloseDialog"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
              </Button>
            </Grid>

            <!-- AMOUNT -->
            <StackPanel Spacing="8">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="CurrencyEur" Width="18" Height="18"
                                 AutomationProperties.AutomationId="ExpenseTracker_Icon_AmountSection"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 VerticalAlignment="Center" />
                <TextBlock Text="{Binding AmountText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="14" VerticalAlignment="Center"
                           AutomationProperties.AutomationId="Tracker_TxtAmountLabel" />
              </StackPanel>
              <TextBox Text="{Binding NewExpenseAmount}"
                       FontSize="32" FontWeight="Bold"
                       TextAlignment="Center"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Watermark="0.00"
                       Background="{DynamicResource InputBackgroundBrush}"
                       AutomationProperties.AutomationId="Tracker_InputAmount" />
            </StackPanel>

            <!-- TYP: Ausgabe / Einnahme (mit Selected-State) -->
            <StackPanel Spacing="8">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="SwapHorizontal" Width="18" Height="18"
                                 AutomationProperties.AutomationId="ExpenseTracker_Icon_TypeSection"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 VerticalAlignment="Center" />
                <TextBlock Text="{Binding TypeText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="14" VerticalAlignment="Center"
                           AutomationProperties.AutomationId="Tracker_TxtTypeLabel" />
              </StackPanel>
              <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <!-- Ausgabe: Selected -->
                <Panel Grid.Column="0"
                       AutomationProperties.AutomationId="Tracker_BtnExpenseType">
                  <Button Command="{Binding SetTransactionTypeExpenseCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,18"
                          Background="#33EF4444" BorderBrush="#EF4444" BorderThickness="2"
                          CornerRadius="12"
                          IsVisible="{Binding IsExpenseSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowDownBold" Width="20" Height="20" Foreground="#EF4444" />
                      <TextBlock Text="{Binding ExpenseText}" FontSize="15" FontWeight="Bold" Foreground="#EF4444" />
                    </StackPanel>
                  </Button>
                  <Button Command="{Binding SetTransactionTypeExpenseCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,18"
                          Background="{DynamicResource SurfaceBrush}" BorderThickness="1"
                          BorderBrush="{DynamicResource BorderSubtleBrush}"
                          CornerRadius="12"
                          IsVisible="{Binding !IsExpenseSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowDownBold" Width="20" Height="20"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                      <TextBlock Text="{Binding ExpenseText}" FontSize="15"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
                    </StackPanel>
                  </Button>
                </Panel>

                <!-- Einnahme: Selected -->
                <Panel Grid.Column="1"
                       AutomationProperties.AutomationId="Tracker_BtnIncomeType">
                  <Button Command="{Binding SetTransactionTypeIncomeCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,18"
                          Background="#3322C55E" BorderBrush="#22C55E" BorderThickness="2"
                          CornerRadius="12"
                          IsVisible="{Binding IsIncomeSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowUpBold" Width="20" Height="20" Foreground="#22C55E" />
                      <TextBlock Text="{Binding IncomeText}" FontSize="15" FontWeight="Bold" Foreground="#22C55E" />
                    </StackPanel>
                  </Button>
                  <Button Command="{Binding SetTransactionTypeIncomeCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,18"
                          Background="{DynamicResource SurfaceBrush}" BorderThickness="1"
                          BorderBrush="{DynamicResource BorderSubtleBrush}"
                          CornerRadius="12"
                          IsVisible="{Binding !IsIncomeSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowUpBold" Width="20" Height="20"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                      <TextBlock Text="{Binding IncomeText}" FontSize="15"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
                    </StackPanel>
                  </Button>
                </Panel>
              </Grid>
            </StackPanel>

            <!-- CATEGORY -->
            <StackPanel Spacing="8">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Filter" Width="18" Height="18"
                                 AutomationProperties.AutomationId="ExpenseTracker_Icon_CategorySection"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 VerticalAlignment="Center" />
                <TextBlock Text="{Binding CategoryText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="14" VerticalAlignment="Center"
                           AutomationProperties.AutomationId="Tracker_TxtCategoryLabel" />
              </StackPanel>
              <!-- Category chips mit farbigem Hintergrund -->
              <ItemsControl ItemsSource="{Binding CategoryItems}"
                            AutomationProperties.AutomationId="ExpenseTracker_Items_Categories">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Panel Margin="0,0,6,6">
                      <!-- Selected: Volle Kategorie-Farbe -->
                      <Button CornerRadius="16"
                              Padding="10,6"
                              MinHeight="40"
                              Cursor="Hand"
                              Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                              BorderBrush="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                              BorderThickness="2"
                              IsVisible="{Binding IsSelected}"
                              Command="{Binding $parent[UserControl].((vm:ExpenseTrackerViewModel)DataContext).SelectCategoryCommand}"
                              CommandParameter="{Binding}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                          <TextBlock Text="{Binding CategoryDisplay}" FontSize="16" VerticalAlignment="Center"
                                     Foreground="White" />
                          <TextBlock Text="{Binding CategoryName}" FontSize="13" VerticalAlignment="Center"
                                     Foreground="White" FontWeight="Bold" />
                        </StackPanel>
                      </Button>
                      <!-- Unselected: Transparenter Kategorie-Hintergrund -->
                      <Button CornerRadius="16"
                              Padding="10,6"
                              MinHeight="40"
                              Cursor="Hand"
                              Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}, ConverterParameter=0.15}"
                              BorderThickness="0"
                              IsVisible="{Binding !IsSelected}"
                              Command="{Binding $parent[UserControl].((vm:ExpenseTrackerViewModel)DataContext).SelectCategoryCommand}"
                              CommandParameter="{Binding}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                          <TextBlock Text="{Binding CategoryDisplay}" FontSize="16" VerticalAlignment="Center" />
                          <TextBlock Text="{Binding CategoryName}" FontSize="13" VerticalAlignment="Center"
                                     Foreground="{DynamicResource TextPrimaryBrush}" />
                        </StackPanel>
                      </Button>
                    </Panel>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>

            <!-- DETAILS: Description + Date + Note -->
            <StackPanel Spacing="8">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="ClipboardText" Width="18" Height="18"
                                 AutomationProperties.AutomationId="ExpenseTracker_Icon_DetailsSection"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 VerticalAlignment="Center" />
                <TextBlock Text="{Binding DescriptionText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="14" VerticalAlignment="Center"
                           AutomationProperties.AutomationId="Tracker_TxtDescriptionLabel" />
              </StackPanel>

              <TextBox Text="{Binding NewExpenseDescription}"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Background="{DynamicResource InputBackgroundBrush}"
                       AutomationProperties.AutomationId="Tracker_InputDescription" />

              <!-- Date -->
              <CalendarDatePicker SelectedDate="{Binding NewExpenseDate}"
                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                  HorizontalAlignment="Stretch"
                                  AutomationProperties.AutomationId="Tracker_InputDate" />

              <!-- Note (optional) -->
              <TextBox Text="{Binding NewExpenseNote}"
                       Watermark="{Binding NoteText}"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Background="{DynamicResource InputBackgroundBrush}"
                       AutomationProperties.AutomationId="Tracker_InputNote" />
            </StackPanel>

            <!-- RECURRING (only for new entries) -->
            <StackPanel Spacing="8"
                        IsVisible="{Binding ShowRecurringSection}">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <mi:MaterialIcon Kind="Refresh" Width="18" Height="18"
                                 AutomationProperties.AutomationId="ExpenseTracker_Icon_RecurringSection"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 VerticalAlignment="Center" />
                <TextBlock Text="{Binding RecurringText}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="14" VerticalAlignment="Center"
                           AutomationProperties.AutomationId="Tracker_TxtRecurringLabel" />
              </StackPanel>

              <!-- Toggle -->
              <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" Text="{Binding MakeRecurringText}"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           FontSize="15" VerticalAlignment="Center"
                           AutomationProperties.AutomationId="Tracker_TxtMakeRecurring" />
                <ToggleSwitch Grid.Column="1"
                              IsChecked="{Binding IsRecurring}"
                              OnContent="" OffContent=""
                              AutomationProperties.AutomationId="Tracker_ToggleRecurring" />
              </Grid>
            </StackPanel>

            <!-- BUTTONS -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,4,0,0"
                  AutomationProperties.AutomationId="ExpenseTracker_Panel_DialogButtons">
              <Button Grid.Column="0"
                      Content="{Binding CancelText}"
                      Classes="Secondary"
                      Command="{Binding CancelAddExpenseCommand}"
                      AutomationProperties.AutomationId="Tracker_BtnCancel" />
              <Button Grid.Column="1"
                      Content="{Binding SaveText}"
                      Classes="Primary"
                      Command="{Binding SaveExpenseCommand}"
                      AutomationProperties.AutomationId="Tracker_BtnSave" />
            </Grid>

          </StackPanel>
        </Border>
      </ScrollViewer>
    </Border>

  </Grid>

</UserControl>
