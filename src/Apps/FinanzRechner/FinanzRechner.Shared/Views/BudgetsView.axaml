<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FinanzRechner.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:skia="using:Avalonia.Labs.Controls"
             x:Class="FinanzRechner.Views.BudgetsView"
             x:DataType="vm:BudgetsViewModel">

  <Grid RowDefinitions="Auto,*" AutomationProperties.AutomationId="Budgets_Root">

    <!-- Header -->
    <Grid Grid.Row="0" ColumnDefinitions="Auto,*" Margin="0,0,0,16"
          AutomationProperties.AutomationId="Budgets_Panel_Header">
      <!-- Back Button -->
      <Button Grid.Column="0" Classes="Text"
              AutomationProperties.AutomationId="Budgets_BtnBack"
              Command="{Binding GoBackCommand}"
              Width="48" Height="48" Padding="0">
        <mi:MaterialIcon Kind="ArrowLeft" Width="20" Height="20"
                         AutomationProperties.AutomationId="Budgets_Icon_Back"
                         Foreground="{DynamicResource PrimaryBrush}" />
      </Button>
      <TextBlock Grid.Column="1"
                 AutomationProperties.AutomationId="Budgets_TxtTitle"
                 Text="{Binding BudgetLimitsText}"
                 Classes="PageTitle"
                 VerticalAlignment="Center"
                 Margin="8,0,0,0" />
    </Grid>

    <!-- Content -->
    <Panel Grid.Row="1">

      <!-- Budget List -->
      <ScrollViewer AutomationProperties.AutomationId="Budgets_ScrollViewer">
        <StackPanel Spacing="12" Margin="16,0"
                    AutomationProperties.AutomationId="Budgets_Panel_Content">

          <!-- Gesamt-Monatsbudget -->
          <Border Classes="Card" Margin="0,0,0,4"
                  AutomationProperties.AutomationId="Budgets_CardTotalBudget"
                  IsVisible="{Binding HasTotalBudget}">
            <StackPanel Spacing="4"
                        AutomationProperties.AutomationId="Budgets_Panel_TotalBudget">
              <TextBlock Text="{Binding TotalBudgetText}"
                         AutomationProperties.AutomationId="Budgets_TxtTotalBudget"
                         FontSize="16" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}"
                         HorizontalAlignment="Center" />
              <!-- SkiaSharp Budget-Gauge (Halbkreis-Tachometer) -->
              <Border Height="120" ClipToBounds="True">
                <skia:SKCanvasView x:Name="BudgetGaugeCanvas" AutomationProperties.AutomationId="Budgets_CanvasGauge" PaintSurface="OnPaintBudgetGauge" />
              </Border>
            </StackPanel>
          </Border>

          <!-- Empty State -->
          <StackPanel IsVisible="{Binding !HasBudgets}"
                      AutomationProperties.AutomationId="Budgets_PanelEmpty"
                      HorizontalAlignment="Center" VerticalAlignment="Center"
                      Spacing="8" Margin="0,40,0,0">
            <mi:MaterialIcon Kind="Target" Width="48" Height="48"
                             AutomationProperties.AutomationId="Budgets_Icon_Empty"
                             Foreground="{DynamicResource TextMutedBrush}"
                             HorizontalAlignment="Center" />
            <TextBlock Text="{Binding NoBudgetsText}"
                       AutomationProperties.AutomationId="Budgets_TxtEmptyTitle"
                       FontSize="16" FontWeight="Bold"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       HorizontalAlignment="Center" />
            <TextBlock Text="{Binding NoBudgetsHintText}"
                       AutomationProperties.AutomationId="Budgets_TxtEmptyHint"
                       FontSize="13"
                       Foreground="{DynamicResource TextMutedBrush}"
                       HorizontalAlignment="Center" />
          </StackPanel>

          <!-- Budget Items -->
          <ItemsControl ItemsSource="{Binding BudgetStatuses}"
                        AutomationProperties.AutomationId="Budgets_Items_BudgetList">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Classes="Card" Margin="0,0,0,4" Cursor="Hand"
                        AutomationProperties.AutomationId="Budgets_Border_BudgetItem">
                  <StackPanel Spacing="8"
                              AutomationProperties.AutomationId="Budgets_Panel_BudgetItem">

                    <!-- Category Header -->
                    <StackPanel Orientation="Horizontal" Spacing="12"
                                AutomationProperties.AutomationId="Budgets_Panel_CategoryHeader">
                      <TextBlock Text="{Binding CategoryIcon}" FontSize="24"
                                 AutomationProperties.AutomationId="Budgets_Txt_CategoryIcon" />
                      <TextBlock Text="{Binding CategoryName}"
                                 AutomationProperties.AutomationId="Budgets_Txt_CategoryName"
                                 FontSize="18" FontWeight="Bold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center" />

                      <!-- Alert Badge - Exceeded -->
                      <Border Background="{DynamicResource ExpenseBrush}"
                              CornerRadius="12"
                              Padding="8,4"
                              AutomationProperties.AutomationId="Budgets_Border_ExceededBadge"
                              IsVisible="{Binding IsExceeded}">
                        <TextBlock Text="{Binding $parent[UserControl].((vm:BudgetsViewModel)DataContext).ExceededText}"
                                   AutomationProperties.AutomationId="Budgets_Txt_Exceeded"
                                   FontSize="10" FontWeight="Bold" Foreground="White" />
                      </Border>

                      <!-- Alert Badge - Warning -->
                      <Border Background="{DynamicResource WarningBrush}"
                              CornerRadius="12"
                              Padding="8,4"
                              AutomationProperties.AutomationId="Budgets_Border_WarningBadge"
                              IsVisible="{Binding IsWarning}">
                        <TextBlock Text="{Binding $parent[UserControl].((vm:BudgetsViewModel)DataContext).WarningLabelText}"
                                   AutomationProperties.AutomationId="Budgets_Txt_Warning"
                                   FontSize="10" FontWeight="Bold" Foreground="White" />
                      </Border>
                    </StackPanel>

                    <!-- Progress Bar (SkiaSharp) -->
                    <skia:SKCanvasView Height="18"
                                        AutomationProperties.AutomationId="Budgets_Canvas_Progress"
                                        PaintSurface="OnPaintBudgetProgress" />

                    <!-- Budget Details -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8"
                          AutomationProperties.AutomationId="Budgets_Panel_Details">
                      <StackPanel AutomationProperties.AutomationId="Budgets_Panel_Spent">
                        <TextBlock Text="{Binding $parent[UserControl].((vm:BudgetsViewModel)DataContext).SpentText}"
                                   AutomationProperties.AutomationId="Budgets_Txt_SpentLabel"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="{Binding Spent, StringFormat='{}{0:F2} €'}"
                                   AutomationProperties.AutomationId="Budgets_Txt_SpentValue"
                                   FontSize="14" FontWeight="Bold"
                                   Foreground="{DynamicResource ExpenseBrush}" />
                      </StackPanel>

                      <StackPanel Grid.Column="1"
                                  AutomationProperties.AutomationId="Budgets_Panel_Remaining">
                        <TextBlock Text="{Binding $parent[UserControl].((vm:BudgetsViewModel)DataContext).RemainingText}"
                                   AutomationProperties.AutomationId="Budgets_Txt_RemainingLabel"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="{Binding Remaining, StringFormat='{}{0:F2} €'}"
                                   AutomationProperties.AutomationId="Budgets_Txt_RemainingValue"
                                   FontSize="14" FontWeight="Bold"
                                   Foreground="{DynamicResource IncomeBrush}" />
                      </StackPanel>

                      <StackPanel Grid.Column="2"
                                  AutomationProperties.AutomationId="Budgets_Panel_Limit">
                        <TextBlock Text="{Binding $parent[UserControl].((vm:BudgetsViewModel)DataContext).MonthlyLimitText}"
                                   AutomationProperties.AutomationId="Budgets_Txt_LimitLabel"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="{Binding Limit, StringFormat='{}{0:F2} €'}"
                                   AutomationProperties.AutomationId="Budgets_Txt_LimitValue"
                                   FontSize="14" FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                      </StackPanel>
                    </Grid>

                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Bottom Spacer (60dp fuer Ad-Banner Overlay) -->
          <Border Height="60" />

        </StackPanel>
      </ScrollViewer>

      <!-- FAB (Add Button) -->
      <Button Background="{DynamicResource AccentBrush}"
              AutomationProperties.AutomationId="Budgets_FabAdd"
              CornerRadius="28"
              Width="56" Height="56"
              HorizontalAlignment="Right"
              VerticalAlignment="Bottom"
              Margin="16"
              Cursor="Hand"
              Command="{Binding ShowAddBudgetDialogCommand}"
              Padding="0">
        <mi:MaterialIcon Kind="Plus" Width="24" Height="24"
                         AutomationProperties.AutomationId="Budgets_Icon_Add"
                         Foreground="White"
                         HorizontalAlignment="Center" VerticalAlignment="Center" />
      </Button>

      <!-- Add/Edit Budget Dialog Overlay -->
      <Border IsVisible="{Binding ShowAddBudget}"
              AutomationProperties.AutomationId="Budgets_OverlayAddEdit"
              Background="#80000000">
        <Border Classes="DialogOverlay"
                AutomationProperties.AutomationId="Budgets_Border_Dialog"
                Background="{DynamicResource CardBrush}"
                CornerRadius="16"
                Padding="24"
                Margin="32"
                VerticalAlignment="Center">
          <StackPanel Spacing="16"
                      AutomationProperties.AutomationId="Budgets_Panel_DialogContent">
            <TextBlock Text="{Binding SetBudgetText}"
                       AutomationProperties.AutomationId="Budgets_TxtDialogTitle"
                       FontSize="20" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

            <StackPanel Spacing="8">
              <TextBlock Text="{Binding CategoryText}" FontSize="14"
                         AutomationProperties.AutomationId="Budgets_TxtCategoryLabel"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <ComboBox ItemsSource="{Binding AvailableCategories}"
                        AutomationProperties.AutomationId="Budgets_ComboCategory"
                        SelectedItem="{Binding SelectedCategory}"
                        IsEnabled="{Binding !IsEditing}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                        HorizontalAlignment="Stretch" />
            </StackPanel>

            <StackPanel Spacing="8">
              <TextBlock Text="{Binding MonthlyLimitEuroText}" FontSize="14"
                         AutomationProperties.AutomationId="Budgets_TxtLimitLabel"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBox Text="{Binding MonthlyLimit}"
                       AutomationProperties.AutomationId="Budgets_InputLimit"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Background="{DynamicResource SurfaceBrush}" />
            </StackPanel>

            <StackPanel Spacing="8">
              <TextBlock Text="{Binding WarningThresholdText}" FontSize="14"
                         AutomationProperties.AutomationId="Budgets_TxtThresholdLabel"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBox Text="{Binding WarningThreshold}"
                       AutomationProperties.AutomationId="Budgets_InputThreshold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       Background="{DynamicResource SurfaceBrush}" />
              <TextBlock Text="{Binding WarningThresholdHintText}"
                         AutomationProperties.AutomationId="Budgets_TxtThresholdHint"
                         FontSize="11"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
            </StackPanel>

            <Grid ColumnDefinitions="*,*" ColumnSpacing="12"
                  AutomationProperties.AutomationId="Budgets_Panel_DialogButtons">
              <Button Content="{Binding CancelText}"
                      AutomationProperties.AutomationId="Budgets_BtnCancel"
                      Command="{Binding CancelAddBudgetCommand}"
                      Classes="Secondary" />
              <Button Grid.Column="1"
                      AutomationProperties.AutomationId="Budgets_BtnSave"
                      Content="{Binding SaveText}"
                      Command="{Binding SaveBudgetCommand}"
                      Classes="Primary" />
            </Grid>
          </StackPanel>
        </Border>
      </Border>

      <!-- Undo Delete Snackbar mit Countdown-Balken -->
      <Border IsVisible="{Binding ShowUndoDelete}"
              AutomationProperties.AutomationId="Budgets_SnackbarUndo"
              Background="{DynamicResource CardBrush}"
              CornerRadius="12"
              Padding="16,12"
              Margin="16"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Bottom"
              ZIndex="100">
        <StackPanel Spacing="8">
          <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
            <TextBlock Grid.Column="0"
                       AutomationProperties.AutomationId="Budgets_TxtUndoMessage"
                       Text="{Binding UndoMessage}"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       FontSize="14"
                       VerticalAlignment="Center"
                       TextTrimming="CharacterEllipsis" />
            <Button Grid.Column="1"
                    AutomationProperties.AutomationId="Budgets_BtnUndo"
                    Content="{Binding UndoText}"
                    Command="{Binding UndoDeleteCommand}"
                    Classes="Primary"
                    Padding="16,8" />
            <Button Grid.Column="2" Classes="Text"
                    AutomationProperties.AutomationId="Budgets_BtnDismissUndo"
                    Command="{Binding DismissUndoCommand}"
                    Width="36" Height="36" Padding="0">
              <mi:MaterialIcon Kind="Close" Width="18" Height="18"
                               AutomationProperties.AutomationId="Budgets_Icon_DismissUndo"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
            </Button>
          </Grid>
          <!-- Undo-Countdown-Balken -->
          <Border Classes="UndoTimer" Height="3" CornerRadius="2"
                  AutomationProperties.AutomationId="Budgets_Border_UndoTimer"
                  Background="{DynamicResource AccentBrush}" />
        </StackPanel>
      </Border>

    </Panel>

  </Grid>

</UserControl>
