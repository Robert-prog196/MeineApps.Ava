<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FinanzRechner.ViewModels"
             xmlns:models="using:FinanzRechner.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:conv="using:FinanzRechner.Converters"
             x:Class="FinanzRechner.Views.RecurringTransactionsView"
             x:DataType="vm:RecurringTransactionsViewModel">

  <Grid RowDefinitions="Auto,*">

    <!-- Header -->
    <Grid Grid.Row="0" ColumnDefinitions="Auto,*" Margin="16,0,16,16">
      <!-- Back Button -->
      <Button Grid.Column="0" Classes="Text"
              Command="{Binding GoBackCommand}"
              Width="48" Height="48" Padding="0">
        <mi:MaterialIcon Kind="ArrowLeft" Width="20" Height="20"
                         Foreground="{DynamicResource PrimaryBrush}" />
      </Button>
      <TextBlock Grid.Column="1"
                 Text="{Binding RecurringTransactionsTitleText}"
                 Classes="PageTitle"
                 VerticalAlignment="Center" />
    </Grid>

    <!-- Content -->
    <Panel Grid.Row="1">

      <!-- Empty State -->
      <StackPanel IsVisible="{Binding !HasTransactions}"
                  HorizontalAlignment="Center" VerticalAlignment="Center"
                  Spacing="8">
        <mi:MaterialIcon Kind="CalendarClock" Width="48" Height="48"
                         Foreground="{DynamicResource TextMutedBrush}"
                         HorizontalAlignment="Center" />
        <TextBlock Text="{Binding NoRecurringText}"
                   FontSize="16" FontWeight="Bold"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   HorizontalAlignment="Center" />
        <TextBlock Text="{Binding NoRecurringHintText}"
                   FontSize="13"
                   Foreground="{DynamicResource TextMutedBrush}"
                   HorizontalAlignment="Center" />
      </StackPanel>

      <!-- Recurring Transactions List (mit farbigem Seitenstreifen + Countdown) -->
      <ScrollViewer IsVisible="{Binding HasTransactions}">
        <StackPanel Spacing="12" Margin="16,0">
          <ItemsControl ItemsSource="{Binding DisplayItems}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="{DynamicResource CardBrush}"
                        CornerRadius="12"
                        Padding="0"
                        Margin="0,0,0,8"
                        Cursor="Hand"
                        Opacity="{Binding Transaction.IsActive, Converter={x:Static conv:BoolToDoubleConverter.Instance}, ConverterParameter='1,0.5'}">
                  <Grid ColumnDefinitions="4,*">
                    <!-- Farbiger Seitenstreifen (Kategorie-Farbe) -->
                    <Border Grid.Column="0"
                            CornerRadius="12,0,0,12"
                            Background="{Binding Transaction.Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}" />

                    <!-- Content -->
                    <Grid Grid.Column="1" Margin="12,12,16,12"
                          ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                      <!-- Farbiges Kategorie-Icon -->
                      <Border Grid.Row="0" Grid.RowSpan="3" Grid.Column="0"
                              Background="{Binding Transaction.Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}, ConverterParameter=0.2}"
                              CornerRadius="10"
                              Width="40" Height="40"
                              VerticalAlignment="Top"
                              Margin="0,0,12,0">
                        <mi:MaterialIcon Kind="{Binding Transaction.Category, Converter={x:Static conv:CategoryToIconConverter.Instance}}"
                                         Width="20" Height="20"
                                         Foreground="{Binding Transaction.Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                                         HorizontalAlignment="Center" VerticalAlignment="Center" />
                      </Border>

                      <!-- Beschreibung (durchgestrichen bei inaktiv) -->
                      <Panel Grid.Row="0" Grid.Column="1">
                        <TextBlock Text="{Binding Transaction.Description}"
                                   FontSize="15" FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   IsVisible="{Binding Transaction.IsActive}" />
                        <TextBlock Text="{Binding Transaction.Description}"
                                   FontSize="15" FontWeight="Bold"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   TextDecorations="Strikethrough"
                                   IsVisible="{Binding !Transaction.IsActive}" />
                      </Panel>

                      <!-- Pattern & Category -->
                      <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="{Binding Transaction.Pattern, Converter={x:Static conv:PatternToStringConverter.Instance}}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="·" FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="{Binding Transaction.Category, Converter={x:Static conv:CategoryToStringConverter.Instance}}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                      </StackPanel>

                      <!-- Fälligkeits-Countdown -->
                      <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Spacing="4"
                                  IsVisible="{Binding Transaction.IsActive}">
                        <mi:MaterialIcon Kind="CalendarClock" Width="12" Height="12"
                                         Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding DueDateDisplay}"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{DynamicResource AccentBrush}" />
                      </StackPanel>

                      <!-- Betrag (rot für Ausgaben, grün für Einnahmen) -->
                      <StackPanel Grid.Row="0" Grid.RowSpan="2" Grid.Column="2"
                                  VerticalAlignment="Top" Spacing="4">
                        <TextBlock FontSize="16" FontWeight="Bold"
                                   TextAlignment="Right"
                                   Foreground="{Binding Transaction.Type, Converter={x:Static conv:TransactionTypeToColorConverter.Instance}}">
                          <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0}{1:N2} €">
                              <Binding Path="Transaction.Type" Converter="{x:Static conv:TransactionTypeToPrefixConverter.Instance}" />
                              <Binding Path="Transaction.Amount" />
                            </MultiBinding>
                          </TextBlock.Text>
                        </TextBlock>

                        <!-- Aktiv/Inaktiv Badge -->
                        <Panel HorizontalAlignment="Right">
                          <Border Background="{DynamicResource IncomeBrush}"
                                  CornerRadius="4" Padding="6,2"
                                  IsVisible="{Binding Transaction.IsActive}">
                            <TextBlock Text="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).ActiveText}"
                                       FontSize="10" FontWeight="Bold" Foreground="White" />
                          </Border>
                          <Border Background="{DynamicResource TextMutedBrush}"
                                  CornerRadius="4" Padding="6,2"
                                  IsVisible="{Binding !Transaction.IsActive}">
                            <TextBlock Text="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).InactiveText}"
                                       FontSize="10" FontWeight="Bold" Foreground="White" />
                          </Border>
                        </Panel>
                      </StackPanel>

                      <!-- Action Buttons -->
                      <StackPanel Grid.Row="2" Grid.Column="2" Orientation="Horizontal" Spacing="4"
                                  HorizontalAlignment="Right">
                        <Button Classes="Text" Padding="6" Width="32" Height="32"
                                Command="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).EditTransactionCommand}"
                                CommandParameter="{Binding Transaction}"
                                ToolTip.Tip="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).EditTooltipText}">
                          <mi:MaterialIcon Kind="Pencil" Width="16" Height="16"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                        </Button>
                        <Button Classes="Text" Padding="6" Width="32" Height="32"
                                Command="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).DeleteTransactionCommand}"
                                CommandParameter="{Binding Transaction}"
                                ToolTip.Tip="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).DeleteTooltipText}">
                          <mi:MaterialIcon Kind="Delete" Width="16" Height="16"
                                           Foreground="{DynamicResource ExpenseBrush}" />
                        </Button>
                        <Button Classes="Text" Padding="6" Width="32" Height="32"
                                Command="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).ToggleActiveCommand}"
                                CommandParameter="{Binding Transaction}">
                          <mi:MaterialIcon Kind="ToggleSwitch" Width="16" Height="16"
                                           Foreground="{DynamicResource PrimaryBrush}" />
                        </Button>
                      </StackPanel>
                    </Grid>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Bottom Spacer (60dp fuer Ad-Banner Overlay) -->
          <Border Height="60" />
        </StackPanel>
      </ScrollViewer>

      <!-- FAB (Add Button) -->
      <Button Background="{DynamicResource PrimaryBrush}"
              CornerRadius="28"
              Width="56" Height="56"
              HorizontalAlignment="Right"
              VerticalAlignment="Bottom"
              Margin="16,0,16,16"
              Cursor="Hand"
              Command="{Binding ShowAddFormCommand}"
              Padding="0">
        <mi:MaterialIcon Kind="Plus" Width="24" Height="24"
                         Foreground="White"
                         HorizontalAlignment="Center" VerticalAlignment="Center" />
      </Button>

      <!-- Add/Edit Dialog Overlay -->
      <Border IsVisible="{Binding ShowAddDialog}"
              Background="#80000000">
        <Border Classes="DialogOverlay"
                Background="{DynamicResource CardBrush}"
                CornerRadius="16"
                Padding="24"
                Margin="20"
                VerticalAlignment="Center"
                MaxWidth="400">
          <ScrollViewer>
            <StackPanel Spacing="16">
              <TextBlock Text="{Binding RecurringTransactionText}"
                         Classes="SectionHeader" />

              <!-- Transaction Type Toggle -->
              <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <!-- Ausgabe -->
                <Panel Grid.Column="0">
                  <Button Command="{Binding SetTransactionTypeExpenseCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,14"
                          Background="#33EF4444" BorderBrush="#EF4444" BorderThickness="2"
                          CornerRadius="12"
                          IsVisible="{Binding IsExpenseSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowDownBold" Width="18" Height="18" Foreground="#EF4444" />
                      <TextBlock Text="{Binding ExpenseText}" FontSize="14" FontWeight="Bold" Foreground="#EF4444" />
                    </StackPanel>
                  </Button>
                  <Button Command="{Binding SetTransactionTypeExpenseCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,14"
                          Background="{DynamicResource SurfaceBrush}" BorderThickness="1"
                          BorderBrush="{DynamicResource BorderSubtleBrush}"
                          CornerRadius="12"
                          IsVisible="{Binding !IsExpenseSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowDownBold" Width="18" Height="18"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                      <TextBlock Text="{Binding ExpenseText}" FontSize="14"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
                    </StackPanel>
                  </Button>
                </Panel>

                <!-- Einnahme -->
                <Panel Grid.Column="1">
                  <Button Command="{Binding SetTransactionTypeIncomeCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,14"
                          Background="#3322C55E" BorderBrush="#22C55E" BorderThickness="2"
                          CornerRadius="12"
                          IsVisible="{Binding IsIncomeSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowUpBold" Width="18" Height="18" Foreground="#22C55E" />
                      <TextBlock Text="{Binding IncomeText}" FontSize="14" FontWeight="Bold" Foreground="#22C55E" />
                    </StackPanel>
                  </Button>
                  <Button Command="{Binding SetTransactionTypeIncomeCommand}"
                          HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                          Padding="12,14"
                          Background="{DynamicResource SurfaceBrush}" BorderThickness="1"
                          BorderBrush="{DynamicResource BorderSubtleBrush}"
                          CornerRadius="12"
                          IsVisible="{Binding !IsIncomeSelected}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <mi:MaterialIcon Kind="ArrowUpBold" Width="18" Height="18"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                      <TextBlock Text="{Binding IncomeText}" FontSize="14"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
                    </StackPanel>
                  </Button>
                </Panel>
              </Grid>

              <TextBox Watermark="{Binding DescriptionWatermarkText}"
                       Text="{Binding Description}"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

              <TextBox Watermark="{Binding AmountWatermarkText}"
                       Text="{Binding Amount}"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

              <!-- Kategorie-Chips mit farbigem Hintergrund -->
              <ItemsControl ItemsSource="{Binding CategoryItems}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Panel Margin="0,0,6,6">
                      <!-- Selected: Volle Kategorie-Farbe -->
                      <Button CornerRadius="16" Padding="10,6" MinHeight="40" Cursor="Hand"
                              Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                              BorderBrush="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}}"
                              BorderThickness="2"
                              IsVisible="{Binding IsSelected}"
                              Command="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).SelectCategoryCommand}"
                              CommandParameter="{Binding}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                          <TextBlock Text="{Binding CategoryDisplay}" FontSize="16" VerticalAlignment="Center" Foreground="White" />
                          <TextBlock Text="{Binding CategoryName}" FontSize="13" VerticalAlignment="Center" Foreground="White" FontWeight="Bold" />
                        </StackPanel>
                      </Button>
                      <!-- Unselected: Transparenter Kategorie-Hintergrund -->
                      <Button CornerRadius="16" Padding="10,6" MinHeight="40" Cursor="Hand"
                              Background="{Binding Category, Converter={x:Static conv:CategoryToColorBrushConverter.Instance}, ConverterParameter=0.15}"
                              BorderThickness="0"
                              IsVisible="{Binding !IsSelected}"
                              Command="{Binding $parent[UserControl].((vm:RecurringTransactionsViewModel)DataContext).SelectCategoryCommand}"
                              CommandParameter="{Binding}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                          <TextBlock Text="{Binding CategoryDisplay}" FontSize="16" VerticalAlignment="Center" />
                          <TextBlock Text="{Binding CategoryName}" FontSize="13" VerticalAlignment="Center"
                                     Foreground="{DynamicResource TextPrimaryBrush}" />
                        </StackPanel>
                      </Button>
                    </Panel>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>

              <ComboBox ItemsSource="{Binding Patterns}"
                        SelectedItem="{Binding SelectedPattern}"
                        PlaceholderText="{Binding PatternLabelText}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                        HorizontalAlignment="Stretch">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding Converter={x:Static conv:PatternToStringConverter.Instance}}" />
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>

              <CalendarDatePicker SelectedDate="{Binding StartDate}"
                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                  HorizontalAlignment="Stretch" />

              <StackPanel Orientation="Horizontal" Spacing="12">
                <CheckBox IsChecked="{Binding HasEndDate}" />
                <TextBlock Text="{Binding SetEndDateText}"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextPrimaryBrush}" />
              </StackPanel>

              <CalendarDatePicker SelectedDate="{Binding EndDate}"
                                  IsVisible="{Binding HasEndDate}"
                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                  HorizontalAlignment="Stretch" />

              <TextBox Watermark="{Binding NoteWatermarkText}"
                       Text="{Binding Note}"
                       Foreground="{DynamicResource TextPrimaryBrush}" />

              <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                <Button Grid.Column="0"
                        Content="{Binding CancelText}"
                        Classes="Secondary"
                        Command="{Binding CancelAddDialogCommand}" />
                <Button Grid.Column="1"
                        Content="{Binding SaveText}"
                        Classes="Primary"
                        Command="{Binding SaveTransactionCommand}" />
              </Grid>
            </StackPanel>
          </ScrollViewer>
        </Border>
      </Border>

      <!-- Undo Delete Snackbar mit Countdown-Balken -->
      <Border IsVisible="{Binding ShowUndoDelete}"
              Background="{DynamicResource CardBrush}"
              CornerRadius="12"
              Padding="16,12"
              Margin="16"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Bottom"
              ZIndex="100">
        <StackPanel Spacing="8">
          <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
            <TextBlock Grid.Column="0"
                       Text="{Binding UndoMessage}"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       FontSize="14"
                       VerticalAlignment="Center"
                       TextTrimming="CharacterEllipsis" />
            <Button Grid.Column="1"
                    Content="{Binding UndoText}"
                    Command="{Binding UndoDeleteCommand}"
                    Classes="Primary"
                    Padding="16,8" />
            <Button Grid.Column="2" Classes="Text"
                    Command="{Binding DismissUndoCommand}"
                    Width="36" Height="36" Padding="0">
              <mi:MaterialIcon Kind="Close" Width="18" Height="18"
                               Foreground="{DynamicResource TextMutedBrush}" />
            </Button>
          </Grid>
          <!-- Undo-Countdown-Balken -->
          <Border Classes="UndoTimer" Height="3" CornerRadius="2"
                  Background="{DynamicResource AccentBrush}" />
        </StackPanel>
      </Border>

    </Panel>

  </Grid>

</UserControl>
