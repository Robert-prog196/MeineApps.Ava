<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:models="using:HandwerkerImperium.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.WorkerMarketView"
             x:DataType="vm:WorkerMarketViewModel">

  <Grid RowDefinitions="Auto,*">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Classes="CardElevated"
            Padding="16,12"
            CornerRadius="0,0,12,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Back Button -->
        <Button Classes="Text"
                Command="{Binding GoBackCommand}">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24" />
        </Button>

        <!-- Title (centered) -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Spacing="8">
          <mi:MaterialIcon Kind="AccountGroup" Width="28" Height="28"
                           Foreground="{DynamicResource TextPrimaryBrush}" />
          <TextBlock Text="{Binding Title}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}" />
        </StackPanel>

        <!-- Balance Badges -->
        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
          <!-- Goldschrauben-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <mi:MaterialIcon Kind="ScrewFlatTop" Width="16" Height="16" Foreground="#FFD700" />
              <TextBlock Text="{Binding GoldenScrewsDisplay}" FontSize="14" FontWeight="Bold"
                         Foreground="#FFD700" />
            </StackPanel>
          </Border>
          <!-- Euro-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4">
            <TextBlock Text="{Binding CurrentBalance}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="{DynamicResource SuccessBrush}" />
          </Border>
        </StackPanel>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- CONTENT                                                           -->
    <!-- ================================================================= -->
    <ScrollViewer Grid.Row="1" Padding="16">
      <StackPanel Spacing="16">

        <!-- ROTATION TIMER -->
        <Border Classes="CardElevated" Padding="16">
          <Grid ColumnDefinitions="*,Auto">
            <StackPanel Spacing="4">
              <TextBlock Text="{Binding NextRotationLabel}"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding TimeUntilRotation}"
                         FontSize="24" FontWeight="Bold"
                         Foreground="{DynamicResource PrimaryBrush}" />
            </StackPanel>

            <!-- Refresh via Video-Ad Button -->
            <Button Grid.Column="1"
                    Classes="Secondary"
                    Command="{Binding RefreshWithAdCommand}"
                    VerticalAlignment="Center"
                    Padding="12,8">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <mi:MaterialIcon Kind="Video" Width="18" Height="18" />
                <TextBlock Text="{Binding RefreshButtonText}" FontSize="13" />
              </StackPanel>
            </Button>
          </Grid>
        </Border>

        <!-- KEINE FREIEN PLAETZE INFO -->
        <Border Classes="CardElevated" Padding="16,24"
                IsVisible="{Binding !HasAvailableSlots}">
          <StackPanel HorizontalAlignment="Center" Spacing="8"
                      Margin="16,0">
            <mi:MaterialIcon Kind="AccountOff" Width="48" Height="48"
                             Foreground="{DynamicResource WarningBrush}"
                             HorizontalAlignment="Center" />
            <TextBlock Text="{Binding NoSlotsMessage}"
                       FontSize="14"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       TextAlignment="Center" />
          </StackPanel>
        </Border>

        <!-- WORKER CARDS (nur sichtbar wenn Plätze frei) -->
        <ItemsControl ItemsSource="{Binding AvailableWorkers}"
                      IsVisible="{Binding HasAvailableSlots}">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:Worker">
              <Border Classes="Card" Margin="0,0,0,12" Padding="16">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                      ColumnDefinitions="*,Auto"
                      RowSpacing="8">

                  <!-- Row 0: Name + Tier Badge -->
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Name}"
                               FontSize="16" FontWeight="Bold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               VerticalAlignment="Center" />
                    <Border Background="{DynamicResource PrimaryBrush}"
                            CornerRadius="4"
                            Padding="8,2">
                      <TextBlock Text="{Binding Tier}"
                                 FontSize="12" FontWeight="Bold"
                                 Foreground="White" />
                    </Border>
                  </StackPanel>

                  <!-- Row 0, Col 1: Wage -->
                  <TextBlock Grid.Column="1"
                             Text="{Binding WagePerHour, StringFormat='{}{0:N0} €/h'}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource WarningBrush}"
                             VerticalAlignment="Center" />

                  <!-- Row 1: Personality + Talent Stars + Specialization -->
                  <StackPanel Grid.Row="1" Grid.ColumnSpan="2"
                              Orientation="Horizontal" Spacing="12">
                    <!-- Personality -->
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="{Binding PersonalityIcon}"
                                 FontSize="14" VerticalAlignment="Center" />
                      <TextBlock Text="{Binding Personality}"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 VerticalAlignment="Center" />
                    </StackPanel>

                    <!-- Talent Stars -->
                    <StackPanel Orientation="Horizontal" Spacing="2">
                      <mi:MaterialIcon Kind="Star" Width="14" Height="14"
                                       Foreground="#FFC107" />
                      <TextBlock Text="{Binding Talent}"
                                 FontSize="12" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center" />
                    </StackPanel>
                  </StackPanel>

                  <!-- Row 2: Specialization + Efficiency -->
                  <StackPanel Grid.Row="2" Grid.ColumnSpan="2"
                              Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="{Binding Specialization}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                    <TextBlock Text="{Binding EffectiveEfficiency, StringFormat='Eff: {0:P0}'}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                  </StackPanel>

                  <!-- Row 3: Hire Button -->
                  <Button Grid.Row="3" Grid.ColumnSpan="2"
                          Classes="Primary"
                          HorizontalAlignment="Stretch"
                          Padding="12,8"
                          Command="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).HireWorkerCommand}"
                          CommandParameter="{Binding .}">
                    <StackPanel Orientation="Horizontal"
                                Spacing="6"
                                HorizontalAlignment="Center">
                      <mi:MaterialIcon Kind="AccountPlus" Width="16" Height="16" />
                      <TextBlock Text="{Binding HiringCost, StringFormat='{}{0:N0} €'}"
                                 FontSize="13" FontWeight="SemiBold" />
                      <!-- Goldschrauben-Kosten (nur Tier A+S) -->
                      <StackPanel Orientation="Horizontal" Spacing="2"
                                  IsVisible="{Binding HiringScrewCost}">
                        <TextBlock Text="+" FontSize="13" FontWeight="SemiBold" />
                        <mi:MaterialIcon Kind="ScrewFlatTop" Width="14" Height="14"
                                         Foreground="#FFD700" />
                        <TextBlock Text="{Binding HiringScrewCost}"
                                   FontSize="13" FontWeight="SemiBold"
                                   Foreground="#FFD700" />
                      </StackPanel>
                    </StackPanel>
                  </Button>

                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- EMPTY STATE (Pool leer aber Plaetze frei → nur wenn HasAvailableSlots) -->
        <!-- Wird NICHT angezeigt wenn "Keine freien Plaetze" Banner sichtbar ist -->

        <!-- Bottom Spacer -->
        <Border Height="60" />

      </StackPanel>
    </ScrollViewer>

  </Grid>

</UserControl>
