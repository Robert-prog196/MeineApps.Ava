<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:models="using:HandwerkerImperium.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.WorkerMarketView"
             x:DataType="vm:WorkerMarketViewModel">

  <Grid RowDefinitions="Auto,*">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Padding="16,12"
            CornerRadius="0,0,12,12">
      <Border.Background>
        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
          <GradientStop Color="#92400E" Offset="0" />
          <GradientStop Color="#451A03" Offset="1" />
        </LinearGradientBrush>
      </Border.Background>
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Back Button -->
        <Button Classes="Text"
                Command="{Binding GoBackCommand}">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24"
                           Foreground="{StaticResource CraftPrimaryLightBrush}" />
        </Button>

        <!-- Title (centered) -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="8">
          <mi:MaterialIcon Kind="AccountGroup" Width="28" Height="28"
                           Foreground="{StaticResource CraftPrimaryLightBrush}" />
          <TextBlock Text="{Binding Title}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{StaticResource CraftPrimaryLightBrush}" />
        </StackPanel>

        <!-- Balance Badges -->
        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8"
                    VerticalAlignment="Center">
          <!-- Goldschrauben-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <mi:MaterialIcon Kind="ScrewFlatTop" Width="16" Height="16" Foreground="#FFD700" />
              <TextBlock Text="{Binding GoldenScrewsDisplay}" FontSize="14" FontWeight="Bold"
                         Foreground="#FFD700" />
            </StackPanel>
          </Border>
          <!-- Euro-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4">
            <TextBlock Text="{Binding CurrentBalance}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="{DynamicResource SuccessBrush}" />
          </Border>
        </StackPanel>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- CONTENT                                                           -->
    <!-- ================================================================= -->
    <ScrollViewer Grid.Row="1" Padding="16">
      <StackPanel Spacing="16">

        <!-- ROTATION TIMER -->
        <Border Classes="CardElevated" Padding="16">
          <Grid ColumnDefinitions="*,Auto">
            <StackPanel Spacing="4">
              <TextBlock Text="{Binding NextRotationLabel}"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}" />
              <TextBlock Text="{Binding TimeUntilRotation}"
                         FontSize="24" FontWeight="Bold"
                         Foreground="{StaticResource CraftPrimaryLightBrush}" />
            </StackPanel>

            <!-- Refresh via Video-Ad Button -->
            <Button Grid.Column="1"
                    Classes="Secondary"
                    Command="{Binding RefreshWithAdCommand}"
                    VerticalAlignment="Center"
                    Padding="12,8">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <mi:MaterialIcon Kind="Video" Width="18" Height="18" />
                <TextBlock Text="{Binding RefreshButtonText}" FontSize="13" />
              </StackPanel>
            </Button>
          </Grid>
        </Border>

        <!-- KEINE FREIEN PLAETZE INFO (Warnung, blockiert nicht den Markt) -->
        <Border Classes="CardElevated" Padding="16,12"
                IsVisible="{Binding !HasAvailableSlots}">
          <StackPanel Spacing="10">
            <StackPanel Orientation="Horizontal" Spacing="12"
                        HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="AlertCircleOutline" Width="24" Height="24"
                               Foreground="{DynamicResource WarningBrush}" />
              <TextBlock Text="{Binding NoSlotsMessage}"
                         FontSize="13"
                         Foreground="{DynamicResource WarningBrush}"
                         TextWrapping="Wrap"
                         VerticalAlignment="Center" />
            </StackPanel>

            <!-- Extra-Slot per Video-Ad Button -->
            <Button Classes="Secondary"
                    Command="{Binding WatchAdForWorkerSlotCommand}"
                    IsVisible="{Binding ShowExtraSlotButton}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,8">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <mi:MaterialIcon Kind="Video" Width="18" Height="18"
                                 Foreground="{StaticResource CraftPrimaryLightBrush}" />
                <TextBlock Text="{loc:Translate WatchAdForWorkerSlot}" FontSize="13" />
              </StackPanel>
            </Button>
          </StackPanel>
        </Border>

        <!-- WORKER CARDS (immer sichtbar, Hire-Button disabled wenn keine Plaetze) -->
        <ItemsControl ItemsSource="{Binding AvailableWorkers}">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:Worker">
              <Border Classes="Card" Margin="0,0,0,12" Padding="16">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                      ColumnDefinitions="*,Auto"
                      RowSpacing="8">

                  <!-- Row 0: Name + Tier Badge -->
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Name}"
                               FontSize="16" FontWeight="Bold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               VerticalAlignment="Center" />
                    <Border Background="{StaticResource CraftPrimaryBrush}"
                            CornerRadius="4"
                            Padding="8,2">
                      <TextBlock Text="{Binding Tier}"
                                 FontSize="12" FontWeight="Bold"
                                 Foreground="White" />
                    </Border>
                  </StackPanel>

                  <!-- Row 0, Col 1: Wage -->
                  <TextBlock Grid.Column="1"
                             Text="{Binding WagePerHour, StringFormat='{}{0:N0} €/h'}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource WarningBrush}"
                             VerticalAlignment="Center" />

                  <!-- Row 1: Personality + Talent Stars + Specialization -->
                  <StackPanel Grid.Row="1" Grid.ColumnSpan="2"
                              Orientation="Horizontal" Spacing="12">
                    <!-- Personality -->
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="{Binding PersonalityIcon}"
                                 FontSize="14" VerticalAlignment="Center" />
                      <TextBlock Text="{Binding Personality}"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 VerticalAlignment="Center" />
                    </StackPanel>

                    <!-- Talent Stars -->
                    <StackPanel Orientation="Horizontal" Spacing="2">
                      <mi:MaterialIcon Kind="Star" Width="14" Height="14"
                                       Foreground="#FFC107" />
                      <TextBlock Text="{Binding Talent}"
                                 FontSize="12" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center" />
                    </StackPanel>
                  </StackPanel>

                  <!-- Row 2: Specialization + Efficiency + Mehrwert -->
                  <StackPanel Grid.Row="2" Grid.ColumnSpan="2"
                              Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="{Binding Specialization}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                    <TextBlock FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}">
                      <Run Text="Eff:" />
                      <Run Text="{Binding Efficiency, StringFormat='{}{0:P0}'}" FontWeight="SemiBold" />
                    </TextBlock>
                    <TextBlock Text="{Binding IncomeContributionDisplay}"
                               FontSize="12" FontWeight="SemiBold"
                               Foreground="{DynamicResource SuccessBrush}"
                               IsVisible="{Binding IncomeContribution}" />
                  </StackPanel>

                  <!-- Row 3: Hire Button (disabled wenn keine Plaetze frei) -->
                  <Button Grid.Row="3" Grid.ColumnSpan="2"
                          Classes="Primary"
                          HorizontalAlignment="Stretch"
                          Padding="12,8"
                          IsEnabled="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).HasAvailableSlots}"
                          Command="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).HireWorkerCommand}"
                          CommandParameter="{Binding .}">
                    <StackPanel Orientation="Horizontal"
                                Spacing="6"
                                HorizontalAlignment="Center">
                      <mi:MaterialIcon Kind="AccountPlus" Width="16" Height="16" />
                      <TextBlock Text="{Binding HiringCost, StringFormat='{}{0:N0} €'}"
                                 FontSize="13" FontWeight="SemiBold" />
                      <!-- Goldschrauben-Kosten (nur Tier A+S) -->
                      <StackPanel Orientation="Horizontal" Spacing="2"
                                  IsVisible="{Binding HiringScrewCost}">
                        <TextBlock Text="+" FontSize="13" FontWeight="SemiBold" />
                        <mi:MaterialIcon Kind="ScrewFlatTop" Width="14" Height="14"
                                         Foreground="#FFD700" />
                        <TextBlock Text="{Binding HiringScrewCost}"
                                   FontSize="13" FontWeight="SemiBold"
                                   Foreground="#FFD700" />
                      </StackPanel>
                    </StackPanel>
                  </Button>

                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Bottom Spacer -->
        <Border Height="60" />

      </StackPanel>
    </ScrollViewer>

    <!-- ================================================================= -->
    <!-- WORKSHOP-AUSWAHL OVERLAY (Bug 3: Spieler waehlt Workshop)        -->
    <!-- ================================================================= -->
    <Border Grid.RowSpan="2"
            ZIndex="50"
            IsVisible="{Binding ShowWorkshopSelection}"
            Background="#AA000000">
      <Border Background="{DynamicResource BackgroundBrush}"
              BorderBrush="{StaticResource CraftPrimaryBrush}"
              BorderThickness="2"
              MaxWidth="400"
              Margin="24"
              Padding="20"
              CornerRadius="16"
              VerticalAlignment="Center"
              HorizontalAlignment="Center"
              BoxShadow="0 8 24 0 #40000000">
        <StackPanel Spacing="16">

          <!-- Overlay-Titel -->
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="Factory" Width="24" Height="24"
                             Foreground="{StaticResource CraftPrimaryLightBrush}" />
            <TextBlock Text="{Binding SelectWorkshopTitle}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />
          </StackPanel>

          <!-- Pendender Worker Info -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="8" Padding="12,8">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="AccountPlus" Width="18" Height="18"
                               Foreground="{StaticResource CraftPrimaryLightBrush}" />
              <TextBlock Text="{Binding PendingWorker.Name}"
                         FontSize="14" FontWeight="SemiBold"
                         Foreground="{DynamicResource TextPrimaryBrush}" />
              <Border Background="{StaticResource CraftPrimaryBrush}"
                      CornerRadius="4" Padding="6,2">
                <TextBlock Text="{Binding PendingWorker.Tier}"
                           FontSize="11" FontWeight="Bold" Foreground="White" />
              </Border>
            </StackPanel>
          </Border>

          <!-- Workshop-Liste -->
          <ItemsControl ItemsSource="{Binding WorkshopSelections}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:WorkshopSelectionItem">
                <Button Classes="Outlined"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch"
                        Margin="0,0,0,8"
                        Padding="16,14"
                        MinHeight="56"
                        Command="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).ConfirmWorkshopSelectionCommand}"
                        CommandParameter="{Binding .}">
                  <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Spacing="4">
                      <TextBlock Text="{Binding Name}"
                                 FontSize="15" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TextPrimaryBrush}" />
                      <TextBlock Text="{Binding WorkerInfo}"
                                 FontSize="13"
                                 Foreground="{DynamicResource TextSecondaryBrush}" />
                    </StackPanel>
                    <mi:MaterialIcon Grid.Column="1" Kind="ChevronRight"
                                     Width="24" Height="24"
                                     Foreground="{StaticResource CraftPrimaryLightBrush}"
                                     VerticalAlignment="Center" />
                  </Grid>
                </Button>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Abbrechen Button -->
          <Button Classes="Secondary"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Command="{Binding CancelWorkshopSelectionCommand}"
                  Padding="12,10">
            <TextBlock Text="{Binding CancelText}"
                       FontSize="14" />
          </Button>

        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
