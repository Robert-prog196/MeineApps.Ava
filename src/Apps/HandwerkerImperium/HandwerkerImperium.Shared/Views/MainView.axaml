<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:views="using:HandwerkerImperium.Views"
             xmlns:miniGames="using:HandwerkerImperium.Views.MiniGames"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:controls="using:MeineApps.UI.Controls"
             x:Class="HandwerkerImperium.Views.MainView"
             x:DataType="vm:MainViewModel">

  <UserControl.Styles>
    <!-- Bottom-Sheet Backdrop: Fade-In/Out -->
    <Style Selector="Border.SheetBackdrop">
      <Setter Property="Opacity" Value="0" />
      <Setter Property="IsHitTestVisible" Value="False" />
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.SheetBackdrop.Open">
      <Setter Property="Opacity" Value="1" />
      <Setter Property="IsHitTestVisible" Value="True" />
    </Style>

    <!-- Bottom-Sheet Panel: Slide-Up/Down -->
    <Style Selector="Border.BottomSheet">
      <Setter Property="RenderTransform" Value="translate(0px, 800px)" />
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3" Easing="CubicEaseOut" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.BottomSheet.Open">
      <Setter Property="RenderTransform" Value="translate(0px, 0px)" />
    </Style>

    <!-- Confirm-Dialog Bottom-Sheet (kleinere Distanz) -->
    <Style Selector="Border.ConfirmSheet">
      <Setter Property="RenderTransform" Value="translate(0px, 400px)" />
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.ConfirmSheet.Open">
      <Setter Property="RenderTransform" Value="translate(0px, 0px)" />
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="*,Auto,Auto">

    <!-- ============================================ -->
    <!-- Hintergrund: Mehrschichtiger Gradient         -->
    <!-- Basis + Primary-Schein oben + warmer Schein   -->
    <!-- unten → tiefes, lebendiges Farbspiel          -->
    <!-- ============================================ -->
    <Panel Grid.RowSpan="3" IsHitTestVisible="False">
      <!-- Basis-Gradient (vertikal, dunkel → Surface → dunkel) -->
      <Border>
        <Border.Background>
          <LinearGradientBrush StartPoint="0%,0%" EndPoint="0%,100%">
            <GradientStop Color="{DynamicResource BackgroundColor}" Offset="0" />
            <GradientStop Color="{DynamicResource SurfaceColor}" Offset="0.45" />
            <GradientStop Color="{DynamicResource BackgroundColor}" Offset="1" />
          </LinearGradientBrush>
        </Border.Background>
      </Border>
      <!-- Oberer Akzent-Schein (Craft-Amber, links oben) -->
      <Border Opacity="0.15">
        <Border.Background>
          <RadialGradientBrush Center="0.15,0.05" RadiusX="0.7" RadiusY="0.35">
            <GradientStop Color="#D97706" Offset="0" />
            <GradientStop Color="Transparent" Offset="1" />
          </RadialGradientBrush>
        </Border.Background>
      </Border>
      <!-- Unterer warmer Schein (Amber/Gold, rechts unten → Handwerker-Atmosphaere) -->
      <Border Opacity="0.12">
        <Border.Background>
          <RadialGradientBrush Center="0.85,0.9" RadiusX="0.6" RadiusY="0.35">
            <GradientStop Color="#F59E0B" Offset="0" />
            <GradientStop Color="Transparent" Offset="1" />
          </RadialGradientBrush>
        </Border.Background>
      </Border>
      <!-- Mittig-rechts: Subtiler Holz/Sienna-Schein -->
      <Border Opacity="0.08">
        <Border.Background>
          <RadialGradientBrush Center="0.9,0.4" RadiusX="0.4" RadiusY="0.3">
            <GradientStop Color="#A0522D" Offset="0" />
            <GradientStop Color="Transparent" Offset="1" />
          </RadialGradientBrush>
        </Border.Background>
      </Border>
    </Panel>

    <!-- ============================================ -->
    <!-- Row 0: Content Area (switches based on tab)  -->
    <!-- ============================================ -->
    <Panel x:Name="ContentPanel" Grid.Row="0">
      <!-- Dashboard Tab (uses MainViewModel directly) -->
      <views:DashboardView IsVisible="{Binding IsDashboardActive}" />

      <!-- Shop Tab -->
      <views:ShopView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsShopActive}"
                      DataContext="{Binding ShopViewModel}" />

      <!-- Statistics Tab -->
      <views:StatisticsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsStatisticsActive}"
                            DataContext="{Binding StatisticsViewModel}" />

      <!-- Achievements Tab -->
      <views:AchievementsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsAchievementsActive}"
                              DataContext="{Binding AchievementsViewModel}" />

      <!-- Settings Tab -->
      <views:SettingsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsSettingsActive}"
                          DataContext="{Binding SettingsViewModel}" />

      <!-- Workshop Detail (overlay when selected) -->
      <views:WorkshopView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsWorkshopDetailActive}"
                          DataContext="{Binding WorkshopViewModel}" />

      <!-- Order Detail (overlay when selected) -->
      <views:OrderView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsOrderDetailActive}"
                       DataContext="{Binding OrderViewModel}" />

      <!-- Worker Market (overlay when selected) -->
      <views:WorkerMarketView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsWorkerMarketActive}"
                              DataContext="{Binding WorkerMarketViewModel}" />

      <!-- Worker Profile → als Bottom-Sheet (siehe unten) -->

      <!-- Buildings (overlay when selected) -->
      <views:BuildingsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsBuildingsActive}"
                           DataContext="{Binding BuildingsViewModel}" />

      <!-- Research (overlay when selected) -->
      <views:ResearchView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsResearchActive}"
                          DataContext="{Binding ResearchViewModel}" />

      <!-- MiniGame Views (overlay when active) -->
      <miniGames:SawingGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsSawingGameActive}"
                                DataContext="{Binding SawingGameViewModel}" />
      <miniGames:PipePuzzleView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsPipePuzzleActive}"
                                DataContext="{Binding PipePuzzleViewModel}" />
      <miniGames:WiringGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsWiringGameActive}"
                                DataContext="{Binding WiringGameViewModel}" />
      <miniGames:PaintingGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsPaintingGameActive}"
                                  DataContext="{Binding PaintingGameViewModel}" />
      <miniGames:RoofTilingGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsRoofTilingGameActive}"
                                    DataContext="{Binding RoofTilingGameViewModel}" />
      <miniGames:BlueprintGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsBlueprintGameActive}"
                                   DataContext="{Binding BlueprintGameViewModel}" />
      <miniGames:DesignPuzzleGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsDesignPuzzleGameActive}"
                                      DataContext="{Binding DesignPuzzleGameViewModel}" />
      <miniGames:InspectionGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsInspectionGameActive}"
                                    DataContext="{Binding InspectionGameViewModel}" />
    </Panel>

    <!-- ============================================ -->
    <!-- Ad Banner Spacer (64dp fuer adaptive Banner) -->
    <Border Grid.Row="1" Height="64"
            IsVisible="{Binding IsAdBannerVisible}" />

    <!-- Ersatz-Spacer wenn Tab-Bar versteckt (Overlay/MiniGame offen) -->
    <!-- Gleiche Hoehe wie Tab-Bar, damit Inhalt ueber der nativen Ad bleibt -->
    <Border Grid.Row="2" Height="68"
            IsVisible="{Binding !IsTabBarVisible}" />

    <!-- Row 2: Floating Tab Bar (abgerundet, leichter Shadow) -->
    <!-- ============================================ -->
    <Border Grid.Row="2"
            Background="{DynamicResource SurfaceBrush}"
            Opacity="0.97"
            CornerRadius="20"
            Margin="12,0,12,8"
            Padding="0,6,0,10"
            BoxShadow="0 -2 12 0 #30000000"
            IsVisible="{Binding IsTabBarVisible}">
      <Grid ColumnDefinitions="*,*,*,*,*">

        <!-- Dashboard -->
        <Button Grid.Column="0" Classes="Text"
                Command="{Binding SelectDashboardTabCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                MinHeight="48">
          <StackPanel Spacing="2" HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="Home" Width="24" Height="24"
                             Foreground="{DynamicResource TextMutedBrush}">
              <mi:MaterialIcon.Styles>
                <Style Selector="mi|MaterialIcon">
                  <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}" />
                </Style>
              </mi:MaterialIcon.Styles>
            </mi:MaterialIcon>
            <TextBlock Text="{loc:Translate Home}"
                       FontSize="9" HorizontalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       Foreground="{DynamicResource TextMutedBrush}" />
            <!-- Pill-Indikator (breiter, abgerundet) -->
            <Border Height="4" Width="24" CornerRadius="2" Margin="0,2,0,0"
                    Background="{StaticResource CraftPrimaryLightBrush}"
                    IsVisible="{Binding IsDashboardActive}" />
          </StackPanel>
        </Button>

        <!-- Workers -->
        <Button Grid.Column="1" Classes="Text"
                Command="{Binding SelectWorkerMarketTabCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                MinHeight="48">
          <StackPanel Spacing="2" HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="AccountGroup" Width="24" Height="24"
                             Foreground="{DynamicResource TextMutedBrush}" />
            <TextBlock Text="{loc:Translate Workers}"
                       FontSize="9" HorizontalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       Foreground="{DynamicResource TextMutedBrush}" />
            <Border Height="4" Width="24" CornerRadius="2" Margin="0,2,0,0"
                    Background="{StaticResource CraftPrimaryLightBrush}"
                    IsVisible="{Binding IsWorkerMarketActive}" />
          </StackPanel>
        </Button>

        <!-- Research -->
        <Button Grid.Column="2" Classes="Text"
                Command="{Binding SelectResearchTabCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                MinHeight="48">
          <StackPanel Spacing="2" HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="FlaskOutline" Width="24" Height="24"
                             Foreground="{DynamicResource TextMutedBrush}" />
            <TextBlock Text="{loc:Translate Research}"
                       FontSize="9" HorizontalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       Foreground="{DynamicResource TextMutedBrush}" />
            <Border Height="4" Width="24" CornerRadius="2" Margin="0,2,0,0"
                    Background="{StaticResource CraftPrimaryLightBrush}"
                    IsVisible="{Binding IsResearchActive}" />
          </StackPanel>
        </Button>

        <!-- Shop -->
        <Button Grid.Column="3" Classes="Text"
                Command="{Binding SelectShopTabCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                MinHeight="48">
          <StackPanel Spacing="2" HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="Cart" Width="24" Height="24"
                             Foreground="{DynamicResource TextMutedBrush}" />
            <TextBlock Text="{loc:Translate Shop}"
                       FontSize="9" HorizontalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       Foreground="{DynamicResource TextMutedBrush}" />
            <Border Height="4" Width="24" CornerRadius="2" Margin="0,2,0,0"
                    Background="{StaticResource CraftPrimaryLightBrush}"
                    IsVisible="{Binding IsShopActive}" />
          </StackPanel>
        </Button>

        <!-- Settings -->
        <Button Grid.Column="4" Classes="Text"
                Command="{Binding SelectSettingsTabCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                MinHeight="48">
          <StackPanel Spacing="2" HorizontalAlignment="Center">
            <mi:MaterialIcon Kind="CogOutline" Width="24" Height="24"
                             Foreground="{DynamicResource TextMutedBrush}" />
            <TextBlock Text="{loc:Translate Settings}"
                       FontSize="9" HorizontalAlignment="Center"
                       TextTrimming="CharacterEllipsis"
                       Foreground="{DynamicResource TextMutedBrush}" />
            <Border Height="4" Width="24" CornerRadius="2" Margin="0,2,0,0"
                    Background="{StaticResource CraftPrimaryLightBrush}"
                    IsVisible="{Binding IsSettingsActive}" />
          </StackPanel>
        </Button>

      </Grid>
    </Border>

    <!-- ============================================ -->
    <!-- Dialog Overlays                              -->
    <!-- ============================================ -->

    <!-- Offline Earnings Dialog -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            IsVisible="{Binding IsOfflineEarningsDialogVisible}">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16" Padding="24"
              MaxWidth="360"
              HorizontalAlignment="Center" VerticalAlignment="Center"
              BoxShadow="0 8 24 0 #40000000">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <!-- Gruener Glow-Halo -->
          <Border Width="72" Height="72" CornerRadius="36"
                  HorizontalAlignment="Center"
                  BoxShadow="0 0 20 0 #4022C55E">
            <Border.Background>
              <RadialGradientBrush Center="0.5,0.5" RadiusX="0.5" RadiusY="0.5">
                <GradientStop Color="#2022C55E" Offset="0" />
                <GradientStop Color="Transparent" Offset="1" />
              </RadialGradientBrush>
            </Border.Background>
            <mi:MaterialIcon Kind="CashMultiple" Width="40" Height="40"
                             Foreground="#22C55E"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
          </Border>
          <TextBlock Text="{loc:Translate WelcomeBack}"
                     FontSize="22" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextPrimaryBrush}" />
          <TextBlock Text="{loc:Translate WhileYouWereAway}"
                     FontSize="14" TextWrapping="Wrap"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <TextBlock Text="{Binding OfflineEarningsAmountText}"
                     FontSize="36" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="#22C55E" />
          <!-- Neuer Rekord Badge -->
          <Border Background="#30FFD700" CornerRadius="12" Padding="12,4"
                  HorizontalAlignment="Center"
                  IsVisible="{Binding IsOfflineNewRecord}"
                  BoxShadow="0 0 12 0 #40FFD700">
            <TextBlock Text="{loc:Translate NewRecord}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="#FFD700"
                       HorizontalAlignment="Center" />
          </Border>
          <TextBlock Text="{Binding OfflineEarningsDurationText}"
                     FontSize="12"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
            <Button Classes="Outlined" Content="{loc:Translate Collect}"
                    Command="{Binding CollectOfflineEarningsNormalCommand}" MinWidth="100" />
            <Button Classes="Primary" MinWidth="140"
                    Background="{StaticResource CraftGoldBrush}"
                    Command="{Binding CollectOfflineEarningsWithAdCommand}">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <mi:MaterialIcon Kind="PlayCircle" Width="18" Height="18" />
                <TextBlock Text="{loc:Translate DoubleWithAd}" VerticalAlignment="Center" />
              </StackPanel>
            </Button>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Level Up Dialog -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            IsVisible="{Binding IsLevelUpDialogVisible}">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16" Padding="24"
              MaxWidth="360"
              HorizontalAlignment="Center" VerticalAlignment="Center"
              BoxShadow="0 0 40 0 #40FFD700">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <!-- Star-Icon mit Gold-Glow-Halo -->
          <Border Width="80" Height="80" CornerRadius="40"
                  HorizontalAlignment="Center"
                  BoxShadow="0 0 24 0 #60FFD700">
            <Border.Background>
              <RadialGradientBrush Center="0.5,0.5" RadiusX="0.5" RadiusY="0.5">
                <GradientStop Color="#40FFD700" Offset="0" />
                <GradientStop Color="Transparent" Offset="1" />
              </RadialGradientBrush>
            </Border.Background>
            <mi:MaterialIcon Kind="Star" Width="48" Height="48"
                             Foreground="#FFD700"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
          </Border>
          <TextBlock Text="{loc:Translate LevelUpTitle}"
                     FontSize="20" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="{StaticResource CraftPrimaryLightBrush}" />
          <TextBlock FontSize="48" FontWeight="Bold" HorizontalAlignment="Center"
                     Foreground="#FFD700">
            <TextBlock.Text>
              <MultiBinding StringFormat="Level {0}">
                <Binding Path="LevelUpNewLevel" />
              </MultiBinding>
            </TextBlock.Text>
          </TextBlock>
          <TextBlock Text="{Binding LevelUpUnlockedText}"
                     FontSize="14" TextWrapping="Wrap"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     IsVisible="{Binding LevelUpUnlockedText, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
          <Button Classes="Primary" Content="OK"
                  Background="{StaticResource CraftPrimaryBrush}"
                  Command="{Binding DismissLevelUpDialogCommand}"
                  HorizontalAlignment="Center" MinWidth="140" />
        </StackPanel>
      </Border>
    </Border>

    <!-- Daily Reward Dialog -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            IsVisible="{Binding IsDailyRewardDialogVisible}">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16" Padding="24"
              MaxWidth="360"
              HorizontalAlignment="Center" VerticalAlignment="Center"
              BoxShadow="0 0 30 0 #40D97706">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <!-- Gift-Icon mit CraftPrimary-Glow -->
          <Border Width="72" Height="72" CornerRadius="36"
                  HorizontalAlignment="Center"
                  BoxShadow="0 0 20 0 #40D97706">
            <Border.Background>
              <RadialGradientBrush Center="0.5,0.5" RadiusX="0.5" RadiusY="0.5">
                <GradientStop Color="#40D97706" Offset="0" />
                <GradientStop Color="Transparent" Offset="1" />
              </RadialGradientBrush>
            </Border.Background>
            <mi:MaterialIcon Kind="Gift" Width="40" Height="40"
                             Foreground="#D97706"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
          </Border>
          <TextBlock Text="{loc:Translate DailyReward}"
                     FontSize="22" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="{StaticResource CraftPrimaryLightBrush}" />
          <!-- 7-Tage Streak Dots -->
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
            <Border Width="12" Height="12" CornerRadius="6"
                    Background="{StaticResource CraftPrimaryBrush}"
                    BorderBrush="{StaticResource CraftPrimaryBrush}" BorderThickness="2" />
            <Border Width="12" Height="12" CornerRadius="6"
                    BorderBrush="{StaticResource CraftPrimaryBrush}" BorderThickness="2" />
            <Border Width="12" Height="12" CornerRadius="6"
                    BorderBrush="{StaticResource CraftGoldBrush}" BorderThickness="2" />
            <Border Width="12" Height="12" CornerRadius="6"
                    BorderBrush="{StaticResource CraftPrimaryBrush}" BorderThickness="2" />
            <Border Width="12" Height="12" CornerRadius="6"
                    BorderBrush="{StaticResource CraftGoldBrush}" BorderThickness="2" />
            <Border Width="12" Height="12" CornerRadius="6"
                    BorderBrush="{StaticResource CraftPrimaryBrush}" BorderThickness="2" />
            <Border Width="12" Height="12" CornerRadius="6"
                    BorderBrush="{StaticResource CraftGoldBrush}" BorderThickness="2" />
          </StackPanel>
          <TextBlock Text="{Binding DailyRewardDayText}"
                     FontSize="16"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextPrimaryBrush}" />
          <TextBlock Text="{Binding DailyRewardAmountText}"
                     FontSize="28" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="{StaticResource CraftPrimaryLightBrush}" />
          <TextBlock Text="{Binding DailyRewardStreakText}"
                     FontSize="12"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <Button Classes="Primary" Content="{loc:Translate ClaimReward}"
                  Background="{StaticResource CraftPrimaryBrush}"
                  Command="{Binding ClaimDailyRewardCommand}"
                  HorizontalAlignment="Center" MinWidth="160" />
        </StackPanel>
      </Border>
    </Border>

    <!-- Achievement Unlocked Dialog -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            IsVisible="{Binding IsAchievementDialogVisible}">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16" Padding="24"
              MaxWidth="360"
              HorizontalAlignment="Center" VerticalAlignment="Center"
              BoxShadow="0 0 40 0 #40FFD700">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <!-- Trophy mit Gold-Glow -->
          <Border Width="72" Height="72" CornerRadius="36"
                  HorizontalAlignment="Center"
                  BoxShadow="0 0 24 0 #60FFD700">
            <Border.Background>
              <RadialGradientBrush Center="0.5,0.5" RadiusX="0.5" RadiusY="0.5">
                <GradientStop Color="#40FFD700" Offset="0" />
                <GradientStop Color="Transparent" Offset="1" />
              </RadialGradientBrush>
            </Border.Background>
            <mi:MaterialIcon Kind="Trophy" Width="40" Height="40"
                             Foreground="#FFD700"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
          </Border>
          <TextBlock Text="{loc:Translate AchievementUnlocked}"
                     FontSize="22" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="#FFD700" />
          <TextBlock Text="{Binding AchievementName}"
                     FontSize="18" FontWeight="SemiBold"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextPrimaryBrush}" />
          <TextBlock Text="{Binding AchievementDescription}"
                     FontSize="14" TextWrapping="Wrap"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <Button Classes="Primary" Content="OK"
                  Background="{StaticResource CraftPrimaryBrush}"
                  Command="{Binding DismissAchievementDialogCommand}"
                  HorizontalAlignment="Center" MinWidth="120" />
        </StackPanel>
      </Border>
    </Border>

    <!-- ================================================================= -->
    <!-- STORY DIALOG (Meister Hans NPC)                                   -->
    <!-- ================================================================= -->
    <Border Grid.RowSpan="3"
            Classes="SheetBackdrop"
            Classes.Open="{Binding IsStoryDialogVisible}"
            IsVisible="{Binding IsStoryDialogVisible}"
            Background="#AA000000"
            IsHitTestVisible="{Binding IsStoryDialogVisible}">
      <Border Classes="BottomSheet"
              Classes.Open="{Binding IsStoryDialogVisible}"
              VerticalAlignment="Center" HorizontalAlignment="Center"
              MaxWidth="380"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="24"
              Padding="24"
              BoxShadow="0 0 40 0 #40D97706"
              Margin="20">
        <StackPanel Spacing="16">

          <!-- Meister Hans Portrait -->
          <Border Width="80" Height="80"
                  CornerRadius="40"
                  Background="#20D97706"
                  HorizontalAlignment="Center"
                  BoxShadow="0 0 20 0 #30D97706">
            <mi:MaterialIcon Kind="AccountHardHat" Width="48" Height="48"
                             Foreground="#D97706"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
          </Border>

          <!-- Kapitel-Titel -->
          <TextBlock Text="{Binding StoryTitle}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{StaticResource CraftPrimaryLightBrush}"
                     HorizontalAlignment="Center"
                     TextAlignment="Center" />

          <!-- Dialog-Text -->
          <TextBlock Text="{Binding StoryText}"
                     FontSize="14"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     TextWrapping="Wrap"
                     TextAlignment="Center"
                     LineHeight="22" />

          <!-- Belohnungen -->
          <Border Background="#15FFD700"
                  CornerRadius="12"
                  Padding="12,8"
                  IsVisible="{Binding StoryRewardText, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="Gift" Width="18" Height="18" Foreground="Gold" />
              <TextBlock Text="{Binding StoryRewardText}"
                         FontSize="13" FontWeight="SemiBold"
                         Foreground="Gold" />
            </StackPanel>
          </Border>

          <!-- Weiter-Button -->
          <Button Content="{loc:Translate Continue}"
                  Classes="Primary"
                  Command="{Binding DismissStoryDialogCommand}"
                  HorizontalAlignment="Center"
                  MinWidth="160"
                  Margin="0,8,0,0" />

        </StackPanel>
      </Border>
    </Border>

    <!-- Generic Alert Dialog -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            IsVisible="{Binding IsAlertDialogVisible}"
            PointerPressed="OnAlertOverlayPressed">
      <Border Background="{DynamicResource SurfaceBrush}"
              CornerRadius="16" Padding="24"
              MaxWidth="340" MaxHeight="300"
              HorizontalAlignment="Center" VerticalAlignment="Center"
              BoxShadow="0 8 24 0 #40000000"
              PointerPressed="OnDialogContentPressed">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
          <TextBlock Text="{Binding AlertDialogTitle}"
                     FontSize="20" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="{StaticResource CraftPrimaryLightBrush}" />
          <TextBlock Text="{Binding AlertDialogMessage}"
                     FontSize="14" TextWrapping="Wrap"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <Button Classes="Primary" Content="{Binding AlertDialogButtonText}"
                  Command="{Binding DismissAlertDialogCommand}"
                  HorizontalAlignment="Center" MinWidth="120" />
        </StackPanel>
      </Border>
    </Border>

    <!-- Generic Confirm Dialog (Bottom-Sheet Style) -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            Classes="SheetBackdrop"
            Classes.Open="{Binding IsConfirmDialogVisible}"
            PointerPressed="OnConfirmOverlayPressed">
      <Border Classes="ConfirmSheet"
              Classes.Open="{Binding IsConfirmDialogVisible}"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="20,20,0,0"
              Padding="24,12,24,24"
              VerticalAlignment="Bottom"
              BoxShadow="0 -4 16 0 #40000000"
              PointerPressed="OnDialogContentPressed">
        <StackPanel Spacing="16" HorizontalAlignment="Stretch">
          <!-- Drag Handle -->
          <Border Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  Opacity="0.4"
                  HorizontalAlignment="Center" Margin="0,0,0,4" />
          <TextBlock Text="{Binding ConfirmDialogTitle}"
                     FontSize="20" FontWeight="Bold"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource WarningBrush}" />
          <TextBlock Text="{Binding ConfirmDialogMessage}"
                     FontSize="14" TextWrapping="Wrap"
                     HorizontalAlignment="Center"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
          <StackPanel Spacing="8" HorizontalAlignment="Stretch">
            <Button Classes="Primary" Content="{Binding ConfirmDialogAcceptText}"
                    Command="{Binding ConfirmDialogAcceptCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center" />
            <Button Classes="Secondary" Content="{Binding ConfirmDialogCancelText}"
                    Command="{Binding ConfirmDialogCancelCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Worker Profile Bottom-Sheet -->
    <Border Grid.RowSpan="3" Background="#AA000000"
            Classes="SheetBackdrop"
            Classes.Open="{Binding IsWorkerProfileActive}"
            PointerPressed="OnWorkerProfileBackdropPressed">
      <Border Classes="BottomSheet"
              Classes.Open="{Binding IsWorkerProfileActive}"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="20,20,0,0"
              VerticalAlignment="Bottom"
              MaxHeight="600"
              BoxShadow="0 -4 16 0 #40000000"
              PointerPressed="OnDialogContentPressed">
        <Grid RowDefinitions="Auto,*">
          <!-- Drag Handle -->
          <Border Grid.Row="0"
                  Width="40" Height="4" CornerRadius="2"
                  Background="{DynamicResource TextMutedBrush}"
                  Opacity="0.4"
                  HorizontalAlignment="Center" Margin="0,10,0,6" />
          <!-- Worker Profile Content -->
          <views:WorkerProfileView Grid.Row="1"
                                   DataContext="{Binding WorkerProfileViewModel}" />
        </Grid>
      </Border>
    </Border>

    <!-- Confetti-Overlay (Level-Up, Achievement-Unlock) -->
    <controls:SkiaCelebrationOverlay x:Name="CelebrationCanvas"
                                     Grid.RowSpan="3"
                                     ZIndex="100"
                                     IsHitTestVisible="False" />

    <!-- Loading Overlay -->
    <Border Grid.RowSpan="3"
            Background="#CC000000"
            IsVisible="{Binding IsLoading}">
      <ProgressBar IsIndeterminate="True"
                   Width="48" Height="48"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center" />
    </Border>

  </Grid>

</UserControl>
