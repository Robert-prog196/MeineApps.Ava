<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.ResearchView"
             x:DataType="vm:ResearchViewModel">

  <Grid RowDefinitions="Auto,Auto,*">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Padding="16,12"
            CornerRadius="0,0,12,12">
      <Border.Background>
        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
          <GradientStop Color="#92400E" Offset="0" />
          <GradientStop Color="#451A03" Offset="1" />
        </LinearGradientBrush>
      </Border.Background>
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Back Button -->
        <Button Classes="Text"
                Command="{Binding GoBackCommand}">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24"
                           Foreground="{StaticResource CraftPrimaryLightBrush}" />
        </Button>

        <!-- Title (centered) -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="8">
          <mi:MaterialIcon Kind="FlaskOutline" Width="28" Height="28"
                           Foreground="{StaticResource CraftPrimaryLightBrush}" />
          <TextBlock Text="{Binding Title}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{StaticResource CraftPrimaryLightBrush}" />
        </StackPanel>

        <!-- Balance Badges -->
        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8"
                    VerticalAlignment="Center">
          <!-- Goldschrauben-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <mi:MaterialIcon Kind="ScrewFlatTop" Width="16" Height="16" Foreground="#FFD700" />
              <TextBlock Text="{Binding GoldenScrewsDisplay}" FontSize="14" FontWeight="Bold"
                         Foreground="#FFD700" />
            </StackPanel>
          </Border>
          <!-- Euro-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4">
            <TextBlock Text="{Binding CurrentBalance}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="{DynamicResource SuccessBrush}" />
          </Border>
        </StackPanel>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- ACTIVE RESEARCH BANNER                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="1"
            Classes="CardElevated"
            Margin="16,12,16,0"
            Padding="16"
            IsVisible="{Binding HasActiveResearch}">
      <StackPanel Spacing="8">
        <Grid ColumnDefinitions="*,Auto">
          <StackPanel Spacing="2">
            <TextBlock Text="{loc:Translate CurrentResearch}"
                       FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}" />
            <TextBlock Text="{Binding ActiveResearchName}"
                       FontSize="16" FontWeight="Bold"
                       Foreground="{StaticResource CraftPrimaryLightBrush}" />
          </StackPanel>
          <Button Grid.Column="1"
                  Classes="Text"
                  Command="{Binding CancelResearchCommand}"
                  VerticalAlignment="Center"
                  Padding="8">
            <mi:MaterialIcon Kind="Close" Width="20" Height="20"
                             Foreground="{DynamicResource ErrorBrush}" />
          </Button>
        </Grid>
        <ProgressBar Value="{Binding ActiveResearchProgress}"
                     Maximum="1"
                     Foreground="{StaticResource CraftPrimaryLightBrush}"
                     Background="{DynamicResource SurfaceBrush}"
                     Height="6" />
        <Grid ColumnDefinitions="*,Auto">
          <TextBlock Text="{Binding ActiveResearchTimeRemaining}"
                     FontSize="13" FontWeight="SemiBold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center"
                     VerticalAlignment="Center" />
          <!-- Sofort-Fertigstellen Button (ab Level 8) -->
          <Button Grid.Column="1"
                  Classes="Secondary"
                  Padding="10,6"
                  IsVisible="{Binding CanInstantFinish}"
                  Command="{Binding InstantFinishResearchCommand}">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <mi:MaterialIcon Kind="LightningBolt" Width="16" Height="16" />
              <mi:MaterialIcon Kind="ScrewFlatTop" Width="14" Height="14"
                               Foreground="#FFD700" />
              <TextBlock Text="{Binding InstantFinishCost}"
                         FontSize="12" FontWeight="SemiBold"
                         Foreground="#FFD700" />
            </StackPanel>
          </Button>
        </Grid>

        <!-- Gratis per Video-Ad fertigstellen -->
        <Button Classes="Secondary"
                Padding="10,6"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center"
                IsVisible="{Binding CanWatchAdToFinish}"
                Command="{Binding WatchAdToFinishResearchCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <mi:MaterialIcon Kind="Video" Width="18" Height="18"
                             Foreground="{StaticResource CraftPrimaryLightBrush}" />
            <TextBlock Text="{loc:Translate WatchAdToFinishResearch}"
                       FontSize="13" FontWeight="SemiBold" />
          </StackPanel>
        </Button>
      </StackPanel>
    </Border>

    <!-- ================================================================= -->
    <!-- RESEARCH TREE (vertical list, branch tabs)                        -->
    <!-- ================================================================= -->
    <Grid Grid.Row="2" RowDefinitions="Auto,*">

      <!-- Branch Tab Selector -->
      <Border Margin="16,12,16,0"
              Classes="CardElevated"
              Padding="4"
              CornerRadius="12">
        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="4">
          <!-- Tools Tab - Orange -->
          <Button HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="8,8"
                  CornerRadius="8"
                  Background="#EA580C"
                  Command="{Binding SelectToolsBranchCommand}"
                  Opacity="{Binding ToolsTabOpacity}">
            <StackPanel Orientation="Horizontal" Spacing="4"
                        HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="Hammer" Width="14" Height="14"
                               Foreground="White" />
              <TextBlock Text="{Binding ToolsBranchLabel}"
                         FontSize="12" FontWeight="SemiBold"
                         Foreground="White"
                         TextTrimming="CharacterEllipsis" />
            </StackPanel>
          </Button>
          <!-- Management Tab - Indigo -->
          <Button Grid.Column="1"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="8,8"
                  CornerRadius="8"
                  Background="{StaticResource BranchManagementBrush}"
                  Command="{Binding SelectManagementBranchCommand}"
                  Opacity="{Binding ManagementTabOpacity}">
            <StackPanel Orientation="Horizontal" Spacing="4"
                        HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="BriefcaseOutline" Width="14" Height="14"
                               Foreground="White" />
              <TextBlock Text="{Binding ManagementBranchLabel}"
                         FontSize="12" FontWeight="SemiBold"
                         Foreground="White"
                         TextTrimming="CharacterEllipsis" />
            </StackPanel>
          </Button>
          <!-- Marketing Tab - Gruen -->
          <Button Grid.Column="2"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="8,8"
                  CornerRadius="8"
                  Background="{StaticResource BranchMarketingBrush}"
                  Command="{Binding SelectMarketingBranchCommand}"
                  Opacity="{Binding MarketingTabOpacity}">
            <StackPanel Orientation="Horizontal" Spacing="4"
                        HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="Bullhorn" Width="14" Height="14"
                               Foreground="White" />
              <TextBlock Text="{Binding MarketingBranchLabel}"
                         FontSize="12" FontWeight="SemiBold"
                         Foreground="White"
                         TextTrimming="CharacterEllipsis" />
            </StackPanel>
          </Button>
        </Grid>
      </Border>

      <!-- Branch Description -->
      <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="8" Margin="16,12">

          <!-- Branch Description -->
          <TextBlock Text="{Binding SelectedBranchDescription}"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     TextWrapping="Wrap"
                     Margin="0,0,0,4" />

          <!-- Research Items -->
          <ItemsControl ItemsSource="{Binding SelectedBranch}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:ResearchDisplayItem">
                <Border Classes="Card"
                        Margin="0,0,0,6"
                        Padding="10"
                        Opacity="{Binding DisplayOpacity}">
                  <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                        ColumnDefinitions="Auto,*,Auto"
                        RowSpacing="4" ColumnSpacing="10">

                    <!-- Row 0: Level Badge + Name + Status Icon -->
                    <Border Background="{StaticResource CraftPrimaryBrush}"
                            CornerRadius="4"
                            Padding="6,2"
                            VerticalAlignment="Center">
                      <TextBlock Text="{Binding LevelDisplay}"
                                 FontSize="11" FontWeight="Bold"
                                 Foreground="White" />
                    </Border>

                    <TextBlock Grid.Column="1"
                               Text="{Binding Name}"
                               FontSize="14" FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               TextWrapping="Wrap"
                               VerticalAlignment="Center" />

                    <!-- Status Icon -->
                    <mi:MaterialIcon Grid.Column="2"
                                     Kind="CheckCircle" Width="20" Height="20"
                                     Foreground="{DynamicResource SuccessBrush}"
                                     IsVisible="{Binding IsResearched}"
                                     VerticalAlignment="Center" />
                    <mi:MaterialIcon Grid.Column="2"
                                     Kind="Lock" Width="20" Height="20"
                                     Foreground="{DynamicResource TextSecondaryBrush}"
                                     IsVisible="{Binding IsLocked}"
                                     VerticalAlignment="Center" />

                    <!-- Row 1: Description -->
                    <TextBlock Grid.Row="1" Grid.ColumnSpan="3"
                               Text="{Binding Description}"
                               FontSize="11"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               TextWrapping="Wrap" />

                    <!-- Row 2: Cost + Duration + Instant Finish (only when not researched) -->
                    <StackPanel Grid.Row="2" Grid.ColumnSpan="3"
                                Orientation="Horizontal" Spacing="16"
                                IsVisible="{Binding !IsResearched}">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="CurrencyEur" Width="14" Height="14"
                                         Foreground="{DynamicResource WarningBrush}" />
                        <TextBlock Text="{Binding CostDisplay}"
                                   FontSize="12" FontWeight="SemiBold"
                                   Foreground="{DynamicResource WarningBrush}"
                                   VerticalAlignment="Center" />
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="Clock" Width="14" Height="14"
                                         Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="{Binding DurationDisplay}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" />
                      </StackPanel>
                      <!-- Goldschrauben fuer Sofort-Finish (ab Level 8) -->
                      <StackPanel Orientation="Horizontal" Spacing="4"
                                  IsVisible="{Binding HasInstantFinishOption}">
                        <mi:MaterialIcon Kind="ScrewFlatTop" Width="14" Height="14"
                                         Foreground="#FFD700" />
                        <TextBlock Text="{Binding InstantFinishScrewCost}"
                                   FontSize="12" FontWeight="SemiBold"
                                   Foreground="#FFD700"
                                   VerticalAlignment="Center" />
                      </StackPanel>
                    </StackPanel>

                    <!-- Row 3: Active Progress Bar -->
                    <StackPanel Grid.Row="3" Grid.ColumnSpan="3"
                                IsVisible="{Binding IsActive}" Spacing="4">
                      <ProgressBar Value="{Binding Progress}"
                                   Maximum="1"
                                   Foreground="{StaticResource CraftPrimaryLightBrush}"
                                   Background="{DynamicResource SurfaceBrush}"
                                   Height="6" />
                    </StackPanel>

                    <!-- Row 4: Start Button -->
                    <Button Grid.Row="4" Grid.ColumnSpan="3"
                            Classes="Primary"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            Padding="8,8"
                            IsVisible="{Binding CanStart}"
                            Command="{Binding $parent[ItemsControl].((vm:ResearchViewModel)DataContext).StartResearchCommand}"
                            CommandParameter="{Binding Id}">
                      <StackPanel Orientation="Horizontal" Spacing="6"
                                  HorizontalAlignment="Center">
                        <mi:MaterialIcon Kind="FlaskOutline" Width="16" Height="16" />
                        <TextBlock Text="{loc:Translate StartResearch}"
                                   FontSize="13" FontWeight="SemiBold" />
                      </StackPanel>
                    </Button>

                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Bottom Spacer -->
          <Border Height="60" />

        </StackPanel>
      </ScrollViewer>

    </Grid>

  </Grid>

</UserControl>
