<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.ResearchView"
             x:DataType="vm:ResearchViewModel">

  <Grid RowDefinitions="Auto,Auto,*">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Classes="CardElevated"
            Padding="16,12"
            CornerRadius="0,0,12,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Back Button -->
        <Button Classes="Text"
                Command="{Binding GoBackCommand}">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24" />
        </Button>

        <!-- Title (centered) -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Spacing="8">
          <mi:MaterialIcon Kind="FlaskOutline" Width="28" Height="28"
                           Foreground="{DynamicResource TextPrimaryBrush}" />
          <TextBlock Text="{Binding Title}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}" />
        </StackPanel>

        <!-- Balance -->
        <Border Grid.Column="2"
                Background="{DynamicResource SurfaceBrush}"
                CornerRadius="16"
                Padding="12,6">
          <TextBlock Text="{Binding CurrentBalance}"
                     FontSize="14" FontWeight="Bold"
                     Foreground="{DynamicResource SuccessBrush}" />
        </Border>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- ACTIVE RESEARCH BANNER                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="1"
            Classes="CardElevated"
            Margin="16,12,16,0"
            Padding="16"
            IsVisible="{Binding HasActiveResearch}">
      <StackPanel Spacing="8">
        <Grid ColumnDefinitions="*,Auto">
          <StackPanel Spacing="2">
            <TextBlock Text="{loc:Translate CurrentResearch}"
                       FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}" />
            <TextBlock Text="{Binding ActiveResearchName}"
                       FontSize="16" FontWeight="Bold"
                       Foreground="{DynamicResource PrimaryBrush}" />
          </StackPanel>
          <Button Grid.Column="1"
                  Classes="Text"
                  Command="{Binding CancelResearchCommand}"
                  VerticalAlignment="Center"
                  Padding="8">
            <mi:MaterialIcon Kind="Close" Width="20" Height="20"
                             Foreground="{DynamicResource ErrorBrush}" />
          </Button>
        </Grid>
        <ProgressBar Value="{Binding ActiveResearchProgress}"
                     Maximum="1"
                     Foreground="{DynamicResource PrimaryBrush}"
                     Height="6" />
        <TextBlock Text="{Binding ActiveResearchTimeRemaining}"
                   FontSize="13" FontWeight="SemiBold"
                   Foreground="{DynamicResource TextPrimaryBrush}"
                   HorizontalAlignment="Center" />
      </StackPanel>
    </Border>

    <!-- ================================================================= -->
    <!-- RESEARCH TREE (vertical list, branch tabs)                        -->
    <!-- ================================================================= -->
    <Grid Grid.Row="2" RowDefinitions="Auto,*">

      <!-- Branch Tab Selector -->
      <Border Margin="16,12,16,0"
              Classes="CardElevated"
              Padding="4"
              CornerRadius="12">
        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="4">
          <Button Classes="Primary"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="8,6"
                  Command="{Binding SelectToolsBranchCommand}"
                  Opacity="{Binding ToolsTabOpacity}">
            <TextBlock Text="{Binding ToolsBranchLabel}"
                       FontSize="12" FontWeight="SemiBold"
                       TextTrimming="CharacterEllipsis" />
          </Button>
          <Button Grid.Column="1"
                  Classes="Primary"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="8,6"
                  Command="{Binding SelectManagementBranchCommand}"
                  Opacity="{Binding ManagementTabOpacity}">
            <TextBlock Text="{Binding ManagementBranchLabel}"
                       FontSize="12" FontWeight="SemiBold"
                       TextTrimming="CharacterEllipsis" />
          </Button>
          <Button Grid.Column="2"
                  Classes="Primary"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Padding="8,6"
                  Command="{Binding SelectMarketingBranchCommand}"
                  Opacity="{Binding MarketingTabOpacity}">
            <TextBlock Text="{Binding MarketingBranchLabel}"
                       FontSize="12" FontWeight="SemiBold"
                       TextTrimming="CharacterEllipsis" />
          </Button>
        </Grid>
      </Border>

      <!-- Branch Description -->
      <ScrollViewer Grid.Row="1" Padding="16,12">
        <StackPanel Spacing="8">

          <!-- Branch Description -->
          <TextBlock Text="{Binding SelectedBranchDescription}"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     TextWrapping="Wrap"
                     Margin="0,0,0,4" />

          <!-- Research Items -->
          <ItemsControl ItemsSource="{Binding SelectedBranch}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:ResearchDisplayItem">
                <Border Classes="Card"
                        Margin="0,0,0,8"
                        Padding="12"
                        Opacity="{Binding DisplayOpacity}">
                  <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                        ColumnDefinitions="Auto,*,Auto"
                        RowSpacing="6" ColumnSpacing="10">

                    <!-- Row 0: Level Badge + Name + Status Icon -->
                    <Border Background="{DynamicResource PrimaryBrush}"
                            CornerRadius="4"
                            Padding="6,2"
                            VerticalAlignment="Center">
                      <TextBlock Text="{Binding LevelDisplay}"
                                 FontSize="11" FontWeight="Bold"
                                 Foreground="White" />
                    </Border>

                    <TextBlock Grid.Column="1"
                               Text="{Binding Name}"
                               FontSize="14" FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               TextWrapping="Wrap"
                               VerticalAlignment="Center" />

                    <!-- Status Icon -->
                    <mi:MaterialIcon Grid.Column="2"
                                     Kind="CheckCircle" Width="20" Height="20"
                                     Foreground="{DynamicResource SuccessBrush}"
                                     IsVisible="{Binding IsResearched}"
                                     VerticalAlignment="Center" />
                    <mi:MaterialIcon Grid.Column="2"
                                     Kind="Lock" Width="20" Height="20"
                                     Foreground="{DynamicResource TextSecondaryBrush}"
                                     IsVisible="{Binding IsLocked}"
                                     VerticalAlignment="Center" />

                    <!-- Row 1: Description -->
                    <TextBlock Grid.Row="1" Grid.ColumnSpan="3"
                               Text="{Binding Description}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               TextWrapping="Wrap" />

                    <!-- Row 2: Cost + Duration (only when not researched) -->
                    <StackPanel Grid.Row="2" Grid.ColumnSpan="3"
                                Orientation="Horizontal" Spacing="16"
                                IsVisible="{Binding !IsResearched}">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="CurrencyEur" Width="14" Height="14"
                                         Foreground="{DynamicResource WarningBrush}" />
                        <TextBlock Text="{Binding CostDisplay}"
                                   FontSize="12" FontWeight="SemiBold"
                                   Foreground="{DynamicResource WarningBrush}"
                                   VerticalAlignment="Center" />
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="Clock" Width="14" Height="14"
                                         Foreground="{DynamicResource TextSecondaryBrush}" />
                        <TextBlock Text="{Binding DurationDisplay}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" />
                      </StackPanel>
                    </StackPanel>

                    <!-- Row 3: Active Progress Bar -->
                    <StackPanel Grid.Row="3" Grid.ColumnSpan="3"
                                IsVisible="{Binding IsActive}" Spacing="4">
                      <ProgressBar Value="{Binding Progress}"
                                   Maximum="1"
                                   Foreground="{DynamicResource PrimaryBrush}"
                                   Height="6" />
                    </StackPanel>

                    <!-- Row 4: Start Button -->
                    <Button Grid.Row="4" Grid.ColumnSpan="3"
                            Classes="Primary"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            Padding="8,8"
                            IsVisible="{Binding CanStart}"
                            Command="{Binding $parent[ItemsControl].((vm:ResearchViewModel)DataContext).StartResearchCommand}"
                            CommandParameter="{Binding Id}">
                      <StackPanel Orientation="Horizontal" Spacing="6"
                                  HorizontalAlignment="Center">
                        <mi:MaterialIcon Kind="FlaskOutline" Width="16" Height="16" />
                        <TextBlock Text="{loc:Translate StartResearch}"
                                   FontSize="13" FontWeight="SemiBold" />
                      </StackPanel>
                    </Button>

                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Bottom Spacer -->
          <Border Height="20" />

        </StackPanel>
      </ScrollViewer>

    </Grid>

  </Grid>

</UserControl>
