<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.MiniGames.SawingGameView"
             x:DataType="vm:SawingGameViewModel">

  <Grid RowDefinitions="Auto,*,Auto" Margin="20">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Classes="CardElevated"
            Padding="16,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Cancel Button -->
        <Button Classes="Text"
                Command="{Binding CancelCommand}">
          <mi:MaterialIcon Kind="Close" Width="24" Height="24" />
        </Button>

        <!-- Title -->
        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
          <TextBlock Text="{Binding GameTitle}"
                     FontSize="18" FontWeight="Bold"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />
          <TextBlock Text="{Binding DifficultyStars}"
                     HorizontalAlignment="Center"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
        </StackPanel>

        <!-- Difficulty -->
        <TextBlock Grid.Column="2"
                   Text="{Binding Difficulty}"
                   FontSize="12"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   VerticalAlignment="Center" />
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- GAME AREA                                                         -->
    <!-- ================================================================= -->
    <Grid Grid.Row="1" VerticalAlignment="Center" Margin="0,40">
      <StackPanel Spacing="40">

        <!-- Wood Board Visualization -->
        <Border Background="#8B5A2B"
                CornerRadius="8"
                Height="80"
                Padding="0">
          <Panel>
            <!-- Wood grain pattern -->
            <Border Background="#A67C52" Height="4"
                    VerticalAlignment="Top" Margin="0,15,0,0" />
            <Border Background="#A67C52" Height="3"
                    VerticalAlignment="Center" Margin="0,10,0,0" />
            <Border Background="#A67C52" Height="4"
                    VerticalAlignment="Bottom" Margin="0,0,0,15" />

            <!-- Cut line -->
            <Border Background="#40000000" Width="3"
                    HorizontalAlignment="Center" />

            <!-- Tool icon -->
            <TextBlock Text="{Binding GameIcon}"
                       FontSize="32"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Bottom"
                       Margin="0,0,0,-25" />
          </Panel>
        </Border>

        <!-- Timing Bar -->
        <StackPanel Spacing="8">
          <TextBlock Text="{Binding InstructionText}"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     HorizontalAlignment="Center" />

          <!-- Timing Bar Container -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="8"
                  Height="50"
                  ClipToBounds="True">
            <Panel>
              <!-- Miss Zone (full bar) -->
              <Border Background="{DynamicResource ErrorBrush}"
                      Opacity="0.3"
                      CornerRadius="4" />

              <!-- OK Zone -->
              <Border Background="{DynamicResource WarningBrush}"
                      Opacity="0.5"
                      CornerRadius="4"
                      HorizontalAlignment="Left"
                      Width="{Binding OkZonePixelWidth}"
                      Margin="{Binding OkZoneMargin}" />

              <!-- Good Zone -->
              <Border Background="{StaticResource CraftPrimaryBrush}"
                      Opacity="0.6"
                      CornerRadius="4"
                      HorizontalAlignment="Left"
                      Width="{Binding GoodZonePixelWidth}"
                      Margin="{Binding GoodZoneMargin}" />

              <!-- Perfect Zone -->
              <Border Background="{DynamicResource SuccessBrush}"
                      CornerRadius="4"
                      HorizontalAlignment="Left"
                      Width="{Binding PerfectZonePixelWidth}"
                      Margin="{Binding PerfectZoneMargin}" />

              <!-- Marker -->
              <Border Background="White"
                      Width="6"
                      CornerRadius="3"
                      HorizontalAlignment="Left"
                      Margin="{Binding MarkerMargin}" />
            </Panel>
          </Border>
        </StackPanel>

        <!-- Result Display (shown after action) -->
        <Border Classes="Card"
                IsVisible="{Binding IsResultShown}"
                Padding="24">
          <StackPanel Spacing="16" HorizontalAlignment="Center">
            <!-- Stars -->
            <TextBlock Text="{Binding ResultEmoji}"
                       FontSize="48"
                       HorizontalAlignment="Center" />

            <!-- Sterne-Bewertung (staggered) -->
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                               Foreground="#FFD700"
                               Opacity="{Binding Star1Opacity}" />
              <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                               Foreground="#FFD700"
                               Opacity="{Binding Star2Opacity}" />
              <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                               Foreground="#FFD700"
                               Opacity="{Binding Star3Opacity}" />
            </StackPanel>

            <!-- Rating Text -->
            <TextBlock Text="{Binding ResultText}"
                       FontSize="24" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />

            <!-- Rewards -->
            <StackPanel Orientation="Horizontal" Spacing="20"
                        HorizontalAlignment="Center">
              <StackPanel Orientation="Horizontal" Spacing="4">
                <mi:MaterialIcon Kind="CashMultiple" Width="20" Height="20"
                                 Foreground="{DynamicResource SuccessBrush}" />
                <TextBlock Text="{Binding RewardAmount, StringFormat='+{0:N0} €'}"
                           FontSize="14" FontWeight="Bold"
                           Foreground="{DynamicResource SuccessBrush}"
                           VerticalAlignment="Center" />
              </StackPanel>

              <StackPanel Orientation="Horizontal" Spacing="4">
                <mi:MaterialIcon Kind="Star" Width="20" Height="20"
                                 Foreground="Gold" />
                <TextBlock Text="{Binding XpAmount, StringFormat='+{0} XP'}"
                           FontSize="14" FontWeight="Bold"
                           Foreground="Gold"
                           VerticalAlignment="Center" />
              </StackPanel>
            </StackPanel>
          </StackPanel>
        </Border>

      </StackPanel>
    </Grid>

    <!-- Countdown Overlay -->
    <Border Grid.RowSpan="3" Background="#CC000000"
            IsVisible="{Binding IsCountdownActive}">
      <TextBlock Text="{Binding CountdownText}"
                 FontSize="72" FontWeight="Bold"
                 Foreground="#FFD700"
                 HorizontalAlignment="Center" VerticalAlignment="Center" />
    </Border>

    <!-- ================================================================= -->
    <!-- ACTION BUTTONS                                                    -->
    <!-- ================================================================= -->
    <StackPanel Grid.Row="2" Spacing="16">

      <!-- Start Button (versteckt während Spiel und nach Ergebnis) -->
      <Panel IsVisible="{Binding !IsResultShown}">
        <Button Content="{loc:Translate Start}"
                Classes="Primary"
                Command="{Binding StartGameCommand}"
                IsVisible="{Binding !IsPlaying}"
                HorizontalAlignment="Center"
                MinWidth="200" />
      </Panel>

      <!-- Action Button (during game) -->
      <Button Content="{Binding ActionButtonText}"
              Classes="Primary"
              Command="{Binding StopMarkerCommand}"
              IsVisible="{Binding IsPlaying}"
              HorizontalAlignment="Center"
              MinWidth="250" />

      <!-- Continue Buttons (after result) -->
      <Grid ColumnDefinitions="*,*"
            ColumnSpacing="12"
            IsVisible="{Binding IsResultShown}">

        <!-- Watch Ad for 2x -->
        <Button Content="{loc:Translate WatchAdForDouble}"
                Classes="Secondary"
                IsEnabled="{Binding CanWatchAd}"
                Command="{Binding WatchAdCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center" />

        <!-- Continue -->
        <Button Grid.Column="1"
                Content="{loc:Translate Continue}"
                Classes="Primary"
                Command="{Binding ContinueCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center" />
      </Grid>

    </StackPanel>

  </Grid>

</UserControl>
