<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.MiniGames.WiringGameView"
             x:DataType="vm:WiringGameViewModel">

  <Grid RowDefinitions="Auto,*,Auto" Margin="20">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Classes="CardElevated"
            Padding="16,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Cancel Button -->
        <Button Classes="Text"
                Command="{Binding CancelCommand}">
          <mi:MaterialIcon Kind="Close" Width="24" Height="24" />
        </Button>

        <!-- Title -->
        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
          <StackPanel Orientation="Horizontal"
                      HorizontalAlignment="Center"
                      Spacing="6">
            <mi:MaterialIcon Kind="LightningBolt" Width="22" Height="22" />
            <TextBlock Text="{loc:Translate WiringGame}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />
          </StackPanel>
          <TextBlock Text="{Binding DifficultyStars}"
                     HorizontalAlignment="Center"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
        </StackPanel>

        <!-- Timer -->
        <Border Grid.Column="2"
                Background="{DynamicResource SurfaceBrush}"
                CornerRadius="8"
                Padding="12,6">
          <StackPanel Orientation="Horizontal" Spacing="4">
            <mi:MaterialIcon Kind="Clock" Width="16" Height="16" />
            <TextBlock Text="{Binding TimeRemaining, StringFormat='{}{0}s'}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />
          </StackPanel>
        </Border>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- GAME AREA                                                         -->
    <!-- ================================================================= -->
    <Grid Grid.Row="1" VerticalAlignment="Center" Margin="0,20">
      <StackPanel Spacing="24">

        <!-- Instructions -->
        <TextBlock Text="{loc:Translate WiringInstructions}"
                   FontSize="12"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   HorizontalAlignment="Center"
                   IsVisible="{Binding !IsPlaying}" />

        <TextBlock Text="{loc:Translate SelectLeftThenRight}"
                   FontSize="12"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   HorizontalAlignment="Center"
                   IsVisible="{Binding IsPlaying}" />

        <!-- Progress -->
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Spacing="24"
                    IsVisible="{Binding IsPlaying}">
          <StackPanel Orientation="Horizontal" Spacing="4">
            <mi:MaterialIcon Kind="Check" Width="16" Height="16"
                             Foreground="{DynamicResource SuccessBrush}" />
            <TextBlock FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}">
              <Run Text="{loc:Translate ConnectedLabel}" />
              <Run Text=" " />
              <Run Text="{Binding ConnectedCount}" />
            </TextBlock>
          </StackPanel>
        </StackPanel>

        <!-- Wiring Panel -->
        <Border Classes="Card" Padding="20"
                HorizontalAlignment="Center">
          <Grid ColumnDefinitions="100,60,100" ColumnSpacing="20">

            <!-- Left Wires -->
            <StackPanel Spacing="12">
              <TextBlock Text="{loc:Translate Input}"
                         FontSize="12" FontWeight="Bold"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         HorizontalAlignment="Center" />
              <ItemsControl ItemsSource="{Binding LeftWires}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:Wire">
                    <Button Classes="Text" Padding="0" Margin="0,4"
                            Command="{Binding $parent[ItemsControl].((vm:WiringGameViewModel)DataContext).SelectLeftWireCommand}"
                            CommandParameter="{Binding .}">
                      <Border Height="50"
                              CornerRadius="8"
                              BorderThickness="{Binding BorderWidth}"
                              BorderBrush="{Binding ColorHex}"
                              Background="{Binding BackgroundColor}">
                        <Panel>
                          <StackPanel Orientation="Horizontal"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      Spacing="8"
                                      Opacity="{Binding ContentOpacity}">
                            <TextBlock Text="{Binding Emoji}"
                                       FontSize="24" />
                            <TextBlock Text="--"
                                       FontSize="20"
                                       Foreground="{Binding ColorHex}" />
                          </StackPanel>
                          <!-- Connected checkmark -->
                          <mi:MaterialIcon Kind="Check" Width="24" Height="24"
                                           Foreground="{DynamicResource SuccessBrush}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding IsConnected}" />
                        </Panel>
                      </Border>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>

            <!-- Center Connection Area -->
            <StackPanel Grid.Column="1"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="ChevronRight" Width="32" Height="32"
                               Foreground="{DynamicResource PrimaryBrush}" />
            </StackPanel>

            <!-- Right Wires -->
            <StackPanel Grid.Column="2" Spacing="12">
              <TextBlock Text="{loc:Translate Output}"
                         FontSize="12" FontWeight="Bold"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         HorizontalAlignment="Center" />
              <ItemsControl ItemsSource="{Binding RightWires}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:Wire">
                    <Button Classes="Text" Padding="0" Margin="0,4"
                            Command="{Binding $parent[ItemsControl].((vm:WiringGameViewModel)DataContext).SelectRightWireCommand}"
                            CommandParameter="{Binding .}">
                      <Border Height="50"
                              CornerRadius="8"
                              BorderThickness="{Binding BorderWidth}"
                              BorderBrush="{Binding ColorHex}"
                              Background="{Binding BackgroundColor}">
                        <Panel>
                          <StackPanel Orientation="Horizontal"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      Spacing="8"
                                      Opacity="{Binding ContentOpacity}">
                            <TextBlock Text="--"
                                       FontSize="20"
                                       Foreground="{Binding ColorHex}" />
                            <TextBlock Text="{Binding Emoji}"
                                       FontSize="24" />
                          </StackPanel>
                          <!-- Connected checkmark -->
                          <mi:MaterialIcon Kind="Check" Width="24" Height="24"
                                           Foreground="{DynamicResource SuccessBrush}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding IsConnected}" />
                        </Panel>
                      </Border>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>

          </Grid>
        </Border>

        <!-- Result Display -->
        <Border Classes="Card"
                IsVisible="{Binding IsResultShown}"
                Padding="24">
          <StackPanel Spacing="16" HorizontalAlignment="Center">
            <TextBlock Text="{Binding ResultEmoji}"
                       FontSize="48"
                       HorizontalAlignment="Center" />

            <TextBlock Text="{Binding ResultText}"
                       FontSize="24" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />

            <!-- Rewards -->
            <StackPanel Orientation="Horizontal" Spacing="20"
                        HorizontalAlignment="Center">
              <StackPanel Orientation="Horizontal" Spacing="4">
                <mi:MaterialIcon Kind="CashMultiple" Width="20" Height="20"
                                 Foreground="{DynamicResource SuccessBrush}" />
                <TextBlock Text="{Binding RewardAmount, StringFormat='+{0:N0} â‚¬'}"
                           FontSize="14" FontWeight="Bold"
                           Foreground="{DynamicResource SuccessBrush}"
                           VerticalAlignment="Center" />
              </StackPanel>

              <StackPanel Orientation="Horizontal" Spacing="4">
                <mi:MaterialIcon Kind="Star" Width="20" Height="20"
                                 Foreground="Gold" />
                <TextBlock Text="{Binding XpAmount, StringFormat='+{0} XP'}"
                           FontSize="14" FontWeight="Bold"
                           Foreground="Gold"
                           VerticalAlignment="Center" />
              </StackPanel>
            </StackPanel>
          </StackPanel>
        </Border>

      </StackPanel>
    </Grid>

    <!-- ================================================================= -->
    <!-- ACTION BUTTONS                                                    -->
    <!-- ================================================================= -->
    <StackPanel Grid.Row="2" Spacing="16">

      <!-- Start Button -->
      <Button Content="{loc:Translate StartGame}"
              Classes="Primary"
              Command="{Binding StartGameCommand}"
              IsVisible="{Binding !IsPlaying}"
              IsEnabled="{Binding !IsResultShown}"
              HorizontalAlignment="Center"
              MinWidth="220" />

      <!-- Continue Buttons -->
      <Grid ColumnDefinitions="*,*"
            ColumnSpacing="12"
            IsVisible="{Binding IsResultShown}">

        <Button Content="{loc:Translate WatchAdForDouble}"
                Classes="Secondary"
                IsEnabled="{Binding CanWatchAd}"
                Command="{Binding WatchAdCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center" />

        <Button Grid.Column="1"
                Content="{loc:Translate Continue}"
                Classes="Primary"
                Command="{Binding ContinueCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center" />
      </Grid>

    </StackPanel>

  </Grid>

</UserControl>
